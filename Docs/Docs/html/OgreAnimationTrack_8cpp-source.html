<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreAnimationTrack.cpp</h1><a href="OgreAnimationTrack_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2002 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreAnimationTrack_8h.html">OgreAnimationTrack.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreAnimation_8h.html">OgreAnimation.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreKeyFrame_8h.html">OgreKeyFrame.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreNode_8h.html">OgreNode.h</a>"</font>
00029 
00030 <font class="keyword">namespace </font>Ogre {
00031 
00032     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00033"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka0">00033</a>     AnimationTrack::AnimationTrack(<a class="code" href="classOgre_1_1Animation.html">Animation</a>* parent) : mParent(parent)
00034     {
00035         <font class="comment">// Create first keyframe</font>
00036         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka6">createKeyFrame</a>(0.0);
00037         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn3">mTargetNode</a> = 0;
00038     }
00039     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00040"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka1">00040</a>     AnimationTrack::AnimationTrack(<a class="code" href="classOgre_1_1Animation.html">Animation</a>* parent, <a class="code" href="classOgre_1_1Node.html">Node</a>* targetNode) 
00041         : mTargetNode(targetNode)
00042     {
00043         <font class="comment">// Create first keyframe</font>
00044         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka6">createKeyFrame</a>(0.0);
00045     }
00046     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00047"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka2">00047</a>     AnimationTrack::~AnimationTrack()
00048     {
00049         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka8">removeAllKeyFrames</a>();
00050     }
00051     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00052"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka3">00052</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> AnimationTrack::getNumKeyFrames(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00053 <font class="keyword">    </font>{
00054         <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>)<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.size();
00055     }
00056     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00057"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka4">00057</a>     <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>* AnimationTrack::getKeyFrame(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> index)<font class="keyword"> const</font>
00058 <font class="keyword">    </font>{
00059         assert (index &gt;= 0 &amp;&amp; index &lt; <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.size() &amp;&amp; 
00060             <font class="stringliteral">"KeyFrame index out of bounds"</font>);
00061         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>[index];
00062     }
00063     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00064"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka5">00064</a>     <a class="code" href="namespaceOgre.html#a281">Real</a> AnimationTrack::getKeyFramesAtTime(<a class="code" href="namespaceOgre.html#a281">Real</a> timePos, <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>** keyFrame1, <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>** keyFrame2)<font class="keyword"> const</font>
00065 <font class="keyword">    </font>{
00066         <a class="code" href="namespaceOgre.html#a281">Real</a> totalAnimationLength = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn2">mParent</a>-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa3">getLength</a>();
00067 
00068         <font class="comment">// Wrap time </font>
00069         <font class="keywordflow">while</font> (timePos &gt;= totalAnimationLength)
00070         {
00071             timePos -= totalAnimationLength;
00072         }
00073 
00074         KeyFrameList::const_iterator i = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.begin();
00075         <font class="keywordflow">while</font> ((*i)-&gt;getTime() &gt; timePos)
00076         {
00077             ++i;
00078         }
00079 
00080         <font class="comment">// Parametric time</font>
00081         <a class="code" href="namespaceOgre.html#a281">Real</a> t1, t2;
00082         <font class="comment">// Get first and increment to next</font>
00083         *keyFrame1 = *i++;
00084         <font class="comment">// If no next keyframe, wrap back to first</font>
00085         <font class="keywordflow">if</font> (i == <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.end())
00086         {
00087             *keyFrame2 = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>[0];
00088             t2 = totalAnimationLength;
00089         }
00090         <font class="keywordflow">else</font>
00091         {
00092             *keyFrame2 = *i;
00093             t2 = (*keyFrame2)-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea2">getTime</a>();
00094         }
00095 
00096         t1 = (*keyFrame1)-&gt;getTime();
00097 
00098         <font class="keywordflow">if</font> (t1 == t2)
00099         {
00100             <font class="comment">// Same KeyFrame (only one)</font>
00101             <font class="keywordflow">return</font> 0.0;
00102         }
00103         <font class="keywordflow">else</font>
00104         {
00105             <font class="keywordflow">return</font> (timePos - t1) / (t2 - t1);
00106         }
00107     }
00108     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00109"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka6">00109</a>     <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>* AnimationTrack::createKeyFrame(<a class="code" href="namespaceOgre.html#a281">Real</a> timePos)
00110     {
00111         <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>* kf = <font class="keyword">new</font> <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>(timePos);
00112 
00113         <font class="comment">// Insert at correct location</font>
00114         <font class="keywordflow">if</font> (timePos &gt; <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn1">mMaxKeyFrameTime</a> || (timePos == 0 &amp;&amp; <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.empty()))
00115         {
00116             <font class="comment">// Quick insert at end</font>
00117             <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.push_back(kf);
00118             <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn1">mMaxKeyFrameTime</a> = timePos;
00119         }
00120         <font class="keywordflow">else</font>
00121         {
00122             <font class="comment">// Search </font>
00123             KeyFrameList::iterator i = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.begin();
00124             <font class="keywordflow">while</font> ((*i)-&gt;getTime() &gt; timePos &amp;&amp; i != <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.end())
00125             {
00126                 ++i;
00127             }
00128             <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.insert(i, kf);
00129         }
00130 
00131         <font class="keywordflow">return</font> kf;
00132 
00133     }
00134     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00135"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka7">00135</a>     <font class="keywordtype">void</font> AnimationTrack::removeKeyFrame(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> index)
00136     {
00137         assert (index &gt;= 0 &amp;&amp; index &lt; <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.size() &amp;&amp; 
00138             <font class="stringliteral">"KeyFrame index out of bounds"</font>);
00139 
00140         KeyFrameList::iterator i = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.begin();
00141 
00142         i += index;
00143 
00144         <font class="keyword">delete</font> *i;
00145 
00146         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.erase(i);
00147 
00148     }
00149     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00150"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka8">00150</a>     <font class="keywordtype">void</font> AnimationTrack::removeAllKeyFrames(<font class="keywordtype">void</font>)
00151     {
00152         KeyFrameList::iterator i = <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.begin();
00153 
00154         <font class="keywordflow">for</font> (; i != <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.end(); ++i)
00155         {
00156             <font class="keyword">delete</font> *i;
00157         }
00158         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn0">mKeyFrames</a>.clear();
00159 
00160     }
00161     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00162"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka9">00162</a>     <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a> AnimationTrack::getInterpolatedKeyFrame(<a class="code" href="namespaceOgre.html#a281">Real</a> timeIndex)<font class="keyword"> const</font>
00163 <font class="keyword">    </font>{
00164         <font class="comment">// Return value</font>
00165         <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a> kret(timeIndex);
00166         
00167         <font class="comment">// Keyframe pointers</font>
00168         <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a> *k1, *k2;
00169 
00170         <a class="code" href="namespaceOgre.html#a281">Real</a> t = this-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka5">getKeyFramesAtTime</a>(timeIndex, &amp;k1, &amp;k2);
00171 
00172         <font class="keywordflow">if</font> (t == 0.0)
00173         {
00174             <font class="comment">// Just use k1</font>
00175             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea7">setRotation</a>(k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea8">getRotation</a>());
00176             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea3">setTranslate</a>(k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea4">getTranslate</a>());
00177             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea5">setScale</a>(k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea6">getScale</a>());
00178         }
00179         <font class="keywordflow">else</font>
00180         {
00181             <font class="comment">// Interpolate by t</font>
00182 
00183             <font class="comment">// Rotation</font>
00184             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea7">setRotation</a>( Quaternion::Slerp(t, k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea8">getRotation</a>(), k2-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea8">getRotation</a>()) );
00185 
00186             <font class="comment">// Translation</font>
00187             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea3">setTranslate</a>( (k2-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea4">getTranslate</a>() - k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea4">getTranslate</a>()) * t );
00188 
00189             <font class="comment">// Scale</font>
00190             kret.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea5">setScale</a>( (k2-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea6">getScale</a>() - k1-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea6">getScale</a>()) * t );
00191 
00192         }
00193         
00194 
00195         <font class="keywordflow">return</font> kret;
00196         
00197     }
00198     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00199"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka10">00199</a>     <font class="keywordtype">void</font> AnimationTrack::apply(<a class="code" href="namespaceOgre.html#a281">Real</a> timePos, <a class="code" href="namespaceOgre.html#a281">Real</a> weight)
00200     {
00201         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka13">applyToNode</a>(<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn3">mTargetNode</a>, timePos, weight);
00202         
00203     }
00204     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00205"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka11">00205</a>     <a class="code" href="classOgre_1_1Node.html">Node</a>* AnimationTrack::getAssociatedNode(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00206 <font class="keyword">    </font>{
00207         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn3">mTargetNode</a>;
00208     }
00209     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00210"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka12">00210</a>     <font class="keywordtype">void</font> AnimationTrack::setAssociatedNode(<a class="code" href="classOgre_1_1Node.html">Node</a>* node)
00211     {
00212         <a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTrackn3">mTargetNode</a> = node;
00213     }
00214     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00215"></a><a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka13">00215</a>     <font class="keywordtype">void</font> AnimationTrack::applyToNode(<a class="code" href="classOgre_1_1Node.html">Node</a>* node, <a class="code" href="namespaceOgre.html#a281">Real</a> timePos, <a class="code" href="namespaceOgre.html#a281">Real</a> weight)
00216     {
00217         <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a> kf = this-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka9">getInterpolatedKeyFrame</a>(timePos);
00218 
00219         node-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea40">rotate</a>(kf.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea8">getRotation</a>() * weight);
00220         node-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea33">translate</a>(kf.<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea4">getTranslate</a>() * weight);
00221 
00222     }
00223 
00224 
00225 }
00226 
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
