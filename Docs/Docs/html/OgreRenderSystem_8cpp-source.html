<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreRenderSystem.cpp</h1><a href="OgreRenderSystem_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="comment">// RenderSystem implementation</font>
00026 <font class="comment">// Note that most of this class is abstract since</font>
00027 <font class="comment">//  we cannot know how to implement the behaviour without</font>
00028 <font class="comment">//  being aware of the 3D API. However there are a few</font>
00029 <font class="comment">//  simple functions which can have a base implementation</font>
00030 
00031 <font class="preprocessor">#include "<a class="code" href="OgreRenderSystem_8h.html">OgreRenderSystem.h</a>"</font>
00032 
00033 <font class="preprocessor">#include "<a class="code" href="OgreRoot_8h.html">OgreRoot.h</a>"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreViewport_8h.html">OgreViewport.h</a>"</font>
00035 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00036 <font class="preprocessor">#include "<a class="code" href="OgreRenderWindow_8h.html">OgreRenderWindow.h</a>"</font>
00037 <font class="preprocessor">#include "<a class="code" href="OgreMeshManager_8h.html">OgreMeshManager.h</a>"</font>
00038 <font class="preprocessor">#include "<a class="code" href="OgreMaterial_8h.html">OgreMaterial.h</a>"</font>
00039 
00040 <font class="keyword">namespace </font>Ogre {
00041     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00042"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema0">00042</a>     RenderSystem::RenderSystem()
00043     {
00044         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn4">mActiveViewport</a> = 0;
00045         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn3">mTextureManager</a> = 0;
00046         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn7">mVSync</a> = <font class="keyword">true</font>;
00047         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn5">mMeshMgr</a> = 0;
00048 
00049 
00050         <font class="comment">// This means CULL clockwise vertices, i.e. front of poly is counter-clockwise</font>
00051         <font class="comment">// This makes it the same as OpenGL and other right-handed systems</font>
00052         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn6">mCullingMode</a> = <a class="code" href="namespaceOgre.html#a430a85">CULL_CLOCKWISE</a>;
00053 
00054         <font class="comment">// Create an initially sized software vertex blend buffer</font>
00055         <font class="comment">// Enough for 5000 vertices</font>
00056         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>.resize(5000 * 3);
00057 
00058     }
00059 
00060     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00061"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema1">00061</a>     RenderSystem::~RenderSystem()
00062     {
00063         <font class="comment">// Destroy render windows created</font>
00064         <font class="comment">/*</font>
00065 <font class="comment">        for (RenderWindowMap::iterator i = mRenderWindows.begin();</font>
00066 <font class="comment">                i != mRenderWindows.end(); ++i)</font>
00067 <font class="comment">        {</font>
00068 <font class="comment">            delete (*i).second;</font>
00069 <font class="comment">        }</font>
00070 <font class="comment">        */</font>
00071 
00072         <font class="keywordflow">if</font> (mMeshMgr)
00073             <font class="keyword">delete</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn5">mMeshMgr</a>;
00074     }
00075     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00076"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema47">00076</a>     <font class="keywordtype">void</font> RenderSystem::addFrameListener(<a class="code" href="classOgre_1_1FrameListener.html">FrameListener</a>* newListener)
00077     {
00078         <font class="comment">// Insert, unique only (set)</font>
00079         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.insert(newListener);
00080     }
00081     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00082"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema48">00082</a>     <font class="keywordtype">void</font> RenderSystem::removeFrameListener(<a class="code" href="classOgre_1_1FrameListener.html">FrameListener</a>* oldListener)
00083     {
00084         <font class="comment">// Remove, 1 only (set)</font>
00085         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.erase(oldListener);
00086     }
00087     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00088"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemb0">00088</a>     <font class="keywordtype">bool</font> RenderSystem::fireFrameStarted(<a class="code" href="structOgre_1_1FrameEvent.html">FrameEvent</a>&amp; evt)
00089     {
00090         <font class="comment">// Tell all listeners</font>
00091         std::set&lt;FrameListener*&gt;::iterator i;
00092         <font class="keywordflow">for</font> (i= <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.begin(); i != <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.end(); ++i)
00093         {
00094             <font class="keywordflow">if</font> (!(*i)-&gt;frameStarted(evt))
00095                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00096         }
00097 
00098         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00099 
00100     }
00101     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00102"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemb1">00102</a>     <font class="keywordtype">bool</font> RenderSystem::fireFrameEnded(<a class="code" href="structOgre_1_1FrameEvent.html">FrameEvent</a>&amp; evt)
00103     {
00104         <font class="comment">// Tell all listeners</font>
00105         std::set&lt;FrameListener*&gt;::iterator i;
00106         <font class="keywordflow">for</font> (i= <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.begin(); i != <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn0">mFrameListeners</a>.end(); ++i)
00107         {
00108             <font class="keywordflow">if</font> (!(*i)-&gt;frameEnded(evt))
00109                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00110         }
00111         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00112     }
00113     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00114"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema11">00114</a>     <font class="keywordtype">void</font> RenderSystem::startRendering(<font class="keywordtype">void</font>)
00115     {
00116 
00117         <font class="comment">// Init stats</font>
00118         <font class="keywordflow">for</font>(
00119             RenderWindowMap::iterator it = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.begin();
00120             it != <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.end();
00121             ++it )
00122         {
00123             it-&gt;second-&gt;resetStatistics();
00124         }
00125 
00126     }
00127     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00128"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema6">00128</a>     <a class="code" href="classOgre_1_1RenderWindow.html">RenderWindow</a>* RenderSystem::initialise(<font class="keywordtype">bool</font> autoCreateWindow)
00129     {
00130         <font class="comment">// Have I been registered by call to Root::setRenderSystem?</font>
00131         <a class="code" href="classOgre_1_1RenderSystem.html">RenderSystem</a>* regPtr = Root::getSingleton().getRenderSystem();
00132         <font class="keywordflow">if</font> (!regPtr || regPtr != <font class="keyword">this</font>)
00133             <font class="comment">// Register self - library user has come to me direct</font>
00134             Root::getSingleton().setRenderSystem(<font class="keyword">this</font>);
00135 
00136         <font class="comment">// Create mesh manager</font>
00137         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn5">mMeshMgr</a> = <font class="keyword">new</font> <a class="code" href="classOgre_1_1MeshManager.html">MeshManager</a>();
00138 
00139         <font class="comment">// Subclasses should take it from here</font>
00140         <font class="comment">// They should ALL call this superclass method from</font>
00141         <font class="comment">//   their own initialise() implementations.</font>
00142 
00143         <font class="keywordflow">return</font> 0;
00144     }
00145     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00146"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema50">00146</a>     <a class="code" href="classOgre_1_1RenderWindow.html">RenderWindow</a>* RenderSystem::getRenderWindow(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a> &amp;name)
00147     {
00148         RenderWindowMap::iterator it = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.find(name);
00149 
00150         <font class="keywordflow">if</font>( it != <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.end() )
00151             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00152                 Exception::ERR_ITEM_NOT_FOUND,
00153                 <font class="stringliteral">"Cannot find window called '"</font> + name + <font class="stringliteral">"'"</font>,
00154                 <font class="stringliteral">"RenderSystem::getRenderWindow"</font>);
00155 
00156         <font class="keywordflow">return</font>( it-&gt;second );
00157     }
00158     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00159"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema49">00159</a>     <font class="keywordtype">void</font> RenderSystem::destroyRenderWindow(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a> &amp;name)
00160     {
00161         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.erase(name);
00162 
00163     }
00164     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00165"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema56">00165</a>     <a class="code" href="classOgre_1_1Viewport.html">Viewport</a>* RenderSystem::_getViewport(<font class="keywordtype">void</font>)
00166     {
00167         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn4">mActiveViewport</a>;
00168     }
00169     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00170"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema54">00170</a>     <font class="keywordtype">void</font> RenderSystem::_setTextureUnitSettings(<font class="keywordtype">int</font> texUnit, <a class="code" href="classOgre_1_1Material_1_1TextureLayer.html">Material::TextureLayer</a>&amp; tl)
00171     {
00172         <font class="comment">// This method is only ever called to set a texture unit to valid details</font>
00173         <font class="comment">// The method _disableTextureUnit is called to turn a unit off</font>
00174 
00175         <a class="code" href="classOgre_1_1Material_1_1TextureLayer.html">Material::TextureLayer</a>&amp; curr = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn8">mTextureUnits</a>[texUnit];
00176         <font class="keywordtype">bool</font> currIsBlank = curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera49">isBlank</a>();
00177 
00178         <font class="comment">// Texture name</font>
00179         <a class="code" href="classOgre_1_1String.html">String</a> texName = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera6">getTextureName</a>();
00180         <font class="keywordflow">if</font> (currIsBlank || curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera6">getTextureName</a>() != texName)
00181         {
00182             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema36">_setTexture</a>(texUnit, <font class="keyword">true</font>, texName);
00183         }
00184 
00185         <font class="comment">// Set texture coordinate set</font>
00186         <font class="keywordtype">int</font> coordSet = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera18">getTextureCoordSet</a>();
00187         <font class="keywordflow">if</font> (currIsBlank || curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera18">getTextureCoordSet</a>() != coordSet)
00188         {
00189             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema38">_setTextureCoordSet</a>(texUnit, coordSet);
00190         }
00191 
00192         <font class="comment">// Set blend modes</font>
00193         <a class="code" href="classOgre_1_1LayerBlendModeEx.html">LayerBlendModeEx</a> newBlend = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera34">getColourBlendMode</a>();
00194         <font class="keywordflow">if</font> (currIsBlank || curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera34">getColourBlendMode</a>() != newBlend)
00195         {
00196             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema40">_setTextureBlendMode</a>(texUnit, newBlend);
00197         }
00198         newBlend = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera35">getAlphaBlendMode</a>();
00199         <font class="keywordflow">if</font> (currIsBlank || curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera35">getAlphaBlendMode</a>() != newBlend)
00200         {
00201             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema40">_setTextureBlendMode</a>(texUnit, newBlend);
00202         }
00203 
00204         <font class="comment">// Set addressing</font>
00205         Material::TextureLayer::TextureAddressingMode addr = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera29">getTextureAddressingMode</a>();
00206         <font class="keywordflow">if</font> (currIsBlank || curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera29">getTextureAddressingMode</a>() != addr)
00207         {
00208             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema41">_setTextureAddressingMode</a>(texUnit, addr );
00209         }
00210 
00211 
00212         <font class="comment">// Set texture effects</font>
00213         Material::TextureLayer::EffectMap::iterator effi;
00214         <font class="keywordtype">bool</font> currEnv = <font class="keyword">false</font>;
00215         <font class="keywordtype">bool</font> currEnvPlanar = <font class="keyword">false</font>;
00216         <font class="comment">// bool currTexMod = false;</font>
00217         <font class="comment">// Iterate over current effects</font>
00218         <font class="keywordflow">for</font> (effi = curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayern26">mEffects</a>.begin(); effi != curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayern26">mEffects</a>.end(); ++effi)
00219         {
00220             <font class="keywordflow">switch</font> (effi-&gt;second.type)
00221             {
00222             <font class="keywordflow">case</font> Material::TextureLayer::ET_ENVIRONMENT_MAP:
00223                 <font class="keywordflow">if</font> (effi-&gt;second.subtype == Material::TextureLayer::ENV_CURVED)
00224                 {
00225                     currEnv = <font class="keyword">true</font>;
00226                 }
00227                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (effi-&gt;second.subtype == Material::TextureLayer::ENV_PLANAR)
00228                 {
00229                     currEnvPlanar = <font class="keyword">true</font>;
00230                 }
00231                 <font class="keywordflow">break</font>;
00232         <font class="keywordflow">case</font> Material::TextureLayer::ET_BUMP_MAP:
00233         <font class="keywordflow">case</font> Material::TextureLayer::ET_SCROLL:
00234         <font class="keywordflow">case</font> Material::TextureLayer::ET_ROTATE:
00235         <font class="keywordflow">case</font> Material::TextureLayer::ET_TRANSFORM:
00236           <font class="keywordflow">break</font>;
00237             }
00238         }
00239         <font class="comment">// Iterate over new effects</font>
00240         <font class="keywordtype">bool</font> anyCalcs = <font class="keyword">false</font>;
00241         <font class="keywordflow">for</font> (effi = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayern26">mEffects</a>.begin(); effi != tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayern26">mEffects</a>.end(); ++effi)
00242         {
00243             <font class="keywordflow">switch</font> (effi-&gt;second.type)
00244             {
00245             <font class="keywordflow">case</font> Material::TextureLayer::ET_ENVIRONMENT_MAP:
00246                 <font class="keywordflow">if</font> (effi-&gt;second.subtype == Material::TextureLayer::ENV_CURVED)
00247                 {
00248                     <font class="keywordflow">if</font> (currIsBlank || !currEnv)
00249                     {
00250                         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema39">_setTextureCoordCalculation</a>(texUnit, <a class="code" href="namespaceOgre.html#a438a297">TEXCALC_ENVIRONMENT_MAP</a>);
00251                     }
00252                     anyCalcs = <font class="keyword">true</font>;
00253                 }
00254                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (effi-&gt;second.subtype == Material::TextureLayer::ENV_PLANAR)
00255                 {
00256                     <font class="keywordflow">if</font> (currIsBlank || !currEnvPlanar)
00257                     {
00258                         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema39">_setTextureCoordCalculation</a>(texUnit, <a class="code" href="namespaceOgre.html#a438a298">TEXCALC_ENVIRONMENT_MAP_PLANAR</a>);
00259                     }
00260                     anyCalcs = <font class="keyword">true</font>;
00261                 }
00262                 <font class="keywordflow">break</font>;
00263         <font class="keywordflow">case</font> Material::TextureLayer::ET_BUMP_MAP:
00264         <font class="keywordflow">case</font> Material::TextureLayer::ET_SCROLL:
00265         <font class="keywordflow">case</font> Material::TextureLayer::ET_ROTATE:
00266         <font class="keywordflow">case</font> Material::TextureLayer::ET_TRANSFORM:
00267           <font class="keywordflow">break</font>;
00268             }
00269         }
00270         <font class="comment">// Ensure any previous texcoord calc settings are reset if there are now none</font>
00271         <font class="keywordflow">if</font> ((!anyCalcs) &amp;&amp; (currEnv || currEnvPlanar))
00272         {
00273             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema39">_setTextureCoordCalculation</a>(texUnit, <a class="code" href="namespaceOgre.html#a438a296">TEXCALC_NONE</a>);
00274             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema38">_setTextureCoordSet</a>(texUnit, tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera18">getTextureCoordSet</a>());
00275         }
00276 
00277 
00278         <font class="comment">// Change tetxure matrix if required</font>
00279         <font class="comment">// NB concatenate with any existing texture matrix created for generate</font>
00280         <font class="keyword">const</font> <a class="code" href="classOgre_1_1Matrix4.html">Matrix4</a>&amp; xform = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera21">getTextureTransform</a>();
00281         <font class="comment">// HACK for now - turn off texture calc if any texture generation effects</font>
00282         <font class="keywordflow">if</font>( !( curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera21">getTextureTransform</a>() == xform ) &amp;&amp; !anyCalcs )
00283         {
00284             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema42">_setTextureMatrix</a>(texUnit, xform);
00285         }
00286 
00287         <font class="comment">// Set alpha rejection</font>
00288         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> alphaVal = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera46">getAlphaRejectValue</a>();
00289         <a class="code" href="namespaceOgre.html#a426">CompareFunction</a> alphaFunc = tl.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera45">getAlphaRejectFunction</a>();
00290         <font class="keywordflow">if</font> (currIsBlank ||
00291             (curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera45">getAlphaRejectFunction</a>() != alphaFunc) ||
00292             (curr.<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera46">getAlphaRejectValue</a>() != alphaVal))
00293         {
00294             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema44">_setAlphaRejectSettings</a>(alphaFunc, alphaVal);
00295         }
00296 
00297         <font class="comment">// Now that the changes have been made, update the record of current texture unit settings</font>
00298         curr = tl;
00299 
00300     }
00301     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00302"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema55">00302</a>     <font class="keywordtype">void</font> RenderSystem::_disableTextureUnit(<font class="keywordtype">int</font> texUnit)
00303     {
00304         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema36">_setTexture</a>(texUnit, <font class="keyword">false</font>, <font class="stringliteral">""</font>);
00305         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn8">mTextureUnits</a>[texUnit].<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera50">setBlank</a>();
00306 
00307 
00308     }
00309     <font class="comment">//-----------------------------------------------------------------------</font>
00310     <font class="comment">/*</font>
00311 <font class="comment">    void RenderSystem::_setMaterial(Material &amp;mat)</font>
00312 <font class="comment">    {</font>
00313 <font class="comment"></font>
00314 <font class="comment">        // Set surface properties</font>
00315 <font class="comment">        _setSurfaceParams(mat.ambient, mat.diffuse, mat.specular, mat.emmissive, mat.shininess);</font>
00316 <font class="comment"></font>
00317 <font class="comment">        // Set global blending</font>
00318 <font class="comment">        _setSceneBlending(mat.getSourceBlendFactor(), mat.getDestBlendFactor());</font>
00319 <font class="comment"></font>
00320 <font class="comment">        // Set textures</font>
00321 <font class="comment">        // Note that it is assumed caller has checked that there are</font>
00322 <font class="comment">        // enough texture units to support multitexturing all layers</font>
00323 <font class="comment">        // If not they should be calling _setTexture separately per multipass render</font>
00324 <font class="comment">        // If the texture layers exceed the number of supported texture</font>
00325 <font class="comment">        // units, the remaining textures will not be displayed</font>
00326 <font class="comment">        int matTexLayers = mat.getNumTextureLayers();</font>
00327 <font class="comment">        for (int texLayer = 0; texLayer &lt; _getNumTextureUnits(); ++texLayer)</font>
00328 <font class="comment">        {</font>
00329 <font class="comment">            if (texLayer &gt;= matTexLayers)</font>
00330 <font class="comment">            {</font>
00331 <font class="comment">                // Run out of material texture layers before h/w</font>
00332 <font class="comment">                // Turn off these units</font>
00333 <font class="comment">                _setTexture(texLayer, false, "");</font>
00334 <font class="comment">            }</font>
00335 <font class="comment">            else</font>
00336 <font class="comment">            {</font>
00337 <font class="comment">                Material::TextureLayer* tl = mat.getTextureLayer(texLayer);</font>
00338 <font class="comment">                _setTextureUnitSettings(texLayer, *tl);</font>
00339 <font class="comment">            }</font>
00340 <font class="comment">        }</font>
00341 <font class="comment">    }</font>
00342 <font class="comment">    */</font>
00343     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00344"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema57">00344</a>     <a class="code" href="namespaceOgre.html#a430">CullingMode</a> RenderSystem::_getCullingMode(<font class="keywordtype">void</font>)
00345     {
00346         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn6">mCullingMode</a>;
00347     }
00348     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00349"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema52">00349</a>     <font class="keywordtype">bool</font> RenderSystem::getWaitForVerticalBlank(<font class="keywordtype">void</font>)
00350     {
00351         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn7">mVSync</a>;
00352     }
00353     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00354"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema51">00354</a>     <font class="keywordtype">void</font> RenderSystem::setWaitForVerticalBlank(<font class="keywordtype">bool</font> enabled)
00355     {
00356         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn7">mVSync</a> = enabled;
00357     }
00358     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00359"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema8">00359</a>     <font class="keywordtype">void</font> RenderSystem::shutdown(<font class="keywordtype">void</font>)
00360     {
00361         <font class="comment">// Close all windows</font>
00362         <font class="keywordflow">for</font>( RenderWindowMap::iterator it = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.begin(); it != <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn2">mRenderWindows</a>.end(); ++it )
00363         {
00364             it-&gt;second-&gt;destroy();
00365         }
00366 
00367     }
00368     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00369"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema58">00369</a>     <font class="keywordtype">void</font> RenderSystem::_beginGeometryCount(<font class="keywordtype">void</font>)
00370     {
00371         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn9">mFaceCount</a> = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn10">mVertexCount</a> = 0;
00372 
00373     }
00374     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00375"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema59">00375</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> RenderSystem::_getFaceCount(<font class="keywordtype">void</font>)
00376     {
00377         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn9">mFaceCount</a>;
00378     }
00379     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00380"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema60">00380</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> RenderSystem::_getVertexCount(<font class="keywordtype">void</font>)
00381     {
00382         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn10">mVertexCount</a>;
00383     }
00384     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00385"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema46">00385</a>     <font class="keywordtype">void</font> RenderSystem::_render(<a class="code" href="classOgre_1_1RenderOperation.html">RenderOperation</a>&amp; op)
00386     {
00387         <font class="comment">// Update stats</font>
00388         <font class="keywordtype">int</font> val;
00389 
00390         <font class="keywordflow">if</font> (op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm0">useIndexes</a>)
00391             val = op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a>;
00392         <font class="keywordflow">else</font>
00393             val = op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00394 
00395         <font class="keywordflow">switch</font>(op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm19">operationType</a>)
00396         {
00397         <font class="keywordflow">case</font> RenderOperation::OT_TRIANGLE_LIST:
00398             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn9">mFaceCount</a> += val / 3;
00399             <font class="keywordflow">break</font>;
00400         <font class="keywordflow">case</font> RenderOperation::OT_TRIANGLE_STRIP:
00401         <font class="keywordflow">case</font> RenderOperation::OT_TRIANGLE_FAN:
00402             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn9">mFaceCount</a> += val - 2;
00403             <font class="keywordflow">break</font>;
00404         <font class="keywordflow">case</font> RenderOperation::OT_POINT_LIST:
00405         <font class="keywordflow">case</font> RenderOperation::OT_LINE_LIST:
00406         <font class="keywordflow">case</font> RenderOperation::OT_LINE_STRIP:
00407             <font class="keywordflow">break</font>;
00408         }
00409 
00410         <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn10">mVertexCount</a> += op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00411 
00412         <font class="comment">// Vertex blending: do software if required</font>
00413         <font class="keywordflow">if</font> ((op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm18">vertexOptions</a> &amp; RenderOperation::VO_BLEND_WEIGHTS) &amp;&amp; 
00414             !this-&gt;<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema61">_isVertexBlendSupported</a>())
00415         {
00416             <font class="comment">// Software blending required</font>
00417             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemb2">softwareVertexBlend</a>(op, <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn11">mWorldMatrices</a>);
00418         }
00419     }
00420     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00421"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema61">00421</a>     <font class="keywordtype">bool</font> RenderSystem::_isVertexBlendSupported(<font class="keywordtype">void</font>)
00422     {
00423         <font class="comment">// TODO: implement vertex blending support in DX8 &amp; possibly GL_ARB_VERTEX_BLEND (in subclasses)</font>
00424         <font class="comment">// DX7 support not good enough - only 4 matrices supported</font>
00425         <font class="keywordflow">return</font> <font class="keyword">false</font>;
00426     }
00427     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00428"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema62">00428</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> RenderSystem::_getNumVertexBlendMatrices(<font class="keywordtype">void</font>)
00429     {
00430         <font class="comment">// TODO: implement vertex blending support in DX8 &amp; possibly GL_ARB_VERTEX_BLEND (in subclasses)</font>
00431         <font class="keywordflow">return</font> 1;
00432     }
00433     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00434"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemb2">00434</a>     <font class="keywordtype">void</font> RenderSystem::softwareVertexBlend(<a class="code" href="classOgre_1_1RenderOperation.html">RenderOperation</a>&amp; op, <a class="code" href="classOgre_1_1Matrix4.html">Matrix4</a>* pMatrices)
00435     {
00436         <font class="comment">// Source vector</font>
00437         <a class="code" href="classOgre_1_1Vector3.html">Vector3</a> sourceVec;
00438         <font class="comment">// Accumulation vector</font>
00439         <a class="code" href="classOgre_1_1Vector3.html">Vector3</a> accumVec;
00440 
00441         <a class="code" href="namespaceOgre.html#a281">Real</a>* pVertElem;
00442         <a class="code" href="structOgre_1_1RenderOperation_1_1VertexBlendData.html">RenderOperation::VertexBlendData</a>* pBlend;
00443 
00444         <font class="comment">// Check buffer size</font>
00445         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> numVertReals = op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> * 3;
00446         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>.size() &lt; numVertReals)
00447         {
00448             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>.resize(numVertReals);
00449         }
00450 
00451         <font class="comment">// Loop per vertex</font>
00452         pVertElem = op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a>;
00453         pBlend = op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm15">pBlendingWeights</a>;
00454         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> vertIdx = 0; 
00455             vertIdx &lt; numVertReals; vertIdx += 3)
00456         {
00457             <font class="comment">// Load source vertex elements</font>
00458             sourceVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m0">x</a> = *pVertElem++;
00459             sourceVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m1">y</a> = *pVertElem++;
00460             sourceVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m2">z</a> = *pVertElem++;
00461             <font class="comment">// Load accumulator</font>
00462             accumVec = Vector3::ZERO;
00463 
00464             <font class="comment">// Loop per blend weight </font>
00465             <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> blendIdx = 0; blendIdx &lt; op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm2">numBlendWeightsPerVertex</a>; ++blendIdx)
00466             {
00467                 <font class="comment">// Blend by multiplying source by blend matrix and scaling by weight</font>
00468                 <font class="comment">// Add to accumulator</font>
00469                 <font class="comment">// NB weights must be normalised!!</font>
00470                 <font class="keywordflow">if</font> (pBlend-&gt;<a class="code" href="structOgre_1_1RenderOperation_1_1VertexBlendData.html#Ogre_1_1RenderOperation_1_1VertexBlendDatam1">blendWeight</a> != 0.0) 
00471                 {
00472                     accumVec += (pMatrices[pBlend-&gt;<a class="code" href="structOgre_1_1RenderOperation_1_1VertexBlendData.html#Ogre_1_1RenderOperation_1_1VertexBlendDatam0">matrixIndex</a>] * sourceVec) 
00473                         * pBlend-&gt;<a class="code" href="structOgre_1_1RenderOperation_1_1VertexBlendData.html#Ogre_1_1RenderOperation_1_1VertexBlendDatam1">blendWeight</a>;
00474                 }
00475                 pBlend++;
00476             }
00477 
00478             <font class="comment">// Stored blended vertex in temp buffer</font>
00479             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>[vertIdx] = accumVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m0">x</a>;
00480             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>[vertIdx+1] = accumVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m1">y</a>;
00481             <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>[vertIdx+2] = accumVec.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m2">z</a>;
00482 
00483         }
00484 
00485         <font class="comment">// Re-point the render operation vertex buffer</font>
00486         op.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn12">mTempVertexBlendBuffer</a>.begin();
00487 
00488         
00489 
00490 
00491     }
00492     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00493"></a><a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema53">00493</a>     <font class="keywordtype">void</font> RenderSystem::_setWorldMatrices(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Matrix4.html">Matrix4</a>* m, <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> count)
00494     {
00495         <font class="keywordflow">if</font> (!<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystema61">_isVertexBlendSupported</a>())
00496         {
00497             <font class="comment">// Save these matrices for software blending later</font>
00498             <font class="keywordtype">int</font> i;
00499             <font class="keywordflow">for</font> (i = 0; i &lt; count; ++i)
00500             {
00501                 <a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1SDLRenderSystemn11">mWorldMatrices</a>[i] = m[i];
00502             }
00503         }
00504         <font class="comment">// TODO: implement vertex blending support in DX8 &amp; possibly GL_ARB_VERTEX_BLEND (in subclasses)</font>
00505     }
00506 
00507 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
