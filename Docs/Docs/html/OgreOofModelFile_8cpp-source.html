<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreOofModelFile.cpp</h1><a href="OgreOofModelFile_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreOofModelFile_8h.html">OgreOofModelFile.h</a>"</font>
00026 
00027 <font class="preprocessor">#include "<a class="code" href="OgreOofFile_8h.html">OgreOofFile.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreSceneManager_8h.html">OgreSceneManager.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreRoot_8h.html">OgreRoot.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreSDDataChunk_8h.html">OgreSDDataChunk.h</a>"</font>
00032 
00033 <font class="preprocessor">#include "zlib.h"</font>
00034 
00035 <font class="keyword">namespace </font>Ogre {
00036 
<a name="l00037"></a><a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea0">00037</a>     OofModelFile::OofModelFile()
00038     {
00039         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam8">pColours</a> = 0;
00040         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a> = 0;
00041         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; <a class="code" href="OgreConfig_8h.html#a5">OGRE_MAX_TEXTURE_COORD_SETS</a>; ++i)
00042             <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[i] = 0;
00043         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> = 0;
00044         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem0">autoDeallocateMemory</a> = <font class="keyword">true</font>;
00045     }
00046 
<a name="l00047"></a><a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea1">00047</a>     OofModelFile::~OofModelFile()
00048     {
00049         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea4">freeMemory</a>();
00050     }
00051 
<a name="l00052"></a><a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea2">00052</a>     <font class="keywordtype">void</font> OofModelFile::load(<a class="code" href="classOgre_1_1String.html">String</a> filename)
00053     {
00054         this-&gt;filename = filename;
00055         <font class="comment">// No compression</font>
00056         FILE* fp;
00057 
00058         fp = fopen(filename.c_str(), <font class="stringliteral">"rb"</font>);
00059 
00060         <font class="comment">// Read entire file into memory</font>
00061         <font class="comment">// This is to standardise dealing with data uncompressed</font>
00062         <font class="comment">// from archives and from files</font>
00063         fseek(fp, 0, SEEK_END);
00064         size_t filesize = ftell(fp);
00065         fseek(fp, 0 , SEEK_SET);
00066 
00067         <a class="code" href="classOgre_1_1SDDataChunk.html">SDDataChunk</a> tempChunk;
00068         tempChunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka3">allocate</a>( static_cast&lt; unsigned long &gt;( filesize ) );
00069 
00070         fread( 
00071             reinterpret_cast&lt; void * &gt;( const_cast&lt; unsigned char * &gt;( tempChunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka6">getPtr</a>() ) ), 
00072             filesize, 1, fp);
00073 
00074         <font class="comment">// Use memory loader</font>
00075         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea2">load</a>(tempChunk);
00076 
00077         tempChunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka4">clear</a>();
00078     }
00079 
<a name="l00080"></a><a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea3">00080</a>     <font class="keywordtype">void</font> OofModelFile::load(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; chunk)
00081     {
00082         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> val;
00083         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> dataSize;
00084 
00085         <font class="comment">// Free any exsiting memory</font>
00086         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea4">freeMemory</a>();
00087 
00088         <font class="comment">// Read header</font>
00089         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> numObjects;
00090         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> numMaterials;
00091 
00092         chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(val));
00093         <font class="keywordflow">if</font> (val == <a class="code" href="namespaceOgre.html#a437a265">OOF_HEADER</a>)
00094         {
00095             chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;dataSize, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00096             <font class="comment">// read nummaterials, numobjects</font>
00097             chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;numMaterials, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00098             chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;numObjects, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00099         }
00100         <font class="keywordflow">else</font>
00101         {
00102             <a class="code" href="OgreException_8h.html#a0">Except</a>(999, <font class="stringliteral">"Missing header in OOF file."</font>, <font class="stringliteral">"OofModelFile::loadOof"</font>);
00103         }
00104 
00105 
00106         <font class="keywordtype">int</font> readCount;
00107         readCount = chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(val));
00108 
00109         <font class="comment">// int matNum = -1;</font>
00110         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> matIndex;
00111         <font class="keywordflow">while</font> (readCount &gt; 0)
00112         {
00113             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> chunkId = val;
00114             <font class="comment">// Get data size</font>
00115             chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(val));
00116             dataSize = val;
00117 
00118             <a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html">MaterialData</a> matdata;            
00119             <a class="code" href="classOgre_1_1ColourValue.html">ColourValue</a> ambient, diffuse, specular;
00120             <a class="code" href="namespaceOgre.html#a281">Real</a> shininess;
00121             <font class="comment">// determine type</font>
00122             <font class="keywordflow">switch</font> (chunkId)
00123             {
00124             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a266">OOF_MATERIAL</a>:
00125                 <font class="keywordtype">char</font> matName[255];
00126                 readCount = chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka11">readUpTo</a>(matName, 255);
00127                 <font class="comment">// Terminate</font>
00128                 matName[readCount] = <font class="charliteral">'\0'</font>;
00129                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam0">material</a> = <a class="code" href="classOgre_1_1Material.html">Material</a>(matName);
00130                 <font class="comment">// Init geometry info</font>
00131                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam1">useSharedVertices</a> = <font class="keyword">true</font>;
00132                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam4">pIndexes</a> = 0;
00133                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam3">numFaces</a> = 0;
00134                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;ambient.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem0">r</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00135                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;ambient.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem1">g</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00136                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;ambient.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem2">b</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00137                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;diffuse.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem0">r</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00138                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;diffuse.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem1">g</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00139                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;diffuse.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem2">b</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00140                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;specular.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem0">r</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00141                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;specular.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem1">g</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00142                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;specular.<a class="code" href="classOgre_1_1ColourValue.html#Ogre_1_1ColourValuem2">b</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00143                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;shininess, <font class="keyword">sizeof</font>(<font class="keywordtype">float</font>));
00144                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam0">material</a>.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala5">setAmbient</a>(ambient);
00145                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam0">material</a>.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala7">setDiffuse</a>(diffuse);
00146                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam0">material</a>.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala9">setSpecular</a>(specular);
00147                 matdata.<a class="code" href="structOgre_1_1OofModelFile_1_1MaterialData.html#Ogre_1_1OofModelFile_1_1MaterialDatam0">material</a>.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala11">setShininess</a>(shininess);
00148                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>.push_back(matdata);
00149                 <font class="keywordflow">break</font>;
00150             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a267">OOF_TEXTURE_LAYER</a>:
00151                 <font class="keywordtype">char</font> texname[64];
00152                 readCount = chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka11">readUpTo</a>(texname, 64);
00153                 <font class="comment">// Terminate</font>
00154                 texname[readCount] = <font class="charliteral">'\0'</font>;
00155                 <font class="comment">// Add to latest material</font>
00156                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>.back().material.addTextureLayer(<a class="code" href="classOgre_1_1String.html">String</a>(texname));
00157 
00158                 <font class="keywordflow">break</font>;
00159             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a268">OOF_OBJECT</a>:
00160                 <font class="comment">// assume single object for now</font>
00161                 <font class="keywordtype">char</font> objname[64];
00162                 readCount = chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka11">readUpTo</a>(objname, 64);
00163                 <font class="comment">// Terminate</font>
00164                 objname[readCount] = <font class="charliteral">'\0'</font>;
00165                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00166                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a> = val;
00167                 <font class="comment">// Assume no normals, colours, textures for now</font>
00168                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam1">hasNormals</a> = <font class="keyword">false</font>;
00169                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam2">numTexCoords</a> = 0;
00170                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam4">hasColours</a> = <font class="keyword">false</font>;
00171                 <font class="comment">// Init strides</font>
00172                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam9">vertexStride</a> = 0;
00173                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam10">normalStride</a> = 0;
00174                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam12">colourStride</a> = 0;
00175                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam11">texCoordStride</a>[0] = 0;
00176                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam11">texCoordStride</a>[1] = 0;
00177 
00178                 <font class="keywordflow">break</font>;
00179             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a269">OOF_VSHAREDPOSITIONS</a>:
00180                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> =
00181                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a>*3];
00182                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a>,
00183                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a> * 3);
00184                 <font class="keywordflow">break</font>;
00185             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a270">OOF_VSHAREDNORMALS</a>:
00186                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam1">hasNormals</a> = <font class="keyword">true</font>;
00187                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a> =
00188                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a>*3];
00189                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a> ,
00190                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a> * 3);
00191                 <font class="keywordflow">break</font>;
00192             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a271">OOF_VSHAREDTEXCOORDS</a>:
00193                 <font class="comment">// Assume 2D textures for now, 1 tex coord set</font>
00194                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam2">numTexCoords</a> = 1;
00195                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam3">numTexCoordDimensions</a>[0] = 2;
00196                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[0] =
00197                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a>*2];
00198                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[0],
00199                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a> * 2);
00200                 <font class="keywordflow">break</font>;
00201             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a272">OOF_VSHAREDCOLOURS</a>:
00202                 <font class="comment">// TODO - not yet supported</font>
00203                 <font class="keywordflow">break</font>;
00204             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a273">OOF_MATERIAL_GROUP</a>:
00205                 <font class="comment">// Read material index</font>
00206                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;matIndex, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00207                 <font class="comment">// Read number of faces</font>
00208                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].numFaces, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00209                 <font class="comment">// Allocate memory for face indexes</font>
00210                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].pIndexes = <font class="keyword">new</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].numFaces * 3];
00211                 <font class="comment">// Read faces</font>
00212                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].pIndexes,
00213                     <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].numFaces * 3);
00214                 <font class="comment">// Number of dedicated vertices</font>
00215                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>));
00216                 <font class="keywordflow">if</font> (val &gt; 0)
00217                 {
00218                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].useSharedVertices = <font class="keyword">false</font>;
00219                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices = val;
00220                     <font class="comment">// Assume no normals, colours, textures for now</font>
00221                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.hasNormals = <font class="keyword">false</font>;
00222                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numTexCoords = 0;
00223                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.hasColours = <font class="keyword">false</font>;
00224                     <font class="comment">// Init strides</font>
00225                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.vertexStride = 0;
00226                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.normalStride = 0;
00227                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.colourStride = 0;
00228                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.texCoordStride[0] = 0;
00229                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.texCoordStride[1] = 0;
00230                 }
00231                 <font class="keywordflow">else</font>
00232                 {
00233                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].useSharedVertices = <font class="keyword">true</font>;
00234                 }
00235 
00236                 <font class="keywordflow">break</font>;
00237             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a274">OOF_VPOSITIONS</a>:
00238                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pVertices =
00239                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices*3];
00240                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pVertices,
00241                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices * 3);
00242                 <font class="keywordflow">break</font>;
00243             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a275">OOF_VNORMALS</a>:
00244                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.hasNormals = <font class="keyword">true</font>;
00245                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pNormals =
00246                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices*3];
00247                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pNormals ,
00248                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices * 3);
00249                 <font class="keywordflow">break</font>;
00250             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a276">OOF_VTEXCOORDS</a>:
00251                 <font class="comment">// Assume 2D textures for now, 1 tex coord set</font>
00252                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numTexCoords = 1;
00253                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numTexCoordDimensions[0] = 2;
00254                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pTexCoords[0] =
00255                     <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices*2];
00256                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.pTexCoords[0],
00257                     <font class="keyword">sizeof</font>(<a class="code" href="namespaceOgre.html#a281">Real</a>) * <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>[matIndex].materialGeometry.numVertices * 2);
00258                 <font class="keywordflow">break</font>;
00259             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a437a277">OOF_VCOLOURS</a>:
00260                 <font class="comment">// TODO - not yet supported</font>
00261                 <font class="keywordflow">break</font>;
00262 
00263             }
00264 
00265             <font class="comment">// Read next header</font>
00266             readCount = chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>(&amp;val, <font class="keyword">sizeof</font>(val));
00267         }
00268 
00269 
00270 
00271     }
00272 
<a name="l00273"></a><a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilea4">00273</a>     <font class="keywordtype">void</font> OofModelFile::freeMemory(<font class="keywordtype">void</font>)
00274     {
00275         <font class="keywordflow">if</font> (autoDeallocateMemory)
00276         {
00277             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a>)
00278             {
00279                 <font class="keyword">delete</font>[] <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a>;
00280                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> = 0;
00281             }
00282             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a>)
00283             {
00284                 <font class="keyword">delete</font>[] <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a>;
00285                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a> = 0;
00286             }
00287             <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j = 0; j &lt; <a class="code" href="OgreConfig_8h.html#a5">OGRE_MAX_TEXTURE_COORD_SETS</a>; ++j)
00288             {
00289                 <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[j])
00290                 {
00291                     <font class="keyword">delete</font>[] <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[j];
00292                     <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[j] = 0;
00293                 }
00294             }
00295             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam8">pColours</a>)
00296             {
00297                 <font class="keyword">delete</font>[] <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam8">pColours</a>;
00298                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem2">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam8">pColours</a> = 0;
00299             }
00300 
00301             std::vector&lt;MaterialData&gt;::iterator i =
00302                 <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>.begin();
00303             <font class="keywordflow">for</font> (; i != <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>.end(); ++i)
00304             {
00305                 <font class="keywordflow">if</font> (i-&gt;pIndexes)
00306                     <font class="keyword">delete</font>[] i-&gt;pIndexes;
00307 
00308                 <font class="keywordflow">if</font> (!i-&gt;useSharedVertices)
00309                 {
00310                     <font class="keywordflow">if</font> (i-&gt;materialGeometry.pVertices)
00311                         <font class="keyword">delete</font>[] i-&gt;materialGeometry.pVertices;
00312 
00313                     <font class="keywordflow">if</font> (i-&gt;materialGeometry.pNormals)
00314                         <font class="keyword">delete</font>[] i-&gt;materialGeometry.pNormals;
00315 
00316                     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j = 0; j &lt; <a class="code" href="OgreConfig_8h.html#a5">OGRE_MAX_TEXTURE_COORD_SETS</a>; ++j)
00317                     {
00318                         <font class="keywordflow">if</font> (i-&gt;materialGeometry.pTexCoords[j])
00319                         {
00320                             <font class="keyword">delete</font>[] i-&gt;materialGeometry.pTexCoords[j];
00321                         }
00322                     }
00323 
00324                     <font class="keywordflow">if</font> (i-&gt;materialGeometry.pColours)
00325                         <font class="keyword">delete</font>[] i-&gt;materialGeometry.pColours;
00326                 }
00327 
00328             }
00329         }
00330         <a class="code" href="classOgre_1_1OofModelFile.html#Ogre_1_1OofModelFilem3">materials</a>.clear();
00331 
00332 
00333 
00334     }
00335 
00336 
00337 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
