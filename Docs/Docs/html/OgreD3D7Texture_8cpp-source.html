<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreD3D7Texture.cpp</h1><a href="OgreD3D7Texture_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreD3D7Texture_8h.html">OgreD3D7Texture.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreBitwise_8h.html">OgreBitwise.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreImage_8h.html">OgreImage.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00030 
00031 <font class="preprocessor">#include "png.h"</font>
00032 <font class="preprocessor">#include "d3dutil.h"</font>
00033 <font class="preprocessor">#include "d3dxcore.h"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreRoot_8h.html">OgreRoot.h</a>"</font>
00035 
00036 <font class="keyword">namespace </font>Ogre {
00037 
<a name="l00038"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea0">00038</a>     D3DTexture::D3DTexture(<a class="code" href="classOgre_1_1String.html">String</a> name, LPDIRECT3DDEVICE7 lpDirect3dDevice)
00039     {
00040         <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a> = name;
00041         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen0">mD3DDevice</a> = lpDirect3dDevice;
00042         <font class="comment">// Default to 16-bit texture</font>
00043         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturea8">enable32Bit</a>(<font class="keyword">false</font>);
00044     }
00045 
<a name="l00046"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea1">00046</a>     D3DTexture::~D3DTexture()
00047     {
00048         <font class="keywordflow">if</font>( mIsLoaded )
00049             <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea5">unload</a>();
00050     }
00051 
<a name="l00052"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea4">00052</a>     <font class="keywordtype">void</font> D3DTexture::blitToTexture( 
00053         <font class="keyword">const</font> <a class="code" href="classOgre_1_1Image.html">Image</a> &amp;src, <font class="keywordtype">unsigned</font> uStartX, <font class="keywordtype">unsigned</font> uStartY )
00054     {
00055         <font class="comment">// I have no FREAKING idea how this is done in DX7 and besides, I don't</font>
00056         <font class="comment">// have the API docs installed. Sorry, guys :(</font>
00057     }
00058 
<a name="l00059"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea3">00059</a>     <font class="keywordtype">void</font> D3DTexture::loadImage( <font class="keyword">const</font> <a class="code" href="classOgre_1_1Image.html">Image</a> &amp; img )
00060     {
00061         <font class="keywordflow">if</font>( mIsLoaded )
00062         {
00063             <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea5">unload</a>();
00064         }
00065 
00066         LogManager::getSingleton().logMessage( 
00067             <a class="code" href="namespaceOgre.html#a435a249">LML_TRIVIAL</a>,
00068             <font class="stringliteral">"D3DTexture: Loading %s with %d mipmaps from Image."</font>, 
00069             <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>.c_str(), <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen2">mNumMipMaps</a> );
00070 
00071         <font class="keywordflow">if</font>( img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea15">getFormat</a>() &amp; Image::FMT_ALPHA )
00072         {
00073             <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> = 32;
00074             <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a> = <font class="keyword">true</font>;
00075         }
00076         <font class="keywordflow">else</font>
00077         {
00078             <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> = 24;
00079             <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a> = <font class="keyword">false</font>;
00080         }
00081 
00082         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a> = img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea12">getWidth</a>();
00083         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a> = img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea13">getHeight</a>();
00084 
00085         <a class="code" href="namespaceOgre.html#a292">uchar</a> *pTempData = <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a292">uchar</a>[ img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea11">getSize</a>() ];
00086         memcpy( pTempData, img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea10">getConstData</a>(), img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea11">getSize</a>() );
00087 
00088         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb1">createSurfaces</a>();
00089         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Textureb0">applyGamma</a>( pTempData, img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea11">getSize</a>(), <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> );
00090         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb4">copyMemoryToSurface</a>( pTempData );
00091         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb5">generateMipMaps</a>();
00092 
00093         <font class="keyword">delete</font> [] pTempData;
00094 
00095         <font class="comment">// Update size (the final size, not including temp space)</font>
00096         <font class="keywordtype">short</font> bytesPerPixel = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> &gt;&gt; 3;
00097         <font class="keywordflow">if</font>( !<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a> &amp;&amp; <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> == 32 )
00098         {
00099             bytesPerPixel--;
00100         }
00101         <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn3">mSize</a> = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen1">mWidth</a> * <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen0">mHeight</a> * bytesPerPixel;        
00102 
00103         <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn1">mIsLoaded</a> = <font class="keyword">true</font>;
00104     }    
00105     
00106     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00107"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea2">00107</a>     <font class="keywordtype">void</font> D3DTexture::load(<font class="keywordtype">void</font>)
00108     {
00109         <a class="code" href="classOgre_1_1Image.html">Image</a> img;
00110         img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea7">load</a>( <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a> );
00111 
00112         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea3">loadImage</a>( img );
00113     }
00114 
<a name="l00115"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea5">00115</a>     <font class="keywordtype">void</font> D3DTexture::unload(<font class="keywordtype">void</font>)
00116     {
00117         <font class="keywordflow">if</font>( mIsLoaded )
00118         {
00119             <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb2">releaseSurfaces</a>();
00120             <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn1">mIsLoaded</a> = <font class="keyword">false</font>;
00121         }
00122     }
00123 
00124     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00125"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb0">00125</a>     <font class="keywordtype">void</font> D3DTexture::loadFromBMP(<font class="keywordtype">void</font>)
00126     {
00127         HBITMAP hBitmap;
00128 
00129         hBitmap = (HBITMAP)LoadImage( NULL, <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>.c_str(),
00130                                 IMAGE_BITMAP, 0, 0,
00131                                 LR_LOADFROMFILE|LR_CREATEDIBSECTION );
00132 
00133         <font class="keywordflow">if</font> (!hBitmap)
00134             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999, <font class="stringliteral">"Unable to load texture from BMP."</font>,
00135                 <font class="stringliteral">"D3DTexture::loadFromBMP"</font>);
00136 
00137         <font class="comment">// Get the bitmap structure (to extract width, height, and bpp)</font>
00138         BITMAP bm;
00139         GetObject( hBitmap, <font class="keyword">sizeof</font>(BITMAP), &amp;bm );
00140         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>  = bm.bmWidth;
00141         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a> = bm.bmHeight;
00142         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a> = <font class="keyword">false</font>;            <font class="comment">// No embedded transparency</font>
00143         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> = bm.bmBitsPixel*3;  <font class="comment">// This is per-plane</font>
00144 
00145         <font class="comment">// Create DD surfaces</font>
00146         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb1">createSurfaces</a>();
00147 
00148         <font class="comment">// Blt bitmap to surface</font>
00149         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb3">copyBitmapToSurface</a>(hBitmap);
00150 
00151 
00152     }
00153 
00154     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00155"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb1">00155</a>     <font class="keywordtype">void</font> D3DTexture::createSurfaces(<font class="keywordtype">void</font>)
00156     {
00157         <font class="comment">// Create new texture using D3DX</font>
00158         <font class="comment">// Determine requested surface format</font>
00159         <font class="comment">// Note assumption is that partial transparency is</font>
00160         <font class="comment">//  always required is there is some alpha i.e.</font>
00161         <font class="comment">//  even if 1-bit alpha is available it is not used</font>
00162         D3DX_SURFACEFORMAT d3dxSurf;
00163         <font class="comment">// 32-bit with alpha</font>
00164         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> &gt; 16 &amp;&amp; <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a>)
00165             d3dxSurf = D3DX_SF_A8R8G8B8;
00166         <font class="comment">// 32-bit, no alpha</font>
00167         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> &gt; 16 &amp;&amp; !<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a>)
00168             d3dxSurf = D3DX_SF_R8G8B8;
00169         <font class="comment">// 16-bit, with alpha</font>
00170         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> == 16 &amp;&amp; <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a>)
00171             d3dxSurf = D3DX_SF_A4R4G4B4;
00172         <font class="comment">// 16-bit, no alpha</font>
00173         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen7">mFinalBpp</a> == 16 &amp;&amp; !<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen8">mHasAlpha</a>)
00174             d3dxSurf = D3DX_SF_R5G6B5;
00175 
00176         <font class="comment">// Set up copies of core information</font>
00177         <font class="comment">// D3DX required pointers to these, &amp; I want to know if they change</font>
00178         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> d3dxMipMaps, d3dxHeight, d3dxWidth;
00179         d3dxMipMaps = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen2">mNumMipMaps</a>;
00180         d3dxHeight = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>;
00181         d3dxWidth = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>;
00182         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> flags = 0;
00183 
00184         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturea0">getNumMipMaps</a>() == 0)
00185             flags |= D3DX_TEXTURE_NOMIPMAP;
00186 
00187         HRESULT hr = D3DXCreateTexture(
00188             <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen0">mD3DDevice</a>, &amp;flags, &amp;d3dxWidth, &amp;d3dxHeight,
00189             &amp;d3dxSurf, 0, &amp;<a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>, &amp;d3dxMipMaps);
00190 
00191         <font class="keywordflow">if</font> (FAILED(hr))
00192             <font class="keywordflow">throw</font> <font class="keyword">new</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating Direct3D texture"</font>, <font class="stringliteral">"D3DTexture::createSurfaces"</font>);
00193 
00194         <font class="comment">// If actual dimensions differ, log</font>
00195         <font class="keywordflow">if</font> (d3dxWidth != <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a> || d3dxHeight != <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>)
00196         {
00197             <font class="keywordtype">char</font> msg[255];
00198 
00199             sprintf(msg, <font class="stringliteral">"Surface dimensions for requested texture %s have been altered by "</font>
00200                 <font class="stringliteral">"the renderer."</font>, <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>.c_str());
00201             LogManager::getSingleton().logMessage(msg);
00202 
00203             sprintf(msg,<font class="stringliteral">"   Requested: %dx%d Actual: %dx%d"</font>,
00204                 <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>, <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>, d3dxWidth, d3dxHeight);
00205             LogManager::getSingleton().logMessage(msg);
00206 
00207             LogManager::getSingleton().logMessage(<font class="stringliteral">"   Likely cause is that requested dimensions are not a power of 2, "</font>
00208                 <font class="stringliteral">"or device requires square textures."</font>);
00209 
00210         }
00211         <font class="comment">// Record actual width/height</font>
00212         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen1">mWidth</a> = d3dxWidth;
00213         <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen0">mHeight</a> = d3dxHeight;
00214     }
00215     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00216"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb2">00216</a>     <font class="keywordtype">void</font> D3DTexture::releaseSurfaces(<font class="keywordtype">void</font>)
00217     {
00218         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;Release();
00219         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a> = 0;
00220     }
00221 
00222 
00223     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00224"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb3">00224</a>     <font class="keywordtype">void</font> D3DTexture::copyBitmapToSurface(HBITMAP hBitmap)
00225     {
00226         <font class="comment">// Get a DDraw object to create a temporary surface</font>
00227         LPDIRECTDRAW7 pDD;
00228         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;GetDDInterface( (VOID**)&amp;pDD );
00229         pDD-&gt;Release();
00230 
00231         <font class="comment">// Setup the new surface desc</font>
00232         <font class="comment">// Start same size as source</font>
00233         DDSURFACEDESC2 ddsd;
00234         D3DUtil_InitSurfaceDesc( ddsd );
00235         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;GetSurfaceDesc( &amp;ddsd );
00236         ddsd.dwFlags          = DDSD_CAPS|DDSD_HEIGHT|DDSD_WIDTH|DDSD_PIXELFORMAT|
00237                                 DDSD_TEXTURESTAGE;
00238         ddsd.ddsCaps.dwCaps   = DDSCAPS_TEXTURE|DDSCAPS_SYSTEMMEMORY;
00239         ddsd.ddsCaps.dwCaps2  = 0L;
00240         ddsd.dwWidth          = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>;
00241         ddsd.dwHeight         = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>;
00242 
00243         <font class="comment">// Create a new surface for the texture</font>
00244         LPDIRECTDRAWSURFACE7 pddsTempSurface;
00245         HRESULT hr;
00246         <font class="keywordflow">if</font>( FAILED( hr = pDD-&gt;CreateSurface( &amp;ddsd, &amp;pddsTempSurface, NULL ) ) )
00247             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999, <font class="stringliteral">"Internal error creating surface for bitmap copy"</font>, <font class="stringliteral">"D3DTexture::copyBitmapToSurface"</font>);
00248 
00249         <font class="comment">// Get a DC for the bitmap</font>
00250         HDC hdcBitmap = CreateCompatibleDC( NULL );
00251         <font class="keywordflow">if</font>( NULL == hdcBitmap )
00252         {
00253             pddsTempSurface-&gt;Release();
00254             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999, <font class="stringliteral">"Internal error creating DC for bitmap copy"</font>, <font class="stringliteral">"D3DTexture::copyBitmapToSurface"</font>);
00255         }
00256         SelectObject( hdcBitmap, hBitmap );
00257 
00258         <font class="comment">// Copy the bitmap image to the temporary surface.</font>
00259         HDC hdcSurface;
00260         <font class="keywordflow">if</font>( SUCCEEDED( pddsTempSurface-&gt;GetDC( &amp;hdcSurface ) ) )
00261         {
00262             BitBlt( hdcSurface, 0, 0, <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>, <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>, hdcBitmap, 0, 0,
00263                     SRCCOPY );
00264             pddsTempSurface-&gt;ReleaseDC( hdcSurface );
00265         }
00266         DeleteDC( hdcBitmap );
00267 
00268         <font class="comment">// Copy the temp surface to the real texture surface (first mipmap level if mipmap)</font>
00269         <font class="comment">// At this point, blit from source size to dest size happens, stretching if required</font>
00270         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;Blt( NULL, pddsTempSurface, NULL, DDBLT_WAIT, NULL );
00271 
00272         pddsTempSurface-&gt;Release();
00273 
00274 
00275     }
00276 
00277 
00278     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00279"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb4">00279</a>     <font class="keywordtype">void</font> D3DTexture::copyMemoryToSurface(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>* pBuffer)
00280     {
00281         <font class="comment">// Get a DDraw object to create a temporary surface</font>
00282         LPDIRECTDRAW7 pDD;
00283         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;GetDDInterface( (VOID**)&amp;pDD );
00284         pDD-&gt;Release();
00285 
00286         <font class="comment">// Setup the new surface desc</font>
00287         DDSURFACEDESC2 ddsd;
00288         D3DUtil_InitSurfaceDesc( ddsd );
00289         <font class="comment">// Create temp surface at same format as final texture</font>
00290         <font class="comment">// Make same size a source for now, stretching will happen later</font>
00291         <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;GetSurfaceDesc(&amp;ddsd);
00292         ddsd.dwFlags          = DDSD_CAPS|DDSD_HEIGHT|DDSD_WIDTH|DDSD_PIXELFORMAT|
00293                                 DDSD_TEXTURESTAGE;
00294         ddsd.ddsCaps.dwCaps   = DDSCAPS_TEXTURE|DDSCAPS_SYSTEMMEMORY;
00295         ddsd.ddsCaps.dwCaps2  = 0L;
00296         <font class="comment">// Make source size</font>
00297         ddsd.dwWidth = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>;
00298         ddsd.dwHeight = <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>;
00299 
00300 
00301 
00302         <font class="comment">// Create a new temporary surface for the texture</font>
00303         <font class="comment">// This is because we may not be able to lock a</font>
00304         <font class="comment">// final texture (video memory) surface e.g. Voodoo</font>
00305         LPDIRECTDRAWSURFACE7 pddsTempSurface;
00306         HRESULT hr;
00307         <font class="keywordflow">if</font>( FAILED( hr = pDD-&gt;CreateSurface( &amp;ddsd, &amp;pddsTempSurface, NULL ) ) )
00308             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating temp surface"</font>, <font class="stringliteral">"Texture module"</font>);
00309 
00310         <font class="comment">// Copy the image from the buffer to the temporary surface.</font>
00311         <font class="comment">// We have to do our own colour conversion here since we don't</font>
00312         <font class="comment">// have a DC to do it for us (could use D3DX, but it's not that hard)</font>
00313 
00314         <font class="comment">// Note - only non-palettised surfaces supported for now</font>
00315 
00316         BYTE *pSurf8;
00317         BYTE *pBuf8;
00318         DWORD data32;
00319         DWORD out32;
00320         DWORD temp32;
00321         DWORD srcPattern;
00322 
00323         <font class="keywordtype">unsigned</font> iRow, iCol;
00324 
00325         <font class="comment">// Note - dimensions of surface may differ from buffer</font>
00326         <font class="comment">// dimensions (e.g. power of 2 or square adjustments)</font>
00327 
00328         <font class="comment">// Lock surface</font>
00329         hr = pddsTempSurface-&gt;Lock(NULL, &amp;ddsd, 0, NULL);
00330         <font class="keywordflow">if</font> (FAILED(hr))
00331             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Unable to lock temp texture surface"</font>, <font class="stringliteral">"D3DTexture::copyMemoryToSurface"</font>);
00332 
00333         <font class="keywordflow">else</font>
00334             pBuf8 = (BYTE*)pBuffer;
00335 
00336         <font class="keywordflow">for</font>( iRow = 0; iRow &lt; <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>; iRow++ )
00337         {
00338             <font class="comment">// NOTE: Direct3D used texture coordinates where (0,0) is the TOP LEFT corner of texture</font>
00339             <font class="comment">// Everybody else (OpenGL, 3D Studio etc) uses (0,0) as the BOTTOM LEFT corner</font>
00340             <font class="comment">// So whilst we load, flip the texture in the Y-axis to compensate</font>
00341             pSurf8 = (BYTE*)ddsd.lpSurface + ((<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen6">mSrcHeight</a>-iRow-1) * ddsd.lPitch);
00342 
00343             <font class="keywordflow">for</font> (iCol = 0; iCol &lt; <a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen5">mSrcWidth</a>; iCol++)
00344             {
00345                 <font class="comment">// Read RGBA values from buffer</font>
00346                 data32 = 0;
00347                 <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> &gt;= 24)
00348                 {
00349                     <font class="comment">// Data in buffer is in RGB(A) format</font>
00350                     <font class="comment">// Read into a 32-bit structure</font>
00351                     <font class="comment">// Use bytes for 24-bit compatibility</font>
00352                     <font class="comment">// Note - buffer is big-endian</font>
00353                     data32 |= *pBuf8++ &lt;&lt; 24;
00354                     data32 |= *pBuf8++ &lt;&lt; 16;
00355                     data32 |= *pBuf8++ &lt;&lt; 8;
00356                 }
00357                 <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Texture.html#Ogre_1_1Texturen4">mSrcBpp</a> == 8) <font class="comment">// Greyscale, not palettised (palettised not supported)</font>
00358                 {
00359                     <font class="comment">// Duplicate same greyscale value across R,G,B</font>
00360                     data32 |= *pBuf8 &lt;&lt; 24;
00361                     data32 |= *pBuf8 &lt;&lt; 16;
00362                     data32 |= *pBuf8++ &lt;&lt; 8;
00363                 }
00364 
00365                 <font class="keywordflow">if</font> (mHasAlpha)
00366                     data32 |= *pBuf8++;
00367                 <font class="keywordflow">else</font>
00368                     data32 |= 0xFF; <font class="comment">// Set opaque</font>
00369 
00370 
00371                 <font class="comment">// Write RGBA values to surface</font>
00372                 <font class="comment">// Data in surface can be in varying formats</font>
00373 
00374                 <font class="comment">// Use bit conversion function</font>
00375                 <font class="comment">// Note we use a 32-bit value to manipulate</font>
00376                 <font class="comment">// Will be reduced to size later</font>
00377                 out32 = 0;
00378 
00379                 <font class="comment">// Red</font>
00380                 srcPattern = 0xFF000000;
00381                 Bitwise::convertBitPattern(&amp;data32, &amp;srcPattern, 32,
00382                     &amp;temp32, &amp;(ddsd.ddpfPixelFormat.dwRBitMask), 32);
00383                 out32 |= temp32;
00384 
00385                 <font class="comment">// Green</font>
00386                 srcPattern = 0x00FF0000;
00387                 Bitwise::convertBitPattern(&amp;data32, &amp;srcPattern, 32,
00388                     &amp;temp32, &amp;(ddsd.ddpfPixelFormat.dwGBitMask), 32);
00389                 out32 |= temp32;
00390 
00391                 <font class="comment">// Blue</font>
00392                 srcPattern = 0x0000FF00;
00393                 Bitwise::convertBitPattern(&amp;data32, &amp;srcPattern, 32,
00394                     &amp;temp32, &amp;(ddsd.ddpfPixelFormat.dwBBitMask), 32);
00395                 out32 |= temp32;
00396 
00397                 <font class="comment">// Alpha</font>
00398                 <font class="keywordflow">if</font> (ddsd.ddpfPixelFormat.dwRGBAlphaBitMask &gt; 0)
00399                 {
00400                     srcPattern = 0x000000FF;
00401                     Bitwise::convertBitPattern(&amp;data32, &amp;srcPattern, 32,
00402                         &amp;temp32, &amp;(ddsd.ddpfPixelFormat.dwRGBAlphaBitMask), 32);
00403                     out32 |= temp32;
00404                 }
00405 
00406 
00407                 <font class="comment">// Asign results to surface pixel</font>
00408                 <font class="comment">// Write up to 4 bytes</font>
00409                 <font class="comment">// Surfaces are little-endian (low byte first)</font>
00410                 <font class="keywordflow">if</font> (ddsd.ddpfPixelFormat.dwRGBBitCount &gt;= 8)
00411                     *pSurf8++ = (BYTE)out32;
00412                 <font class="keywordflow">if</font> (ddsd.ddpfPixelFormat.dwRGBBitCount &gt;= 16)
00413                     *pSurf8++ = (BYTE)(out32 &gt;&gt; 8);
00414                 <font class="keywordflow">if</font> (ddsd.ddpfPixelFormat.dwRGBBitCount &gt;= 24)
00415                     *pSurf8++ = (BYTE)(out32 &gt;&gt; 16);
00416                 <font class="keywordflow">if</font> (ddsd.ddpfPixelFormat.dwRGBBitCount == 32)
00417                     *pSurf8++ = (BYTE)(out32 &gt;&gt; 24);
00418 
00419 
00420             }
00421 
00422         }
00423 
00424         pddsTempSurface-&gt;Unlock(NULL);
00425 
00426 
00427         <font class="comment">// Copy the temp surface to the real texture surface (first mipmap level if mipmap)</font>
00428         <font class="comment">// This will stretch the texture if required (if dest is larger because of powers of 2)</font>
00429         hr = <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;Blt( NULL, pddsTempSurface, NULL, DDBLT_WAIT, NULL );
00430         <font class="keywordflow">if</font> (FAILED(hr))
00431             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Can't blit from temp texture to final texture"</font>, <font class="stringliteral">"D3DTexture::copyMemoryToSurface"</font>);
00432 
00433 
00434         pddsTempSurface-&gt;Release();
00435 
00436     }
00437 
00438 
00439     <font class="comment">// -------------------------------------------------------------------</font>
<a name="l00440"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTextureb5">00440</a>     <font class="keywordtype">void</font> D3DTexture::generateMipMaps(<font class="keywordtype">void</font>)
00441     {
00442         <font class="comment">// Takes a surface with the mip map surfaces attached</font>
00443         <font class="comment">// and writes filtered minified versions of the texture</font>
00444         <font class="comment">// in the primary surface to the mipmaps.</font>
00445 
00446         <font class="keywordtype">int</font> iMipLvl;
00447         LPDIRECTDRAWSURFACE7 lpddsSource;
00448         LPDIRECTDRAWSURFACE7 lpddsDest;
00449         DDSCAPS2 ddsCaps;
00450         DDSURFACEDESC2 ddsd;
00451         DDSURFACEDESC2 ddsdSource, ddsdDest;
00452         DWORD totR;
00453         DWORD totG;
00454         DWORD totB;
00455         DWORD totA;
00456         DWORD avgR;
00457         DWORD avgG;
00458         DWORD avgB;
00459         DWORD avgA;
00460         HRESULT hr;
00461 
00462         <font class="comment">// Get surface desc</font>
00463         D3DUtil_InitSurfaceDesc( ddsd );
00464         hr = <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>-&gt;GetSurfaceDesc(&amp;ddsd);
00465         <font class="keywordflow">if</font> (FAILED(hr))
00466             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot get surface desc of first mipmap level."</font>,
00467                 <font class="stringliteral">"GenerateMipMaps"</font>);
00468 
00469 
00470         <font class="keywordtype">int</font> rBitShift = Bitwise::getBitShift(ddsd.ddpfPixelFormat.dwRBitMask);
00471         <font class="keywordtype">int</font> gBitShift = Bitwise::getBitShift(ddsd.ddpfPixelFormat.dwGBitMask);
00472         <font class="keywordtype">int</font> bBitShift = Bitwise::getBitShift(ddsd.ddpfPixelFormat.dwBBitMask);
00473         <font class="keywordtype">int</font> aBitShift = Bitwise::getBitShift(ddsd.ddpfPixelFormat.dwRGBAlphaBitMask);
00474 
00475         ZeroMemory(&amp;ddsCaps, <font class="keyword">sizeof</font>(DDSCAPS2));
00476         ddsCaps.dwCaps = DDSCAPS_TEXTURE | DDSCAPS_MIPMAP;
00477 
00478         <font class="comment">// Start at first level, keep going until we run out of mipmaps</font>
00479         lpddsSource = <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>;
00480         <font class="keywordflow">for</font>(iMipLvl = 0; ; iMipLvl++)
00481         {
00482             <font class="comment">// Get next mipmap level</font>
00483             hr = lpddsSource-&gt;GetAttachedSurface(&amp;ddsCaps, &amp;lpddsDest);
00484             <font class="keywordflow">if</font> (hr == DDERR_NOTFOUND) <font class="keywordflow">break</font>;
00485 
00486             lpddsDest-&gt;Release();
00487             <font class="keywordflow">if</font> (FAILED(hr))
00488                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot get mipmap surface."</font>,
00489                     <font class="stringliteral">"GenerateMipMaps"</font>);
00490 
00491             <font class="comment">// Lock source &amp; destination</font>
00492             D3DUtil_InitSurfaceDesc( ddsdSource );
00493             D3DUtil_InitSurfaceDesc( ddsdDest );
00494             hr = lpddsSource-&gt;Lock( NULL, &amp;ddsdSource, DDLOCK_WAIT, NULL );
00495             <font class="keywordflow">if</font> (FAILED(hr))
00496                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot lock source surface in mipmap creation."</font>,
00497                     <font class="stringliteral">"GenerateMipMaps"</font>);
00498             hr = lpddsDest-&gt;Lock( NULL, &amp;ddsdDest, DDLOCK_WAIT, NULL );
00499             <font class="keywordflow">if</font> (FAILED(hr))
00500                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot lock destination surface in mipmap creation."</font>,
00501                     <font class="stringliteral">"GenerateMipMaps"</font>);
00502 
00503 
00504             <font class="comment">// Loop around destination</font>
00505             <font class="comment">// Read pixels from source in groups of 4</font>
00506             <font class="keywordflow">for</font> (DWORD y = 0; y &lt; ddsdDest.dwHeight; y++)
00507             {
00508                 WORD*  psrc16 =  (WORD*)((BYTE*)ddsdSource.lpSurface + (y*2)*ddsdSource.lPitch);
00509                 DWORD* psrc32 = (DWORD*)((BYTE*)ddsdSource.lpSurface + (y*2)*ddsdSource.lPitch);
00510                 WORD*  pdest16 =  (WORD*)((BYTE*)ddsdDest.lpSurface + y*ddsdDest.lPitch);
00511                 DWORD* pdest32 = (DWORD*)((BYTE*)ddsdDest.lpSurface + y*ddsdDest.lPitch);
00512 
00513                 <font class="keywordflow">for</font> (DWORD x = 0; x &lt; ddsdDest.dwWidth; x++)
00514                 {
00515                     <font class="comment">// Get 4 pixels from source</font>
00516                     <font class="comment">// Reuse masks from previous alpha work</font>
00517                     totR = 0;
00518                     totG = 0;
00519                     totB = 0;
00520                     totA = 0;
00521                     <font class="keywordflow">if</font> (ddsdSource.ddpfPixelFormat.dwRGBBitCount == 16)
00522                     {
00523                         totR += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00524                         totG += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00525                         totB += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00526                         totA += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00527                         <font class="comment">// one to the right</font>
00528                         psrc16++;
00529                         totR += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00530                         totG += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00531                         totB += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00532                         totA += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00533                         <font class="comment">// Back to the left and down one line</font>
00534                         psrc16--;
00535                         psrc16 = (WORD*)((BYTE*)psrc16 + ddsdSource.lPitch);
00536                         totR += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00537                         totG += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00538                         totB += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00539                         totA += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00540                         <font class="comment">// One to the right</font>
00541                         psrc16++;
00542                         totR += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00543                         totG += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00544                         totB += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00545                         totA += (*psrc16 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00546                         <font class="comment">// Back up to the previous line, along one ready for next</font>
00547                         psrc16 = (WORD*)((BYTE*)psrc16 - ddsdSource.lPitch);
00548                         psrc16++;
00549 
00550 
00551                         <font class="comment">// Assign pixel</font>
00552                         avgR = ((totR / 4) &lt;&lt; rBitShift) &amp; ddsdSource.ddpfPixelFormat.dwRBitMask;
00553                         avgG = ((totG / 4) &lt;&lt; gBitShift) &amp; ddsdSource.ddpfPixelFormat.dwGBitMask;
00554                         avgB = ((totB / 4) &lt;&lt; bBitShift) &amp; ddsdSource.ddpfPixelFormat.dwBBitMask;
00555                         avgA = ((totA / 4) &lt;&lt; aBitShift) &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask;
00556                         *pdest16 = (WORD)(avgR | avgG | avgB | avgA);
00557                         pdest16++;
00558                     }
00559                     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (ddsdSource.ddpfPixelFormat.dwRGBBitCount == 32)
00560                     {
00561                         totR += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00562                         totG += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00563                         totB += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00564                         totA += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00565                         <font class="comment">// one to the right</font>
00566                         psrc32++;
00567                         totR += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00568                         totG += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00569                         totB += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00570                         totA += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00571                         <font class="comment">// Back to the left and down one line</font>
00572                         psrc32--;
00573                         psrc32 = (DWORD*)((BYTE*)psrc32 + ddsdSource.lPitch);
00574                         totR += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00575                         totG += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00576                         totB += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00577                         totA += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00578                         <font class="comment">// One to the right</font>
00579                         psrc32++;
00580                         totR += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRBitMask) &gt;&gt; rBitShift;
00581                         totG += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwGBitMask) &gt;&gt; gBitShift;
00582                         totB += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwBBitMask) &gt;&gt; bBitShift;
00583                         totA += (*psrc32 &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask) &gt;&gt; aBitShift;
00584                         <font class="comment">// Back up to the previous line, along one ready for next</font>
00585                         psrc32 = (DWORD*)((BYTE*)psrc32 - ddsdSource.lPitch);
00586                         psrc32++;
00587 
00588 
00589                         <font class="comment">// Assign pixel</font>
00590                         avgR = ((totR / 4) &lt;&lt; rBitShift) &amp; ddsdSource.ddpfPixelFormat.dwRBitMask;
00591                         avgG = ((totG / 4) &lt;&lt; gBitShift) &amp; ddsdSource.ddpfPixelFormat.dwGBitMask;
00592                         avgB = ((totB / 4) &lt;&lt; bBitShift) &amp; ddsdSource.ddpfPixelFormat.dwGBitMask;
00593                         avgA = ((totA / 4) &lt;&lt; aBitShift) &amp; ddsdSource.ddpfPixelFormat.dwRGBAlphaBitMask;
00594                         *pdest32 = (DWORD)(avgR | avgG | avgB | avgA);
00595                         pdest32++;
00596                     }
00597                 } <font class="comment">// for x</font>
00598 
00599             } <font class="comment">// for y</font>
00600 
00601             <font class="comment">// Unlock surfaces</font>
00602             lpddsSource-&gt;Unlock(NULL);
00603             lpddsDest-&gt;Unlock(NULL);
00604 
00605             <font class="comment">// Move to next level</font>
00606             lpddsSource = lpddsDest;
00607 
00608         } <font class="comment">// for iMipLvl</font>
00609 
00610 
00611     }
00612 
<a name="l00613"></a><a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturea6">00613</a>     LPDIRECTDRAWSURFACE7 D3DTexture::getDDSurface(<font class="keywordtype">void</font>)
00614     {
00615         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DTexture.html#Ogre_1_1D3DTexturen1">mSurface</a>;
00616     }
00617 }
00618 
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
