<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreD3D7Device.cpp</h1><a href="OgreD3D7Device_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreD3D7RenderSystem_8h.html">OgreD3D7RenderSystem.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreD3D7Device_8h.html">OgreD3D7Device.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreDDDriver_8h.html">OgreDDDriver.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreDDVideoMode_8h.html">OgreDDVideoMode.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreLight_8h.html">OgreLight.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreCamera_8h.html">OgreCamera.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00033 
00034 <font class="keyword">namespace </font>Ogre {
00035 
<a name="l00036"></a><a class="code" href="namespaceOgre.html#a410">00036</a>     <font class="keyword">static</font> HRESULT CALLBACK <a class="code" href="namespaceOgre.html#a410">EnumZBuffersCallback</a>(DDPIXELFORMAT* pddpf,
00037             VOID* pFormats)
00038     {
00039         <font class="comment">// Add to list of formats</font>
00040         std::vector&lt;DDPIXELFORMAT&gt; *vec;
00041         vec = (std::vector&lt;DDPIXELFORMAT&gt;*)pFormats;
00042 
00043         <font class="keywordflow">if</font> (pddpf-&gt;dwFlags &amp; DDPF_ZBUFFER)
00044             vec-&gt;push_back(*pddpf);
00045         <font class="keywordflow">return</font> D3DENUMRET_OK;
00046 
00047     }
00048 
00049 
00050 
00051 
<a name="l00052"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea8">00052</a>     <a class="code" href="classOgre_1_1D3DDevice.html">D3DDevice</a> D3DDevice::operator=(<font class="keyword">const</font> <a class="code" href="classOgre_1_1D3DDevice.html">D3DDevice</a> &amp;orig)
00053     {
00054 
00055 
00056         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a> = orig.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a>;
00057         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a> = orig.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a>;
00058         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a> = orig.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>;
00059         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a> = orig.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a>;
00060         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a> = orig.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a>;
00061 
00062 
00063         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00064 
00065     }
00066 
00067     <font class="comment">// Default constructor</font>
<a name="l00068"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea0">00068</a>     D3DDevice::D3DDevice()
00069     {
00070         <font class="comment">// Init pointers</font>
00071         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a> = NULL;
00072 
00073     }
00074 
00075     <font class="comment">// Copy Constructor</font>
<a name="l00076"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea1">00076</a>     D3DDevice::D3DDevice(<font class="keyword">const</font> <a class="code" href="classOgre_1_1D3DDevice.html">D3DDevice</a> &amp;ob)
00077     {
00078         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a>;
00079         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo7">mViewport</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo7">mViewport</a>;
00080         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a>;
00081         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a>;
00082         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>;
00083         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a>;
00084         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a> = ob.<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a>;
00085 
00086     }
00087 
00088     <font class="comment">// Enum constructor</font>
<a name="l00089"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea2">00089</a>     D3DDevice::D3DDevice(LPDIRECT3D7 lpDirect3D, LPSTR lpDeviceDesc, LPSTR lpDeviceName,
00090                     LPD3DDEVICEDESC7 lpD3DDeviceDesc)
00091     {
00092         <font class="comment">// Init pointers</font>
00093         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a> = NULL;
00094 
00095         <font class="comment">// Copy pointer to Direct3D7 interface</font>
00096         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a> = lpDirect3D;
00097 
00098         <font class="comment">// Copy Name and Description</font>
00099         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a> = lpDeviceDesc;
00100         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a> = lpDeviceName;
00101 
00102         <font class="comment">// Is this a hardware or emulation device?</font>
00103         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a> = ( 0 != (lpD3DDeviceDesc-&gt;dwDevCaps &amp; D3DDEVCAPS_HWRASTERIZATION) );
00104 
00105 
00106         <font class="comment">// Copy device description</font>
00107         <font class="comment">// No need to differentiate between SW and HW anymore</font>
00108         memcpy(&amp;<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>, lpD3DDeviceDesc, <font class="keyword">sizeof</font>(D3DDEVICEDESC7));
00109 
00110         <font class="keywordtype">char</font> msg[255];
00111         sprintf(msg, <font class="stringliteral">"Detected Direct3D Device %s."</font>, lpDeviceDesc);
00112         LogManager::getSingleton().logMessage(msg);
00113         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea5">logCaps</a>();
00114 
00115         <font class="comment">// Do we need a Z Buffer?</font>
00116         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a> = !(<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwRasterCaps &amp; D3DPRASTERCAPS_ZBUFFERLESSHSR);
00117         <font class="keywordflow">if</font> (mNeedsZBuffer)
00118             sprintf(msg, <font class="stringliteral">"This device needs a Z-Buffer"</font>);
00119         <font class="keywordflow">else</font>
00120             sprintf(msg, <font class="stringliteral">"This device does not need a Z-Buffer"</font>);
00121 
00122         LogManager::getSingleton().logMessage(msg);
00123 
00124 
00125 
00126 
00127 
00128     }
00129 
<a name="l00130"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea3">00130</a>     D3DDevice::~D3DDevice()
00131     {
00132     }
00133 
<a name="l00134"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea6">00134</a>     LPDIRECT3DDEVICE7 D3DDevice::createDevice(LPDIRECTDRAWSURFACE7 renderTarget)
00135     {
00136         LPDIRECT3DDEVICE7 dev;
00137         HRESULT hr;
00138 
00139         hr = <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a>-&gt;CreateDevice(<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.deviceGUID, renderTarget, &amp;dev);
00140         <font class="keywordflow">if</font>(FAILED(hr))
00141             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating new D3D device."</font>,
00142             <font class="stringliteral">"D3DDevice::createDevice"</font>);
00143 
00144         <font class="keywordflow">return</font> dev;
00145 
00146     }
00147 
<a name="l00148"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea7">00148</a>     LPDIRECT3D7 D3DDevice::getID3D(<font class="keywordtype">void</font>)
00149     {
00150         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a>;
00151     }
00152 
00153 
<a name="l00154"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea11">00154</a>     <font class="keywordtype">bool</font> D3DDevice::HardwareAccelerated(<font class="keywordtype">void</font>)
00155     {
00156         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo3">mIsHardwareAccelerated</a>;
00157     }
00158 
<a name="l00159"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea5">00159</a>     <font class="keywordtype">void</font> D3DDevice::logCaps(<font class="keywordtype">void</font>)
00160     {
00161         <font class="comment">// Sends capabilities of this driver to the log</font>
00162         <font class="keywordtype">char</font> msg[255];
00163 
00164         LogManager::getSingleton().logMessage(<font class="stringliteral">"Direct3D Device Capabilities:"</font>);
00165 
00166         sprintf(msg, <font class="stringliteral">"  Hardware Accelerated: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea11">HardwareAccelerated</a>());
00167         LogManager::getSingleton().logMessage(msg);
00168 
00169         sprintf(msg, <font class="stringliteral">"  Mipmapping: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea20">CanMipMap</a>());
00170         LogManager::getSingleton().logMessage(msg);
00171 
00172         sprintf(msg, <font class="stringliteral">"  Bilinear Filtering: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea21">CanBilinearFilter</a>());
00173         LogManager::getSingleton().logMessage(msg);
00174 
00175         sprintf(msg, <font class="stringliteral">"  Trilinear Filtering: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea22">CanTrilinearFilter</a>());
00176         LogManager::getSingleton().logMessage(msg);
00177 
00178         sprintf(msg, <font class="stringliteral">"  Hardware Transform &amp; Light: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea25">CanHWTransformAndLight</a>());
00179         LogManager::getSingleton().logMessage(msg);
00180 
00181         sprintf(msg, <font class="stringliteral">"  Max rendering colour depth: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea23">RenderBitDepth</a>());
00182         LogManager::getSingleton().logMessage(msg);
00183 
00184         sprintf(msg, <font class="stringliteral">"  Max single-pass texture layers: %i"</font>, <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea26">MaxSinglePassTextureLayers</a>());
00185         LogManager::getSingleton().logMessage(msg);
00186 
00187         sprintf(msg, <font class="stringliteral">"  Pixel fog supported: %i"</font>, ( <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwRasterCaps &amp; D3DPRASTERCAPS_FOGTABLE ) );
00188         LogManager::getSingleton().logMessage(msg);
00189 
00190         sprintf(msg, <font class="stringliteral">"  Vertex fog supported: %i"</font>, ( <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwRasterCaps &amp; D3DPRASTERCAPS_FOGVERTEX) );
00191         LogManager::getSingleton().logMessage(msg);
00192 
00193 
00194 
00195     }
00196 
00197 
<a name="l00198"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea4">00198</a>     <font class="keywordtype">void</font> D3DDevice::Cleanup(<font class="keywordtype">void</font>)
00199     {
00200         <font class="comment">// Release DirectX Objects</font>
00201 
00202         <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a> = NULL;
00203     }
00204 
00205 
<a name="l00206"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicec0">00206</a>     <font class="keywordtype">void</font> D3DDevice::createViewport(<font class="keywordtype">void</font>)
00207     {
00208         <font class="comment">/*</font>
00209 <font class="comment">        HRESULT hr;</font>
00210 <font class="comment">        char msg[255];</font>
00211 <font class="comment">        sprintf(msg, "Creating Direct3D Viewport For %s.", mDeviceDescription.c_str());</font>
00212 <font class="comment">        LogManager::getSingleton().logMessage(msg);</font>
00213 <font class="comment"></font>
00214 <font class="comment">        // Create the viewport (D3D interface)</font>
00215 <font class="comment">        // No need to create from device anymore</font>
00216 <font class="comment"></font>
00217 <font class="comment">        // Set size (based on render target surface)</font>
00218 <font class="comment">        setViewportSize();</font>
00219 <font class="comment"></font>
00220 <font class="comment">        // Set current viewport for device</font>
00221 <font class="comment">        hr = lpD3DDevice-&gt;SetViewport(&amp;mViewport);</font>
00222 <font class="comment">        if FAILED(hr)</font>
00223 <font class="comment">            throw Exception(hr, "Error setting current viewport for device", "D3DDevice - setActive");</font>
00224 <font class="comment"></font>
00225 <font class="comment">        LogManager::getSingleton().logMessage("Viewport Created OK");</font>
00226 <font class="comment"></font>
00227 <font class="comment">        // Set up initial camera position</font>
00228 <font class="comment">        //mCamera = new CCamera(this);</font>
00229 <font class="comment">        //mCamera-&gt;setLocation(0.0f,0.0f,-10.0f);</font>
00230 <font class="comment">        //mCamera-&gt;setTarget(0.0f,0.0f,0.0f);</font>
00231 <font class="comment"></font>
00232 <font class="comment">        */</font>
00233     }
00234 
<a name="l00235"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicec1">00235</a>     <font class="keywordtype">void</font> D3DDevice::setViewportSize(<font class="keywordtype">void</font>)
00236     {
00237 
00238         <font class="comment">/*</font>
00239 <font class="comment">        DDSURFACEDESC2 renderDesc;</font>
00240 <font class="comment">        HRESULT hr;</font>
00241 <font class="comment">        // Get surface desc of render target</font>
00242 <font class="comment">        renderDesc.dwSize = sizeof(DDSURFACEDESC2);</font>
00243 <font class="comment">        hr = lpRenderTarget-&gt;GetSurfaceDesc(&amp;renderDesc);</font>
00244 <font class="comment"></font>
00245 <font class="comment"></font>
00246 <font class="comment">        if FAILED(hr)</font>
00247 <font class="comment">            throw Exception(hr, "Error getting render target surface description", "D3DDevice - setActive");</font>
00248 <font class="comment"></font>
00249 <font class="comment">        // Set viewport to match the surface</font>
00250 <font class="comment">        mViewport.dwX            = 0;</font>
00251 <font class="comment">        mViewport.dwY            = 0;</font>
00252 <font class="comment">        mViewport.dwWidth      = renderDesc.dwWidth;</font>
00253 <font class="comment">        mViewport.dwHeight     = renderDesc.dwHeight;</font>
00254 <font class="comment">        mViewport.dvMinZ       = 0.0f;</font>
00255 <font class="comment">        mViewport.dvMaxZ       = 1.0f;</font>
00256 <font class="comment"></font>
00257 <font class="comment"></font>
00258 <font class="comment"></font>
00259 <font class="comment">        // Set the parameters for the new viewport.</font>
00260 <font class="comment"></font>
00261 <font class="comment">        // Store viewport sizes</font>
00262 <font class="comment">        rcViewportRect.x1 = 0;</font>
00263 <font class="comment">        rcViewportRect.x2 = renderDesc.dwWidth;</font>
00264 <font class="comment">        rcViewportRect.y1 = 0;</font>
00265 <font class="comment">        rcViewportRect.y2 = renderDesc.dwHeight;</font>
00266 <font class="comment">        */</font>
00267     }
00268 
<a name="l00269"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea14">00269</a>     <font class="keywordtype">void</font> D3DDevice::setViewMatrix(D3DMATRIX *mat)
00270     {
00271         <font class="comment">/*</font>
00272 <font class="comment">        HRESULT hr;</font>
00273 <font class="comment"></font>
00274 <font class="comment">        hr = lpD3DDevice-&gt;SetTransform(D3DTRANSFORMSTATE_VIEW, mat);</font>
00275 <font class="comment"></font>
00276 <font class="comment">        if (FAILED(hr))</font>
00277 <font class="comment">            throw Exception(hr, "Error setting view matrix.",</font>
00278 <font class="comment">                "D3DDevice - setViewMatrix");</font>
00279 <font class="comment">        */</font>
00280      }
00281 
<a name="l00282"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea15">00282</a>     <font class="keywordtype">void</font> D3DDevice::setProjectionMatrix(D3DMATRIX *mat)
00283     {
00284         <font class="comment">/*</font>
00285 <font class="comment">        HRESULT hr;</font>
00286 <font class="comment">        hr = lpD3DDevice-&gt;SetTransform(D3DTRANSFORMSTATE_PROJECTION, mat);</font>
00287 <font class="comment"></font>
00288 <font class="comment">        if (FAILED(hr))</font>
00289 <font class="comment">            throw Exception(hr, "Error setting projection matrix.",</font>
00290 <font class="comment">                "D3DDevice - setProjectionMatrix");</font>
00291 <font class="comment">        */</font>
00292     }
00293 
<a name="l00294"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea16">00294</a>     <font class="keywordtype">void</font> D3DDevice::setWorldMatrix(D3DMATRIX *mat)
00295     {
00296         <font class="comment">/*</font>
00297 <font class="comment">        HRESULT hr;</font>
00298 <font class="comment">        hr = lpD3DDevice-&gt;SetTransform(D3DTRANSFORMSTATE_WORLD, mat);</font>
00299 <font class="comment"></font>
00300 <font class="comment">        if (FAILED(hr))</font>
00301 <font class="comment">            throw Exception(hr, "Error setting world matrix.",</font>
00302 <font class="comment">                "D3DDevice - setWorldMatrix");</font>
00303 <font class="comment">        */</font>
00304     }
00305 
<a name="l00306"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea17">00306</a>     <font class="keywordtype">void</font> D3DDevice::beginScene(<font class="keywordtype">void</font>)
00307     {
00308         <font class="comment">/*</font>
00309 <font class="comment">        HRESULT hr;</font>
00310 <font class="comment"></font>
00311 <font class="comment">        // Clear viewport</font>
00312 <font class="comment">        hr = lpD3DDevice-&gt;Clear(0, NULL,</font>
00313 <font class="comment">            D3DCLEAR_TARGET | D3DCLEAR_ZBUFFER, 0x0, 1L, 0L);</font>
00314 <font class="comment">        if (FAILED(hr))</font>
00315 <font class="comment">            throw Exception(hr, "Can't clear viewport.",</font>
00316 <font class="comment">                "D3DDevice - beginScene");</font>
00317 <font class="comment"></font>
00318 <font class="comment">        // BEGIN</font>
00319 <font class="comment"></font>
00320 <font class="comment">        hr = lpD3DDevice-&gt;BeginScene();</font>
00321 <font class="comment">        if (FAILED(hr))</font>
00322 <font class="comment">            throw Exception(hr, "Can't begin scene.",</font>
00323 <font class="comment">                "D3DDevice - beginScene");</font>
00324 <font class="comment">        */</font>
00325     }
00326 
<a name="l00327"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea18">00327</a>     <font class="keywordtype">void</font> D3DDevice::endScene(<font class="keywordtype">void</font>)
00328     {
00329         <font class="comment">//lpD3DDevice-&gt;EndScene();</font>
00330     }
00331 
00332 
<a name="l00333"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea19">00333</a>     <font class="keywordtype">void</font> D3DDevice::setAmbientLight(<font class="keywordtype">float</font> r, <font class="keywordtype">float</font> g, <font class="keywordtype">float</font> b)
00334     {
00335 
00336         <font class="comment">// Just set white for now</font>
00337         <font class="comment">//HRESULT hr;</font>
00338         <font class="comment">//hr = lpD3DDevice-&gt;SetRenderState(D3DRENDERSTATE_AMBIENT, 0xffffffff );</font>
00339     }
00340 
00341 
00342 
00343 
<a name="l00344"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea9">00344</a>     <a class="code" href="classOgre_1_1String.html">String</a> D3DDevice::DeviceName(<font class="keywordtype">void</font>)
00345     {
00346         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo0">mDeviceName</a>;
00347     }
00348 
<a name="l00349"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea10">00349</a>     <a class="code" href="classOgre_1_1String.html">String</a> D3DDevice::DeviceDescription(<font class="keywordtype">void</font>)
00350     {
00351         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo1">mDeviceDescription</a>;
00352     }
00353 
00354 
<a name="l00355"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea13">00355</a>     <font class="keywordtype">void</font> D3DDevice::createDepthBuffer(LPDIRECTDRAWSURFACE7 renderTarget)
00356     {
00357         DWORD bestDepth;
00358         DDSURFACEDESC2 ddsd, src_ddsd;
00359         LPDIRECTDRAW7 lpDD7;
00360         LPDIRECTDRAWSURFACE7 lpZBuffer;
00361         HRESULT hr;
00362 
00363         LogManager::getSingleton().logMessage(<font class="stringliteral">"Direct3D - Creating Z-Buffer"</font>);
00364 
00365         <font class="comment">// First check we NEED a depth buffer - e.g. PowerVR doesn't need one</font>
00366         <font class="keywordflow">if</font> (mNeedsZBuffer)
00367         {
00368             <font class="comment">// Get description from source surface</font>
00369             ZeroMemory(&amp;src_ddsd, <font class="keyword">sizeof</font>(DDSURFACEDESC2));
00370             src_ddsd.dwSize = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00371             renderTarget-&gt;GetSurfaceDesc(&amp;src_ddsd);
00372 
00373             <font class="comment">// Enumerate Depth Buffers</font>
00374             <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo5">mDepthBufferFormats</a>.clear();
00375             <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo6">lpD3D</a>-&gt;EnumZBufferFormats(
00376                 <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.deviceGUID, 
00377                 <a class="code" href="classOgre_1_1D3DDevice.html#a410">EnumZBuffersCallback</a>, 
00378                 (LPVOID)&amp;<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo5">mDepthBufferFormats</a> );
00379 
00380             <font class="comment">// Choose the best one</font>
00381             <font class="comment">// NB make sure Z buffer is the same depth as colour buffer (GeForce TnL problem)</font>
00382             bestDepth = 0;
00383 
00384             std::vector&lt;DDPIXELFORMAT&gt;::iterator it, best_it;
00385             <font class="keywordflow">for</font>( 
00386                 it = <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo5">mDepthBufferFormats</a>.begin();
00387                 it != <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo5">mDepthBufferFormats</a>.end();
00388                 ++it )
00389             {
00390                 <font class="keywordflow">if</font>( (*it).dwZBufferBitDepth &gt; bestDepth &amp;&amp;
00391                     (*it).dwZBufferBitDepth &lt;= src_ddsd.ddpfPixelFormat.dwZBufferBitDepth )
00392                 {
00393                     best_it = it;
00394                     bestDepth = (*it).dwZBufferBitDepth;
00395                 }
00396             }
00397 
00398             <font class="comment">// Setup the surface desc for the z-buffer.</font>
00399             ZeroMemory(&amp;ddsd, <font class="keyword">sizeof</font>(DDSURFACEDESC2));
00400 
00401             ddsd.dwSize         = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00402             ddsd.dwFlags        = DDSD_CAPS|DDSD_WIDTH|DDSD_HEIGHT|DDSD_PIXELFORMAT;
00403 
00404             ddsd.dwWidth        = src_ddsd.dwWidth;
00405             ddsd.dwHeight       = src_ddsd.dwHeight;
00406 
00407             ddsd.ddsCaps.dwCaps = DDSCAPS_ZBUFFER;
00408 
00409             memcpy( &amp;ddsd.ddpfPixelFormat, &amp;(*best_it), <font class="keyword">sizeof</font>(DDPIXELFORMAT) );
00410 
00411             <font class="comment">// Software devices require system-memory depth buffers.</font>
00412             <font class="keywordflow">if</font>( mIsHardwareAccelerated )
00413                 ddsd.ddsCaps.dwCaps |= DDSCAPS_VIDEOMEMORY;
00414             <font class="keywordflow">else</font>
00415                 ddsd.ddsCaps.dwCaps |= DDSCAPS_SYSTEMMEMORY;
00416 
00417             <font class="comment">// Create the depth-buffer.</font>
00418             renderTarget-&gt;GetDDInterface( (VOID**)&amp;lpDD7 );
00419             lpDD7-&gt;Release();
00420 
00421             <font class="keywordflow">if</font>( FAILED( hr = lpDD7-&gt;CreateSurface( &amp;ddsd, &amp;lpZBuffer, NULL ) ) )
00422                 <a class="code" href="OgreException_8h.html#a0">Except</a>(
00423                     hr, 
00424                     <font class="stringliteral">"Error creating depth buffer"</font>,
00425                     <font class="stringliteral">"D3DDevice::createDepthBuffer"</font> );
00426 
00427             <font class="keywordflow">if</font>( FAILED( hr = renderTarget-&gt;AddAttachedSurface(lpZBuffer) ) )
00428                 <a class="code" href="OgreException_8h.html#a0">Except</a>(
00429                     hr, 
00430                     <font class="stringliteral">"Error attaching depth buffer to render target"</font>,
00431                     <font class="stringliteral">"D3DDevice::createDepthBuffer"</font> );
00432 
00433             LogManager::getSingleton().logMessage( 
00434                 <a class="code" href="namespaceOgre.html#a435a250">LML_NORMAL</a>, 
00435                 <font class="stringliteral">"Z-Buffer created (%i-bit)"</font>, ddsd.ddpfPixelFormat.dwZBufferBitDepth );
00436         }
00437     }
00438 
<a name="l00439"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea20">00439</a>     <font class="keywordtype">bool</font> D3DDevice::CanMipMap(<font class="keywordtype">void</font>)
00440     {
00441         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwTextureFilterCaps &amp; D3DPTFILTERCAPS_MIPNEAREST) &gt; 0;
00442     }
00443 
<a name="l00444"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea21">00444</a>     <font class="keywordtype">bool</font> D3DDevice::CanBilinearFilter(<font class="keywordtype">void</font>)
00445     {
00446         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwTextureFilterCaps &amp; D3DPTFILTERCAPS_LINEAR) &gt; 0;
00447     }
00448 
<a name="l00449"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea22">00449</a>     <font class="keywordtype">bool</font> D3DDevice::CanTrilinearFilter(<font class="keywordtype">void</font>)
00450     {
00451         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dpcTriCaps.dwTextureFilterCaps &amp; D3DPTFILTERCAPS_LINEARMIPLINEAR) &gt; 0;
00452     }
00453 
<a name="l00454"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea23">00454</a>     <font class="keywordtype">int</font> D3DDevice::RenderBitDepth(<font class="keywordtype">void</font>)
00455     {
00456 
00457         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDeviceRenderBitDepth &amp; DDBD_32)
00458             <font class="keywordflow">return</font> 32;
00459         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDeviceRenderBitDepth &amp; DDBD_24)
00460             <font class="keywordflow">return</font> 24;
00461         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDeviceRenderBitDepth &amp; DDBD_16)
00462             <font class="keywordflow">return</font> 16;
00463         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDeviceRenderBitDepth &amp; DDBD_8)
00464             <font class="keywordflow">return</font> 8;
00465         <font class="keywordflow">else</font>
00466             <font class="keywordflow">return</font> 0;
00467     }
00468 
<a name="l00469"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea24">00469</a>     <font class="keywordtype">int</font> D3DDevice::ZBufferBitDepth(<font class="keywordtype">void</font>)
00470     {
00471         <font class="keywordflow">switch</font>(<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDeviceZBufferBitDepth)
00472         {
00473         <font class="keywordflow">case</font> DDBD_8:
00474             <font class="keywordflow">return</font> 8;
00475         <font class="keywordflow">case</font> DDBD_16:
00476             <font class="keywordflow">return</font> 16;
00477         <font class="keywordflow">case</font> DDBD_24:
00478             <font class="keywordflow">return</font> 24;
00479         <font class="keywordflow">case</font> DDBD_32:
00480             <font class="keywordflow">return</font> 32;
00481         }
00482 
00483         <font class="keywordflow">return</font> 0;
00484 
00485     }
<a name="l00486"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea12">00486</a>     <font class="keywordtype">bool</font> D3DDevice::NeedsZBuffer(<font class="keywordtype">void</font>)
00487     {
00488         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo4">mNeedsZBuffer</a>;
00489     }
00490 
<a name="l00491"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea25">00491</a>     <font class="keywordtype">bool</font> D3DDevice::CanHWTransformAndLight(<font class="keywordtype">void</font>)
00492     {
00493         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.dwDevCaps &amp; D3DDEVCAPS_HWTRANSFORMANDLIGHT) &gt; 0;
00494     }
00495 
<a name="l00496"></a><a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea26">00496</a>     <font class="keywordtype">int</font> D3DDevice::MaxSinglePassTextureLayers(<font class="keywordtype">void</font>)
00497     {
00498         <font class="comment">// The maximum number of texture layers the device can support in a singe pass</font>
00499 
00500         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDeviceo2">mD3DDeviceDesc</a>.wMaxSimultaneousTextures;
00501     }
00502 
00503 
00504 } <font class="comment">// Namespace</font>
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
