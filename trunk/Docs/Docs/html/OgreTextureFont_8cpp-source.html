<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreTextureFont.cpp</h1><a href="OgreTextureFont_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">(Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 
00026 <font class="preprocessor">#include "<a class="code" href="OgreTextureFont_8h.html">OgreTextureFont.h</a>"</font>
00027 
00028 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreString_8h.html">OgreString.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreTextureManager_8h.html">OgreTextureManager.h</a>"</font>
00032 
00033 <font class="preprocessor">#include &lt;ft2build.h&gt;</font>
00034 <font class="preprocessor">#include FT_FREETYPE_H</font>
00035 <font class="preprocessor"></font><font class="preprocessor">#include FT_GLYPH_H</font>
00036 <font class="preprocessor"></font>
00037 <font class="keyword">namespace </font>Ogre {
00038 
<a name="l00039"></a><a class="code" href="namespaceOgre.html#a391">00039</a>     <font class="keywordtype">void</font> <a class="code" href="namespaceOgre.html#a391">renderTexString</a>( 
00040         std::vector&lt; FT_Glyph &gt;&amp; glyphs, 
00041         std::vector&lt; FT_Vector &gt;&amp; vectors,    
00042         byte *pTex, 
00043         <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, 
00044         <font class="keywordtype">unsigned</font> uBitR, <font class="keywordtype">unsigned</font> uBitW, 
00045         <font class="keywordtype">unsigned</font> uStartX, <font class="keywordtype">unsigned</font> uStartY )
00046     {
00047         <font class="comment">// UNDONE implement renderTexString</font>
00048     }
00049 
<a name="l00050"></a><a class="code" href="namespaceOgre.html#a392">00050</a>     <font class="keywordtype">void</font> <a class="code" href="namespaceOgre.html#a392">renderTexChar</a>( byte *pBuffer, byte *pTex, <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, <font class="keywordtype">unsigned</font> uBitR, <font class="keywordtype">unsigned</font> uBitW, <font class="keywordtype">unsigned</font> uStartX, <font class="keywordtype">unsigned</font> uStartY )
00051     {
00052         <font class="keyword">typedef</font> byte pixel[3];
00053         pixel *pLocalTex = (pixel *)pTex;
00054         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *pLocalBuff = pBuffer;
00055 
00056         <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> i = 0; i &lt; uBitR; i++ )
00057         {
00058             <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> j = 0; j &lt; uBitW; j++ )
00059             {
00060                 <font class="keywordflow">if</font>( *pLocalBuff )
00061                 {
00062                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[0] = 
00063                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[1] = 
00064                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[2] = *pLocalBuff;                
00065                 }
00066                 pLocalBuff++;
00067             }
00068         }
00069     }
00070 
<a name="l00071"></a><a class="code" href="namespaceOgre.html#a393">00071</a>     <font class="keywordtype">void</font> <a class="code" href="namespaceOgre.html#a393">renderAlphaChar</a>( byte *pBuffer, byte *pTex, <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, <font class="keywordtype">unsigned</font> uBitR, <font class="keywordtype">unsigned</font> uBitW, <font class="keywordtype">unsigned</font> uStartX, <font class="keywordtype">unsigned</font> uStartY, <font class="keywordtype">unsigned</font> cRed, <font class="keywordtype">unsigned</font> cGreen, <font class="keywordtype">unsigned</font> cBlue )
00072     {
00073         <font class="keyword">typedef</font> byte pixel[4];
00074         pixel *pLocalTex = (pixel *)pTex;
00075         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *pLocalBuff = pBuffer;
00076 
00077         <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> i = 0; i &lt; uBitR; i++ )
00078         {
00079             <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> j = 0; j &lt; uBitW; j++ )
00080             {
00081                 <font class="keywordflow">if</font>( *pLocalBuff )
00082                 {
00083                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[0] = cRed;
00084                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[1] = cGreen;
00085                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[2] = cBlue;
00086                     (*( pLocalTex + ( ( uStartY + i ) * uTexY + uStartX + j )))[3] = *pLocalBuff;                
00087                 }
00088                 pLocalBuff++;
00089             }
00090         }
00091     }
00092 
<a name="l00093"></a><a class="code" href="namespaceOgre.html#a394">00093</a>     <font class="keywordtype">void</font> <a class="code" href="namespaceOgre.html#a394">renderAlphaString</a>( 
00094         std::list&lt; FT_Glyph &gt;&amp; glyphs, 
00095         std::list&lt; FT_Vector &gt;&amp; vectors,
00096         byte *pTex, 
00097         <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, 
00098         <font class="keywordtype">unsigned</font> uStartX, <font class="keywordtype">unsigned</font> uStartY, 
00099         <font class="keywordtype">unsigned</font> cRed, <font class="keywordtype">unsigned</font> cGreen, <font class="keywordtype">unsigned</font> cBlue  )
00100     {
00101         std::list&lt; FT_Glyph &gt;::iterator it1 = glyphs.begin();
00102         std::list&lt; FT_Vector &gt;::iterator it2 = vectors.begin();
00103 
00104         <font class="keywordflow">for</font>( ; it1 != glyphs.end(); ++it1, ++it2 )
00105         {
00106             FT_Glyph  image;
00107             FT_Vector pen;
00108 
00109             image = (*it1);
00110 
00111             pen.x = uStartX + (*it2).x;
00112             pen.y = uStartY + (*it2).y;
00113 
00114             <font class="keywordflow">if</font>( !FT_Glyph_To_Bitmap( &amp;image, ft_render_mode_normal, &amp;pen, 0 ) )
00115             {
00116                 FT_BitmapGlyph  bit = (FT_BitmapGlyph)image;            
00117                 <a class="code" href="namespaceOgre.html#a393">renderAlphaChar</a>( 
00118                     bit-&gt;bitmap.buffer, 
00119                     pTex, 
00120                     uTexX, uTexY, 
00121                     bit-&gt;bitmap.rows, bit-&gt;bitmap.width, 
00122                     pen.x, pen.y, cRed, cGreen, cBlue );
00123                 FT_Done_Glyph( image );
00124             }
00125         }
00126     }
00127 
<a name="l00128"></a><a class="code" href="namespaceOgre.html#a395">00128</a>     <font class="keywordtype">void</font> <a class="code" href="namespaceOgre.html#a395">computeBBox</a>( FT_BBox&amp; bbox, std::list&lt; FT_Glyph &gt;&amp; glyphList, std::list&lt; FT_Vector &gt;&amp; vectorList )
00129     {
00130         bbox.xMin = bbox.yMin = 32000;
00131         bbox.xMax = bbox.yMax = -32000;
00132 
00133         <font class="comment">// for each glyph image, compute its bounding box, translate it,</font>
00134         <font class="comment">// and grow the string bbox</font>
00135         std::list&lt; FT_Glyph &gt;::iterator it1 = glyphList.begin();
00136         std::list&lt; FT_Vector &gt;::iterator it2 = vectorList.begin();    
00137         <font class="keywordflow">for</font>( ; it1 != glyphList.end(); ++it1, ++it2 )
00138         {
00139             FT_BBox   glyph_bbox;
00140 
00141             FT_Glyph_Get_CBox( (*it1), ft_glyph_bbox_pixels, &amp;glyph_bbox );
00142 
00143             glyph_bbox.xMin += (*it2).x;
00144             glyph_bbox.xMax += (*it2).x;
00145             glyph_bbox.yMin += (*it2).y;
00146             glyph_bbox.yMax += (*it2).y;
00147 
00148             <font class="keywordflow">if</font> (glyph_bbox.xMin &lt; bbox.xMin)
00149                 bbox.xMin = glyph_bbox.xMin;
00150 
00151             <font class="keywordflow">if</font> (glyph_bbox.yMin &lt; bbox.yMin)
00152                 bbox.yMin = glyph_bbox.yMin;
00153 
00154             <font class="keywordflow">if</font> (glyph_bbox.xMax &gt; bbox.xMax)
00155                 bbox.xMax = glyph_bbox.xMax;
00156 
00157             <font class="keywordflow">if</font> (glyph_bbox.yMax &gt; bbox.yMax)
00158                 bbox.yMax = glyph_bbox.yMax;
00159         }
00160 
00161         <font class="comment">// check that we really grew the string bbox</font>
00162         <font class="keywordflow">if</font> ( bbox.xMin &gt; bbox.xMax )
00163         {
00164             bbox.xMin = 0;
00165             bbox.yMin = 0;
00166             bbox.xMax = 0;
00167             bbox.yMax = 0;
00168         }
00169     }
00170 
00171     <font class="comment">//-----------------------------------------------------------------------------</font>
<a name="l00172"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq1">00172</a>     std::map&lt; String, std::map&lt; String, TextureFont * &gt; &gt; TextureFont::ms_mapFonts;
<a name="l00173"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">00173</a>     FT_Library *TextureFont::ms_pLibrary = NULL;
<a name="l00174"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq2">00174</a>     <font class="keywordtype">unsigned</font> TextureFont::ms_uNumFonts = 0;
00175 
<a name="l00176"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta0">00176</a>     TextureFont::TextureFont()
00177     {
00178         <font class="keywordflow">if</font>( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> == NULL )
00179         {
00180             <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> = <font class="keyword">new</font> FT_Library;
00181             <font class="keywordflow">if</font>( FT_Init_FreeType( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> ) )
00182             {
00183                 <a class="code" href="OgreException_8h.html#a0">Except</a>( 
00184                     Exception::ERR_INTERNAL_ERROR, 
00185                     <font class="stringliteral">"Could not initialize FreeType library!"</font>, 
00186                     <font class="stringliteral">"TextureFont::loadFromFile"</font> );
00187             }
00188             FT_Int iMaj, iMin, iRev;
00189             FT_Library_Version( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a>, &amp;iMaj, &amp;iMin, &amp;iRev );
00190             LogManager::getSingleton().logMessage( <a class="code" href="namespaceOgre.html#a435a250">LML_NORMAL</a>, <font class="stringliteral">"Initialized FreeType version %d.%d.%d"</font>, iMaj, iMin, iRev );
00191             <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq2">ms_uNumFonts</a>++;
00192         }
00193 
00194         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> = NULL;
00195     }
00196 
<a name="l00197"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta1">00197</a>     TextureFont::TextureFont( <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strFontFile )
00198     {
00199         <font class="keywordflow">if</font>( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> == NULL )
00200         {
00201             <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> = <font class="keyword">new</font> FT_Library;
00202             <font class="keywordflow">if</font>( FT_Init_FreeType( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> ) )
00203             {
00204                 <a class="code" href="OgreException_8h.html#a0">Except</a>( 
00205                     Exception::ERR_INTERNAL_ERROR, 
00206                     <font class="stringliteral">"Could not initialize FreeType library!"</font>, 
00207                     <font class="stringliteral">"TextureFont::loadFromFile"</font> );
00208             }
00209             FT_Int iMaj, iMin, iRev;
00210             FT_Library_Version( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a>, &amp;iMaj, &amp;iMin, &amp;iRev );
00211             LogManager::getSingleton().logMessage( <a class="code" href="namespaceOgre.html#a435a250">LML_NORMAL</a>, <font class="stringliteral">"Initialized FreeType version %d.%d.%d"</font>, iMaj, iMin, iRev );
00212             <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq2">ms_uNumFonts</a>++;
00213         }
00214 
00215         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> = NULL;
00216 
00217         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta2">loadFromFile</a>( strFontFile );
00218     }
00219 
<a name="l00220"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta2">00220</a>     <font class="keywordtype">void</font> TextureFont::loadFromFile( <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strFontFile )
00221     {
00222         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> = <font class="keyword">new</font> FT_Face;
00223         <font class="keywordflow">if</font>( FT_New_Face( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a>, strFontFile.c_str(), 0, <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> ) )
00224         {
00225             <a class="code" href="OgreException_8h.html#a0">Except</a>( 
00226                 Exception::ERR_INTERNAL_ERROR, 
00227                 <font class="stringliteral">"Could not create font face from file '"</font> + strFontFile + <font class="stringliteral">"'!"</font>, 
00228                 <font class="stringliteral">"TextureFont::loadFromFile"</font> );
00229         }
00230 
00231         <font class="comment">// delete old font mapping if exists</font>
00232         <font class="keywordflow">if</font>( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq1">ms_mapFonts</a>[(*m_pFace)-&gt;family_name][(*m_pFace)-&gt;style_name] != NULL )
00233             <font class="keyword">delete</font> <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq1">ms_mapFonts</a>[(*m_pFace)-&gt;family_name][(*m_pFace)-&gt;style_name];
00234 
00235         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq1">ms_mapFonts</a>[(*m_pFace)-&gt;family_name][(*m_pFace)-&gt;style_name] = <font class="keyword">this</font>;
00236     }
00237 
<a name="l00238"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta3">00238</a>     TextureFont::~TextureFont()
00239     {
00240         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq1">ms_mapFonts</a>[(*m_pFace)-&gt;family_name][(*m_pFace)-&gt;style_name] = NULL;
00241 
00242         FT_Done_Face( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> );
00243         <font class="keyword">delete</font> <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>; <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> = NULL;
00244         <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq2">ms_uNumFonts</a>--;
00245 
00246         <font class="keywordflow">if</font>( ms_uNumFonts )
00247             FT_Done_FreeType( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontq0">ms_pLibrary</a> );
00248     }
00249 
<a name="l00250"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta4">00250</a>     <font class="keywordtype">void</font> TextureFont::createTexture( <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strTexName, <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strString, <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, <font class="keywordtype">unsigned</font> uFontX <font class="comment">/* = 600 */</font>, <font class="keywordtype">unsigned</font> uFontY <font class="comment">/* = 0 */</font>, <font class="keywordtype">unsigned</font> uFontResX <font class="comment">/* = 72 */</font>, <font class="keywordtype">unsigned</font> uFontResY <font class="comment">/* = 0 */</font>, <font class="keywordtype">unsigned</font> uStartX <font class="comment">/* = 1 */</font>, <font class="keywordtype">unsigned</font> uStartY <font class="comment">/* = 1  */</font> )
00251     {
00252         <font class="keyword">typedef</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> pixel[3];
00253         pixel *pTexture = <font class="keyword">new</font> pixel[ uTexY * uTexX ];
00254 
00255         FT_Bool       use_kerning;
00256         FT_UInt       previous;
00257         FT_UInt       glyph_index;
00258         FT_UInt       pen_x, pen_y, pen_dx, pen_dy;
00259         FT_GlyphSlot  slot;
00260 
00261         <font class="comment">// make sure face is loaded</font>
00262         assert( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> );
00263 
00264         <font class="comment">// clear texture</font>
00265         memset( pTexture, 0, uTexX * uTexY * <font class="keyword">sizeof</font>( pixel ) );
00266 
00267         use_kerning = FT_HAS_KERNING( (*<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>) );
00268         previous    = 0;
00269         
00270         <font class="keywordflow">if</font>( FT_Set_Char_Size( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, uFontX, uFontY, uFontResX, uFontResY ) )
00271         {
00272             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00273                 Exception::ERR_INTERNAL_ERROR,
00274                 <font class="stringliteral">"Could not set font size!"</font>,
00275                 <font class="stringliteral">"TextureFont::createTexture"</font> );
00276         }
00277 
00278         pen_x = uStartX;
00279         pen_y = uStartY + ( (*m_pFace)-&gt;size-&gt;metrics.ascender &gt;&gt; 6 );
00280 
00281         <font class="keywordflow">for</font>( size_t i = 0; i &lt; strString.length(); i++ )
00282         {
00283             <font class="keywordflow">if</font>( strString.at( i ) == <font class="charliteral">'\n'</font> )
00284             {
00285                 previous = 0;
00286                 pen_x = uStartX;
00287                 pen_y += (*m_pFace)-&gt;size-&gt;metrics.height &gt;&gt; 6;
00288                 <font class="keywordflow">continue</font>;
00289             }
00290 
00291             glyph_index = FT_Get_Char_Index( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, strString.at(i) );        
00292             FT_Load_Char( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, (<font class="keywordtype">long</font>)strString.at(i), FT_LOAD_RENDER );
00293             slot = (*m_pFace)-&gt;glyph;
00294 
00295             <font class="keywordflow">if</font>( use_kerning &amp;&amp; previous &amp;&amp; glyph_index )
00296             {
00297                 FT_Vector  delta;
00298                 FT_Get_Kerning( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, previous, glyph_index, 0, &amp;delta );
00299                 pen_x += delta.x &gt;&gt; 6;
00300             }
00301 
00302             <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *pChar = slot-&gt;bitmap.buffer;
00303 
00304             FT_Int j, k;
00305             pen_dx = pen_x + slot-&gt;bitmap_left;
00306             pen_dy = pen_y - slot-&gt;bitmap_top;
00307 
00308             <font class="comment">// if we're getting off the drawing area, go down a line</font>
00309             <font class="keywordflow">if</font>( slot-&gt;bitmap.width + pen_dx &gt;= uTexX )
00310             {
00311                 previous = 0;
00312                 pen_x = 1;
00313                 pen_y += (*m_pFace)-&gt;size-&gt;metrics.height &gt;&gt; 6;
00314                 i--;
00315                 <font class="keywordflow">continue</font>;
00316             }
00317 
00318             <a class="code" href="namespaceOgre.html#a392">renderTexChar</a>( 
00319                 slot-&gt;bitmap.buffer, 
00320                 (byte *)&amp;pTexture[0][0], 
00321                 uTexX, uTexY, 
00322                 slot-&gt;bitmap.rows, slot-&gt;bitmap.width, 
00323                 pen_dx, pen_dy );        
00324 
00325             pen_x += slot-&gt;advance.x &gt;&gt; 6;
00326         }
00327 
00328         <a class="code" href="classOgre_1_1Image.html">Image</a> img;
00329         img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea6">loadRawData</a>( 
00330             <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>( pTexture, uTexX * uTexY * 3 ), 
00331             uTexX, uTexY, Image::FMT_RGB );
00332         TextureManager::getSingleton().loadImage( strTexName, img );    
00333 
00334         <font class="keyword">delete</font> [] pTexture;
00335     }
00336 
<a name="l00337"></a><a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFonta5">00337</a>     <font class="keywordtype">void</font> TextureFont::createAlphaMask( <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strTexName, <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; strString, <font class="keywordtype">unsigned</font> uTexX, <font class="keywordtype">unsigned</font> uTexY, byte cRed, byte cGreen, byte cBlue, <font class="keywordtype">unsigned</font> uFontX <font class="comment">/* = 600 */</font>, <font class="keywordtype">unsigned</font> uFontY <font class="comment">/* = 0 */</font>, <font class="keywordtype">unsigned</font> uFontResX <font class="comment">/* = 72 */</font>, <font class="keywordtype">unsigned</font> uFontResY <font class="comment">/* = 0 */</font>, <font class="keywordtype">unsigned</font> uStartX <font class="comment">/* = 1 */</font>, <font class="keywordtype">unsigned</font> uStartY <font class="comment">/* = 1  */</font> )
00338     {
00339         <font class="keyword">typedef</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> pixel[4];
00340         pixel *pTexture = <font class="keyword">new</font> pixel[ uTexY * uTexX ];
00341 
00342         FT_Bool       use_kerning;
00343         FT_UInt       previous;
00344         FT_UInt       glyph_index;
00345         FT_UInt       pen_x, pen_y, pen_dx, pen_dy;
00346         FT_GlyphSlot  slot;
00347 
00348         std::list&lt; FT_Glyph &gt; glyphs;
00349         std::list&lt; FT_Vector &gt; vectors;
00350 
00351         <font class="comment">// make sure face is loaded</font>
00352         assert( <a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a> );
00353 
00354         <font class="comment">// clear texture</font>
00355         memset( pTexture, 0, uTexX * uTexY * <font class="keyword">sizeof</font>( pixel ) );
00356 
00357         use_kerning = FT_HAS_KERNING( (*<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>) );
00358         previous    = 0;
00359 
00360         <font class="keywordflow">if</font>( FT_Set_Char_Size( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, uFontX, uFontY, uFontResX, uFontResY ) )
00361         {
00362             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00363                 Exception::ERR_INTERNAL_ERROR,
00364                 <font class="stringliteral">"Could not set font size!"</font>,
00365                 <font class="stringliteral">"TextureFont::createTexture"</font> );
00366         }
00367 
00368         pen_x = uStartX;
00369         pen_y = uStartY + ( (*m_pFace)-&gt;size-&gt;metrics.ascender &gt;&gt; 6 );
00370 
00371         <font class="keywordflow">for</font>( size_t i = 0; i &lt; strString.length(); i++ )
00372         {
00373             FT_Vector diff;
00374             FT_Glyph lett;
00375             
00376             glyph_index = FT_Get_Char_Index( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, strString.at(i) );                
00377             slot = (*m_pFace)-&gt;glyph;
00378 
00379             <font class="keywordflow">if</font>( use_kerning &amp;&amp; previous &amp;&amp; glyph_index )
00380             {
00381                 FT_Vector  delta;
00382                 FT_Get_Kerning( *<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>, previous, glyph_index, 0, &amp;delta );
00383                 pen_x += delta.x &gt;&gt; 6;
00384             }        
00385             diff.x = pen_x;
00386             diff.y = pen_y;        
00387 
00388             FT_Load_Glyph( (*<a class="code" href="classOgre_1_1TextureFont.html#Ogre_1_1TextureFontn0">m_pFace</a>), glyph_index, FT_LOAD_DEFAULT );
00389             FT_Get_Glyph( (*m_pFace)-&gt;glyph, &amp;(lett) );
00390 
00391             glyphs.push_back( lett );
00392             vectors.push_back( diff );        
00393 
00394             pen_x += slot-&gt;advance.x &gt;&gt; 6;
00395         }
00396 
00397         FT_BBox bbox;
00398         <a class="code" href="namespaceOgre.html#a395">computeBBox</a>( bbox, glyphs, vectors );
00399 
00400         <font class="comment">// compute string dimensions in integer pixels</font>
00401         <font class="keywordtype">unsigned</font> string_width  = (bbox.xMax - bbox.xMin);
00402         <font class="keywordtype">unsigned</font> string_height = (bbox.yMax - bbox.yMin);
00403 
00404         <font class="comment">// compute start pen position in 26.6 cartesian pixels</font>
00405         <font class="keywordtype">unsigned</font> start_x = (( uTexX - string_width )/2);
00406         <font class="keywordtype">unsigned</font> start_y = (( uTexY - string_height)/2);
00407 
00408         <a class="code" href="namespaceOgre.html#a394">renderAlphaString</a>(
00409             glyphs,
00410             vectors,
00411             (byte*)pTexture,
00412             uTexX, uTexY,
00413             start_x, start_y,
00414             cRed, cGreen, cBlue );
00415 
00416         <a class="code" href="classOgre_1_1Image.html">Image</a> img;
00417         img.<a class="code" href="classOgre_1_1Image.html#Ogre_1_1Imagea6">loadRawData</a>( 
00418             <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>( pTexture, uTexX * uTexY * 4 ), 
00419             uTexX, uTexY, Image::FMT_RGB_ALPHA );
00420         TextureManager::getSingleton().loadImage( strTexName, img );
00421 
00422         <font class="keyword">delete</font> [] pTexture;
00423     }
00424 
00425 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
