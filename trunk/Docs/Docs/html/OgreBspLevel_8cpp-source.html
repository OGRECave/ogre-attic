<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreBspLevel.cpp</h1><a href="OgreBspLevel_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreBspLevel_8h.html">OgreBspLevel.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreQuake3Level_8h.html">OgreQuake3Level.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreBspResourceManager_8h.html">OgreBspResourceManager.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreBspNode_8h.html">OgreBspNode.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreMaterial_8h.html">OgreMaterial.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreMaterialManager_8h.html">OgreMaterialManager.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreSceneManager_8h.html">OgreSceneManager.h</a>"</font>
00033 <font class="preprocessor">#include "<a class="code" href="OgrePatchSurface_8h.html">OgrePatchSurface.h</a>"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreQuake3ShaderManager_8h.html">OgreQuake3ShaderManager.h</a>"</font>
00035 <font class="preprocessor">#include "<a class="code" href="OgreQuake3Shader_8h.html">OgreQuake3Shader.h</a>"</font>
00036 <font class="preprocessor">#include "<a class="code" href="OgreMath_8h.html">OgreMath.h</a>"</font>
00037 <font class="preprocessor">#include "<a class="code" href="OgreStringVector_8h.html">OgreStringVector.h</a>"</font>
00038 
00039 
00040 <font class="keyword">namespace </font>Ogre {
00041 
00042 
00043     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00044"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela0">00044</a>     BspLevel::BspLevel(<a class="code" href="classOgre_1_1String.html">String</a> name)
00045     {
00046         <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a> = name;
00047         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a> = 0;
00048         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a> = 0;
00049     }
00050 
00051     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00052"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela1">00052</a>     BspLevel::~BspLevel()
00053     {
00054         <font class="keywordflow">if</font> (mIsLoaded)
00055         {
00056             <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela3">unload</a>();
00057             <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn1">mIsLoaded</a> = <font class="keyword">false</font>;
00058         }
00059 
00060     }
00061 
00062     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00063"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela2">00063</a>     <font class="keywordtype">void</font> BspLevel::load()
00064     {
00065         <font class="comment">// Use Quake3 file loader</font>
00066         <a class="code" href="classOgre_1_1Quake3Level.html">Quake3Level</a> q3;
00067         <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> chunk;
00068         BspResourceManager::getSingleton()._findResourceData(<a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>, chunk);
00069 
00070         q3.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levela1">loadFromChunk</a>(chunk);
00071 
00072         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevelb0">loadQuake3Level</a>(q3);
00073 
00074         chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka4">clear</a>();
00075 
00076     }
00077 
00078     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00079"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela3">00079</a>     <font class="keywordtype">void</font> BspLevel::unload()
00080     {
00081         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>;
00082         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln10">mElements</a>;
00083         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln8">mFaceGroups</a>;
00084         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln6">mLeafFaceGroups</a>;
00085         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a>;
00086         <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam0">tableData</a>;
00087 
00088         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a> = 0;
00089         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a> = 0;
00090         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln8">mFaceGroups</a> = 0;
00091         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln6">mLeafFaceGroups</a> = 0;
00092         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln10">mElements</a> = 0;
00093     }
00094 
00095     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00096"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevelb0">00096</a>     <font class="keywordtype">void</font> BspLevel::loadQuake3Level(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Quake3Level.html">Quake3Level</a>&amp; q3lvl)
00097     {
00098         <a class="code" href="classOgre_1_1SceneManager.html">SceneManager</a>* sm = SceneManagerEnumerator::getSingleton().getSceneManager(<a class="code" href="namespaceOgre.html#a440a309">ST_INTERIOR</a>);
00099 
00100         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevelb1">loadEntities</a>(q3lvl);
00101 
00102         <font class="comment">// Parse shaders</font>
00103         Quake3ShaderManager::getSingleton().parseAllSources(<font class="stringliteral">".shader"</font>);
00104         <font class="comment">// Extract lightmaps into textures</font>
00105         q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levela2">extractLightmaps</a>();
00106 
00107         <font class="comment">//-----------------------------------------------------------------------</font>
00108         <font class="comment">// Vertices</font>
00109         <font class="comment">//-----------------------------------------------------------------------</font>
00110         <font class="comment">// Allocate memory for vertices &amp; copy</font>
00111         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln5">mNumVertices</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm20">mNumVertices</a>;
00112         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a> = <font class="keyword">new</font> <a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspVertex</a>[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln5">mNumVertices</a>];
00113         memcpy(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm19">mVertices</a>, <font class="keyword">sizeof</font>(<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspVertex</a>)*q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm20">mNumVertices</a>);
00114 
00115         <font class="comment">// Correct texture coords</font>
00116         <font class="comment">// Coords are flipped in Y axis!</font>
00117         <font class="comment">// ---WHY???---</font>
00118         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> verti = 0; verti &lt; <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln5">mNumVertices</a>; ++verti)
00119         {
00120             <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>[verti].<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html#Ogre_1_1BspLevel_1_1BspVertexm1">texcoords</a>[1]  = 1 - <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>[verti].<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html#Ogre_1_1BspLevel_1_1BspVertexm1">texcoords</a>[1];
00121             <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>[verti].<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html#Ogre_1_1BspLevel_1_1BspVertexm2">lightmap</a>[1]  = 1 - <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a>[verti].<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html#Ogre_1_1BspLevel_1_1BspVertexm2">lightmap</a>[1];
00122         }
00123 
00124         <font class="comment">//-----------------------------------------------------------------------</font>
00125         <font class="comment">// Faces</font>
00126         <font class="comment">// --------</font>
00127         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln7">mNumLeafFaceGroups</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm14">mNumLeafFaces</a>;
00128         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln6">mLeafFaceGroups</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln7">mNumLeafFaceGroups</a>];
00129         memcpy(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln6">mLeafFaceGroups</a>, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm13">mLeafFaces</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>)*<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln7">mNumLeafFaceGroups</a>);
00130         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln9">mNumFaceGroups</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm18">mNumFaces</a>;
00131         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln8">mFaceGroups</a> = <font class="keyword">new</font> <a class="code" href="structOgre_1_1StaticFaceGroup.html">StaticFaceGroup</a>[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln9">mNumFaceGroups</a>];
00132         <font class="comment">// Contents of faces are dealt with below along with materials</font>
00133         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln11">mNumElements</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm4">mNumElements</a>;
00134         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln10">mElements</a> = <font class="keyword">new</font> <font class="keywordtype">int</font>[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln11">mNumElements</a>];
00135         memcpy(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln10">mElements</a>, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm3">mElements</a>, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>)*<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln11">mNumElements</a>);
00136         <font class="comment">//-----------------------------------------------------------------------</font>
00137         <font class="comment">// Create materials for shaders</font>
00138         <font class="comment">//-----------------------------------------------------------------------</font>
00139         <font class="comment">// NB this only works for the 'default' shaders for now</font>
00140         <font class="comment">//  i.e. those that don't have a .shader script and thus default</font>
00141         <font class="comment">//  to just texture + lightmap</font>
00142         <font class="comment">// TODO: pre-parse all .shader files and create lookup for next stage (use ROGL shader_file_t)</font>
00143 
00144         <font class="comment">// Material names are shadername#lightmapnumber</font>
00145         <font class="comment">// This is because I like to define materials up front completely</font>
00146         <font class="comment">//  rather than combine lightmap and shader dynamically (it's</font>
00147         <font class="comment">//  more generic). It results in more materials, but they're small</font>
00148         <font class="comment">//  beer anyway. Texture duplication is prevented by infrastructure.</font>
00149         <font class="comment">// To do this I actually need to parse the faces since they have the</font>
00150         <font class="comment">//  shader/lightmap combo (lightmap number is not in the shader since</font>
00151         <font class="comment">//  it can be used with multiple lightmaps)</font>
00152         <font class="keywordtype">char</font> shaderName[72];
00153         <font class="keywordtype">int</font> face;
00154         face = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm18">mNumFaces</a>;
00155         <font class="keywordtype">int</font> matHandle;
00156         <font class="keywordtype">char</font> meshName[32];
00157         <a class="code" href="structOgre_1_1GeometryData.html">GeometryData</a> ctl;
00158 
00159         <font class="keywordflow">while</font>(face--)
00160         {
00161 
00162             <font class="comment">// Check to see if existing material</font>
00163             <font class="comment">// Format shader#lightmap</font>
00164             <font class="keywordtype">int</font> shadIdx = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face].<a class="code" href="structbsp__face__t.html#bsp__face__tm0">shader</a>;
00165             sprintf(shaderName, <font class="stringliteral">"%s#%d"</font>,
00166                 q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm21">mShaders</a>[shadIdx].<a class="code" href="structbsp__shader__t.html#bsp__shader__tm0">name</a>,
00167                 q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face].<a class="code" href="structbsp__face__t.html#bsp__face__tm7">lm_texture</a>);
00168 
00169             <a class="code" href="classOgre_1_1Material.html">Material</a> *shadMat = sm-&gt;<a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagera15">getMaterial</a>(shaderName);
00170             <font class="keywordflow">if</font> (shadMat == 0)
00171             {
00172                 <font class="comment">// Build new material</font>
00173                 <a class="code" href="classOgre_1_1Material.html">Material</a> mat(shaderName);
00174 
00175                 <font class="comment">// Colour layer</font>
00176                 <font class="comment">// NB no extension in Q3A(doh), have to try shader, .jpg, .tga</font>
00177                 <a class="code" href="classOgre_1_1String.html">String</a> tryName = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm21">mShaders</a>[shadIdx].<a class="code" href="structbsp__shader__t.html#bsp__shader__tm0">name</a>;
00178                 <font class="comment">// Try shader first</font>
00179                 <a class="code" href="classOgre_1_1Quake3Shader.html">Quake3Shader</a>* pShad = (<a class="code" href="classOgre_1_1Quake3Shader.html">Quake3Shader</a>*)Quake3ShaderManager::getSingleton().getByName(tryName);
00180                 <font class="keywordflow">if</font> (pShad)
00181                 {
00182                     shadMat = pShad-&gt;<a class="code" href="classOgre_1_1Quake3Shader.html#Ogre_1_1Quake3Shadera4">createAsMaterial</a>(sm, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face].<a class="code" href="structbsp__face__t.html#bsp__face__tm7">lm_texture</a>);
00183                     matHandle = shadMat-&gt;<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala4">getHandle</a>();
00184                 }
00185                 <font class="keywordflow">else</font>
00186                 {
00187                     <font class="comment">// No shader script, try default type texture</font>
00188                     <font class="comment">// Try jpg</font>
00189                     <a class="code" href="classOgre_1_1Material_1_1TextureLayer.html">Material::TextureLayer</a>* tex = mat.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala19">addTextureLayer</a>(tryName + <font class="stringliteral">".jpg"</font>);
00190                     <font class="keywordflow">if</font> (tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera49">isBlank</a>())
00191                     {
00192                         <font class="comment">// Try tga</font>
00193                         tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera7">setTextureName</a>(tryName + <font class="stringliteral">".tga"</font>);
00194                     }
00195                     <font class="comment">// Set replace on all first layer textures for now</font>
00196                     tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera32">setColourOperation</a>(<a class="code" href="namespaceOgre.html#a418a15">LBO_REPLACE</a>);
00197                     tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera30">setTextureAddressingMode</a>(Material::TextureLayer::TAM_WRAP);
00198 
00199                     <font class="keywordflow">if</font> (q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face].<a class="code" href="structbsp__face__t.html#bsp__face__tm7">lm_texture</a> != -1)
00200                     {
00201                         <font class="comment">// Add lightmap, additive blending</font>
00202                         <font class="keywordtype">char</font> lightmapName[16];
00203                         sprintf(lightmapName, <font class="stringliteral">"@lightmap%d"</font>,q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face].<a class="code" href="structbsp__face__t.html#bsp__face__tm7">lm_texture</a>);
00204                         tex = mat.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala19">addTextureLayer</a>(lightmapName);
00205                         <font class="comment">// Blend</font>
00206                         tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera32">setColourOperation</a>(<a class="code" href="namespaceOgre.html#a418a17">LBO_MODULATE</a>);
00207                         <font class="comment">// Use 2nd texture co-ordinate set</font>
00208                         tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera19">setTextureCoordSet</a>(1);
00209                         <font class="comment">// Clamp</font>
00210                         tex-&gt;<a class="code" href="classOgre_1_1Material_1_1TextureLayer.html#Ogre_1_1Material_1_1TextureLayera30">setTextureAddressingMode</a>(Material::TextureLayer::TAM_CLAMP);
00211 
00212                     }
00213                     <font class="comment">// Set culling mode to none</font>
00214                     mat.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala35">setCullingMode</a>(<a class="code" href="namespaceOgre.html#a430a84">CULL_NONE</a>);
00215                     <font class="comment">// No dynamic lighting</font>
00216                     mat.<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala39">setLightingEnabled</a>(<font class="keyword">false</font>);
00217 
00218                     <font class="comment">// Register material</font>
00219                     shadMat = MaterialManager::getSingleton().add(mat);
00220                     matHandle = shadMat-&gt;<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala4">getHandle</a>();
00221                 }
00222             }
00223             <font class="keywordflow">else</font>
00224             {
00225                 matHandle = shadMat-&gt;<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala4">getHandle</a>();
00226             }
00227 
00228             <font class="comment">// Copy face data</font>
00229             <a class="code" href="structOgre_1_1StaticFaceGroup.html">StaticFaceGroup</a>* dest = &amp;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln8">mFaceGroups</a>[face];
00230             <a class="code" href="structbsp__face__t.html">bsp_face_t</a>* src = &amp;q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm17">mFaces</a>[face];
00231 
00232             <font class="keywordflow">if</font> (q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm21">mShaders</a>[src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm0">shader</a>].surface_flags &amp; <a class="code" href="OgreQuake3Types_8h.html#a42">SURF_SKY</a>)
00233             {
00234                 dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm1">isSky</a> = <font class="keyword">true</font>;
00235             }
00236             <font class="keywordflow">else</font>
00237             {
00238                 dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm1">isSky</a> = <font class="keyword">false</font>;
00239             }
00240 
00241 
00242             dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm6">materialHandle</a> = matHandle;
00243             dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm4">elementStart</a> = src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm5">elem_start</a>;
00244             dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm5">numElements</a> = src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm6">elem_count</a>;
00245             dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm3">numVertices</a> = src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm4">vert_count</a>;
00246             dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm2">vertexStart</a> = src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm3">vert_start</a>;
00247             <font class="keywordflow">if</font> (src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm2">type</a> == <a class="code" href="OgreQuake3Types_8h.html#a58">BSP_FACETYPE_NORMAL</a>)
00248             {
00249                 dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm0">fType</a> = <a class="code" href="namespaceOgre.html#a442a316">FGT_FACE_LIST</a>;
00250                 <font class="comment">// Assign plane</font>
00251                 dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm7">plane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planem0">normal</a> = <a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm12">normal</a>);
00252                 dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm7">plane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planem1">d</a> = -dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm7">plane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planem0">normal</a>.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3a23">dotProduct</a>(<a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm10">org</a>));
00253             }
00254             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm2">type</a> == <a class="code" href="OgreQuake3Types_8h.html#a59">BSP_FACETYPE_PATCH</a>)
00255             {
00256                 <font class="comment">// Seems to be some crap in the Q3 level where vertex count = 0 or num control points = 0?</font>
00257                 <font class="keywordflow">if</font> (dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm3">numVertices</a> == 0 || src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm13">mesh_cp</a>[0] == 0)
00258                 {
00259                     dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm0">fType</a> = <a class="code" href="namespaceOgre.html#a442a318">FGT_UNKNOWN</a>;
00260                 }
00261                 <font class="keywordflow">else</font>
00262                 {
00263 
00264                     <font class="comment">// Set up patch surface</font>
00265                     dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm0">fType</a> = <a class="code" href="namespaceOgre.html#a442a317">FGT_PATCH</a>;
00266                     dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm8">patchSurf</a> = <font class="keyword">new</font> <a class="code" href="classOgre_1_1PatchSurface.html">PatchSurface</a>();
00267                     <font class="comment">// Set up control points &amp; format</font>
00268                     <font class="comment">// Same format as in BspSceneManager::mPendingGeometry - see that for details</font>
00269                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam4">hasColours</a> = <font class="keyword">false</font>; <font class="comment">// In vertex format, but not used</font>
00270                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam1">hasNormals</a> = <font class="keyword">true</font>;
00271                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam2">numTexCoords</a> = 2;
00272                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam3">numTexCoordDimensions</a>[0] = 2;
00273                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam3">numTexCoordDimensions</a>[1] = 2;
00274                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a> = dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm3">numVertices</a>;
00275                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam9">vertexStride</a> = <font class="keyword">sizeof</font>(float) * 7 + <font class="keyword">sizeof</font>(int);
00276                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam11">texCoordStride</a>[0] = <font class="keyword">sizeof</font>(Real) * 8 + <font class="keyword">sizeof</font>(int);
00277                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam11">texCoordStride</a>[1] = <font class="keyword">sizeof</font>(Real) * 8 + <font class="keyword">sizeof</font>(int);
00278                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam10">normalStride</a> = <font class="keyword">sizeof</font>(Real) * 7 + <font class="keyword">sizeof</font>(int);
00279                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> = (<a class="code" href="namespaceOgre.html#a281">Real</a>*)(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a> + dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm2">vertexStart</a>);
00280                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[0] = ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> + 3;
00281                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam6">pTexCoords</a>[1] = ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> + 5;
00282                     ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam7">pNormals</a> = ctl.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a> + 7;
00283 
00284                     sprintf(meshName, <font class="stringliteral">"BezierPatch%d"</font>, face);
00285                     dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm8">patchSurf</a>-&gt;<a class="code" href="classOgre_1_1PatchSurface.html#Ogre_1_1PatchSurfacea2">defineSurface</a>(meshName, ctl, src-&gt;<a class="code" href="structbsp__face__t.html#bsp__face__tm13">mesh_cp</a>[0], PatchSurface::PST_BEZIER);
00286 
00287                     dest-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm8">patchSurf</a>-&gt;<a class="code" href="classOgre_1_1PatchSurface.html#Ogre_1_1PatchSurfacea3">build</a>();
00288                 }
00289 
00290 
00291             }
00292 
00293 
00294         }
00295 
00296         <font class="comment">//-----------------------------------------------------------------------</font>
00297         <font class="comment">// Nodes</font>
00298         <font class="comment">//-----------------------------------------------------------------------</font>
00299         <font class="comment">// Allocate memory for all nodes (leaves and splitters)</font>
00300         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln1">mNumNodes</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm10">mNumNodes</a> + q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm12">mNumLeaves</a>;
00301         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln2">mNumLeaves</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm12">mNumLeaves</a>;
00302         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm10">mNumNodes</a>;
00303         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a> = <font class="keyword">new</font> <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln1">mNumNodes</a>];
00304         <font class="keywordtype">int</font> i;
00305         <font class="comment">// Convert nodes</font>
00306         <font class="comment">// In our array, first q3lvl.mNumNodes are non-leaf, others are leaves</font>
00307         <font class="keywordflow">for</font> (i = 0; i &lt; q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm10">mNumNodes</a>; ++i)
00308         {
00309             <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* node = &amp;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a>[i];
00310             <a class="code" href="structbsp__node__t.html">bsp_node_t</a>* q3node = &amp;q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm9">mNodes</a>[i];
00311 
00312             <font class="comment">// Set non-leaf</font>
00313             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden1">mIsLeaf</a> = <font class="keyword">false</font>;
00314             <font class="comment">// Set owner</font>
00315             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden0">mOwner</a> = <font class="keyword">this</font>;
00316             <font class="comment">// Set plane</font>
00317             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden2">mSplitPlane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planem0">normal</a> = <a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm15">mPlanes</a>[q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm0">plane</a>].normal);
00318             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden2">mSplitPlane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planem1">d</a> = -q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm15">mPlanes</a>[q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm0">plane</a>].dist;
00319             <font class="comment">// Set bounding box</font>
00320             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden6">mBounds</a>.<a class="code" href="classOgre_1_1AxisAlignedBox.html#Ogre_1_1AxisAlignedBoxa5">setMinimum</a>(<a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(&amp;q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm3">bbox</a>[0]));
00321             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden6">mBounds</a>.<a class="code" href="classOgre_1_1AxisAlignedBox.html#Ogre_1_1AxisAlignedBoxa7">setMaximum</a>(<a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(&amp;q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm3">bbox</a>[3]));
00322             <font class="comment">// Set back pointer</font>
00323             <font class="comment">// Negative indexes in Quake3 mean leaves</font>
00324             <font class="keywordflow">if</font> (q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm2">back</a> &lt; 0)
00325             {
00326                 <font class="comment">// Points to leaf, offset to leaf start and negate index</font>
00327                 node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden4">mBack</a> = &amp;mRootNode[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a> + (~(q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm2">back</a>))];
00328 
00329             }
00330             <font class="keywordflow">else</font>
00331             {
00332                 <font class="comment">// Points to node</font>
00333                 node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden4">mBack</a> = &amp;mRootNode[q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm2">back</a>];
00334             }
00335             <font class="comment">// Set front pointer</font>
00336             <font class="comment">// Negative indexes in Quake3 mean leaves</font>
00337             <font class="keywordflow">if</font> (q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm1">front</a> &lt; 0)
00338             {
00339                 <font class="comment">// Points to leaf, offset to leaf start and negate index</font>
00340                 node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden3">mFront</a> = &amp;mRootNode[<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a> + (~(q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm1">front</a>))];
00341 
00342             }
00343             <font class="keywordflow">else</font>
00344             {
00345                 <font class="comment">// Points to node</font>
00346                 node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden3">mFront</a> = &amp;mRootNode[q3node-&gt;<a class="code" href="structbsp__node__t.html#bsp__node__tm1">front</a>];
00347             }
00348 
00349 
00350         }
00351         <font class="comment">// Convert Leaves</font>
00352         <font class="keywordflow">for</font> (i = 0; i &lt; q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm12">mNumLeaves</a>; ++i)
00353         {
00354             <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* node = &amp;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a>[i + <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a>];
00355             <a class="code" href="structbsp__leaf__t.html">bsp_leaf_t</a>* q3leaf = &amp;q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm11">mLeaves</a>[i];
00356 
00357             <font class="comment">// Set leaf</font>
00358             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden1">mIsLeaf</a> = <font class="keyword">true</font>;
00359             <font class="comment">// Set owner</font>
00360             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden0">mOwner</a> = <font class="keyword">this</font>;
00361             <font class="comment">// Set bounding box</font>
00362             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden6">mBounds</a>.<a class="code" href="classOgre_1_1AxisAlignedBox.html#Ogre_1_1AxisAlignedBoxa5">setMinimum</a>(<a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(&amp;q3leaf-&gt;<a class="code" href="structbsp__leaf__t.html#bsp__leaf__tm2">bbox</a>[0]));
00363             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden6">mBounds</a>.<a class="code" href="classOgre_1_1AxisAlignedBox.html#Ogre_1_1AxisAlignedBoxa7">setMaximum</a>(<a class="code" href="classOgre_1_1Vector3.html">Vector3</a>(&amp;q3leaf-&gt;<a class="code" href="structbsp__leaf__t.html#bsp__leaf__tm2">bbox</a>[3]));
00364             <font class="comment">// Set faces</font>
00365             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden8">mFaceGroupStart</a> = q3leaf-&gt;<a class="code" href="structbsp__leaf__t.html#bsp__leaf__tm3">face_start</a>;
00366             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden7">mNumFaceGroups</a> = q3leaf-&gt;<a class="code" href="structbsp__leaf__t.html#bsp__leaf__tm4">face_count</a>;
00367 
00368             node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a> = q3leaf-&gt;<a class="code" href="structbsp__leaf__t.html#bsp__leaf__tm0">cluster</a>;
00369 
00370         }
00371 
00372 
00373 
00374         <font class="comment">// Vis - just copy</font>
00375         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam1">numClusters</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm0">cluster_count</a>;
00376         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam2">rowLength</a> = q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm1">row_size</a>;
00377         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam0">tableData</a> = <font class="keyword">new</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>[q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm1">row_size</a> * q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm0">cluster_count</a>];
00378         memcpy(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam0">tableData</a>, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm2">data</a>, q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm1">row_size</a> * q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm25">mVis</a>-&gt;<a class="code" href="structbsp__vis__t.html#bsp__vis__tm0">cluster_count</a>);
00379 
00380 
00381 
00382 
00383     }
00384 
00385     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00386"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela4">00386</a>     <font class="keywordtype">bool</font> BspLevel::isLeafVisible(<font class="keyword">const</font> <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* from, <font class="keyword">const</font> <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* to)<font class="keyword"> const</font>
00387 <font class="keyword">    </font>{
00388         <font class="keywordflow">if</font> (to-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a> == -1)
00389             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00390         <font class="keywordflow">if</font> (from-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a> == -1)
00391             <font class="comment">// Camera outside world?</font>
00392             <font class="keywordflow">return</font> <font class="keyword">true</font>;
00393 
00394 
00395         <font class="keywordflow">if</font> (!from-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea3">isLeaf</a>() || !to-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea3">isLeaf</a>())
00396             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(Exception::ERR_INVALIDPARAMS,
00397                 <font class="stringliteral">"Both nodes must be leaf nodes for visibility testing."</font>,
00398                 <font class="stringliteral">"BspLevel::isLeafVisible"</font>);
00399 
00400         <font class="comment">// Use PVS to determine visibility</font>
00401 
00402         <font class="comment">/*</font>
00403 <font class="comment">        // In wordier terms, the fairly cryptic (but fast) version is doing this:</font>
00404 <font class="comment">        //   Could make it a macro for even more speed?</font>
00405 <font class="comment"></font>
00406 <font class="comment">        // Row offset = from cluster number * row size</font>
00407 <font class="comment">        int offset = from-&gt;mVisCluster*mVisData.rowLength;</font>
00408 <font class="comment"></font>
00409 <font class="comment">        // Column offset (in bytes) = to cluster number divided by 8 (since 8 bits per bytes)</font>
00410 <font class="comment">        offset += to-&gt;mVisCluster &gt;&gt; 3;</font>
00411 <font class="comment"></font>
00412 <font class="comment">        // Get the right bit within the byte, i.e. bitwise 'and' with bit at remainder position</font>
00413 <font class="comment">        int result = *(mVisData.tableData + offset) &amp; (1 &lt;&lt; (to-&gt;mVisCluster &amp; 7));</font>
00414 <font class="comment"></font>
00415 <font class="comment">        return (result != 0);</font>
00416 <font class="comment">        */</font>
00417 
00418         <font class="comment">//return ((*(mVisData.tableData + from-&gt;mVisCluster * mVisData.rowLength +</font>
00419         <font class="comment">//           ((to-&gt;mVisCluster)&gt;&gt;3)) &amp; (1 &lt;&lt; ((to-&gt;mVisCluster) &amp; 7))) != 0);</font>
00420 
00421         <font class="keywordflow">return</font> (*(<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam0">tableData</a> + from-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a>*<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln13">mVisData</a>.<a class="code" href="structOgre_1_1BspLevel_1_1VisData.html#Ogre_1_1BspLevel_1_1VisDatam2">rowLength</a> +
00422                    ((to-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a>)&gt;&gt;3)) &amp; (1 &lt;&lt; ((to-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNoden5">mVisCluster</a>) &amp; 7))) != 0;
00423 
00424     }
00425     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00426"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela5">00426</a>     <font class="keyword">const</font> <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* BspLevel::getRootNode(<font class="keywordtype">void</font>)
00427     {
00428         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a>;
00429     }
00430     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00431"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela6">00431</a>     <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* BspLevel::findLeaf(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Vector3.html">Vector3</a>&amp; point)<font class="keyword"> const</font>
00432 <font class="keyword">    </font>{
00433         <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* node = <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a>;
00434 
00435         <font class="keywordflow">while</font> (!node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea3">isLeaf</a>())
00436         {
00437             node = node-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea7">getNextNode</a>(point);
00438         }
00439 
00440         <font class="keywordflow">return</font> node;
00441 
00442     }
00443     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00444"></a><a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevelb1">00444</a>     <font class="keywordtype">void</font> BspLevel::loadEntities(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Quake3Level.html">Quake3Level</a>&amp; q3lvl)
00445     {
00446         <font class="keywordtype">char</font>* strEnt;
00447         <a class="code" href="classOgre_1_1String.html">String</a> line;
00448         <a class="code" href="namespaceOgre.html#a338">StringVector</a> vecparams;
00449         <a class="code" href="classOgre_1_1Vector3.html">Vector3</a> origin;
00450         <a class="code" href="namespaceOgre.html#a281">Real</a> angle;
00451         size_t pos;
00452         <font class="keywordtype">char</font>* lineend;
00453         <font class="keywordtype">bool</font> isPlayerStart;
00454 
00455         isPlayerStart = <font class="keyword">false</font>;
00456         strEnt = (<font class="keywordtype">char</font>*)q3lvl.<a class="code" href="classOgre_1_1Quake3Level.html#Ogre_1_1Quake3Levelm5">mEntities</a>;
00457 
00458         lineend = strchr(strEnt, <font class="charliteral">'\n'</font>);
00459         <font class="keywordflow">while</font> (lineend != 0)
00460         {
00461             *lineend = <font class="charliteral">'\0'</font>;
00462             line = strEnt;
00463             strEnt = lineend+1;
00464             line.<a class="code" href="classOgre_1_1String.html#Ogre_1_1Stringa5">trim</a>();
00465             <font class="keywordflow">if</font> (line.length() &gt; 0)
00466             {
00467                 line = line.<a class="code" href="classOgre_1_1String.html#Ogre_1_1Stringa7">toLowerCase</a>();
00468                 <font class="comment">// Remove quotes</font>
00469                 <font class="keywordflow">while</font>( ( pos = line.find(<font class="stringliteral">"\""</font>,0) ) != String::npos )
00470                 {
00471                     line = line.substr(0,pos) + line.substr(pos+1,line.length()-(pos+1));
00472                 }
00473                 vecparams = line.<a class="code" href="classOgre_1_1String.html#Ogre_1_1Stringa6">split</a>();
00474                 StringVector::iterator params = vecparams.begin();
00475 
00476                 <font class="keywordflow">if</font> (params[0] == <font class="stringliteral">"origin"</font>)
00477                 {
00478                     origin.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m0">x</a> = atof(params[1].c_str());
00479                     origin.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m1">y</a> = atof(params[2].c_str());
00480                     origin.<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m2">z</a> = atof(params[3].c_str());
00481                 }
00482                 <font class="keywordflow">if</font> (params[0] == <font class="stringliteral">"angle"</font>)
00483                 {
00484                     angle = atof(params[1].c_str());
00485                 }
00486                 <font class="keywordflow">if</font> (params[0] == <font class="stringliteral">"classname"</font> &amp;&amp; params[1] == <font class="stringliteral">"info_player_deathmatch"</font>)
00487                 {
00488                     isPlayerStart = <font class="keyword">true</font>;
00489                 }
00490                 <font class="keywordflow">if</font> (params[0] == <font class="stringliteral">"}"</font>)
00491                 {
00492                     <font class="keywordflow">if</font> (isPlayerStart)
00493                     {
00494                         <font class="comment">// Save player start</font>
00495                         <a class="code" href="structOgre_1_1ViewPoint.html">ViewPoint</a> vp;
00496                         vp.<a class="code" href="structOgre_1_1ViewPoint.html#Ogre_1_1ViewPointm0">position</a> = origin;
00497                         vp.<a class="code" href="structOgre_1_1ViewPoint.html#Ogre_1_1ViewPointm1">orientation</a>.<a class="code" href="classOgre_1_1Quaternion.html#Ogre_1_1Quaterniona4">FromAngleAxis</a>(Math::getSingleton().DegreesToRadians(angle), Vector3::UNIT_Z);
00498                         <a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln12">mPlayerStarts</a>.push_back(vp);
00499                     }
00500                     isPlayerStart = <font class="keyword">false</font>;
00501                 }
00502             }
00503 
00504             lineend = strchr(strEnt, <font class="charliteral">'\n'</font>);
00505         }
00506 
00507 
00508     }
00509 
00510 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
