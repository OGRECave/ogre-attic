<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreSkeleton.cpp</h1><a href="OgreSkeleton_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2002 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreSkeleton_8h.html">OgreSkeleton.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreBone_8h.html">OgreBone.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreAnimation_8h.html">OgreAnimation.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreAnimationState_8h.html">OgreAnimationState.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreSkeletonManager_8h.html">OgreSkeletonManager.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreSkeletonSerializer_8h.html">OgreSkeletonSerializer.h</a>"</font>
00033 
00034 
00035 <font class="keyword">namespace </font>Ogre {
00036 
00037     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00038"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona0">00038</a>     Skeleton::Skeleton(<a class="code" href="classOgre_1_1String.html">String</a> name) 
00039     {
00040         <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a> = name;
00041 
00042         <font class="comment">// Start next handle</font>
00043         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn3">mNextAutoHandle</a> = 0;
00044 
00045         <font class="comment">// Indicate root has not been derived yet</font>
00046         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a> = 0;
00047 
00048     }
00049     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00050"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona1">00050</a>     Skeleton::~Skeleton()
00051     {
00052         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona3">unload</a>();
00053     }
00054     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00055"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona2">00055</a>     <font class="keywordtype">void</font> Skeleton::load(<font class="keywordtype">void</font>)
00056     {
00057         <font class="comment">// Load from specified 'name'</font>
00058         <font class="keywordflow">if</font> (mIsLoaded)
00059         {
00060             <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona3">unload</a>();
00061             <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn1">mIsLoaded</a> = <font class="keyword">false</font>;
00062         }
00063 
00064         <a class="code" href="classOgre_1_1SkeletonSerializer.html">SkeletonSerializer</a> serializer;
00065         <font class="keywordtype">char</font> msg[100];
00066         sprintf(msg, <font class="stringliteral">"Skeleton: Loading %s ."</font>, <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>.c_str());
00067         LogManager::getSingleton().logMessage(msg);
00068 
00069         <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> chunk;
00070         SkeletonManager::getSingleton()._findResourceData(<a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>, chunk);
00071 
00072         <font class="comment">// Determine file type</font>
00073         std::vector&lt;String&gt; extVec = <a class="code" href="classOgre_1_1Resource.html#Ogre_1_1Zipn0">mName</a>.<a class="code" href="classOgre_1_1String.html#Ogre_1_1Stringa6">split</a>(<font class="stringliteral">"."</font>);
00074 
00075         <a class="code" href="classOgre_1_1String.html">String</a>&amp; ext = extVec[extVec.size() - 1];
00076         ext.<a class="code" href="classOgre_1_1String.html#Ogre_1_1Stringa7">toLowerCase</a>();
00077 
00078         <font class="keywordflow">if</font> (ext == <font class="stringliteral">"skeleton"</font>)
00079         {
00080             serializer.<a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializera3">importSkeleton</a>(chunk, <font class="keyword">this</font>);
00081         }
00082         <font class="keywordflow">else</font>
00083         {
00084             <font class="comment">// Unsupported format</font>
00085             chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka4">clear</a>();
00086             <a class="code" href="OgreException_8h.html#a0">Except</a>(999, <font class="stringliteral">"Unsupported skeleton file format."</font>,
00087                 <font class="stringliteral">"Skeleton::load"</font>);
00088         }
00089 
00090         chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka4">clear</a>();
00091 
00092     }
00093     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00094"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona3">00094</a>     <font class="keywordtype">void</font> Skeleton::unload(<font class="keywordtype">void</font>)
00095     {
00096         <font class="comment">// destroy bones</font>
00097         BoneList::iterator i;
00098         <font class="keywordflow">for</font> (i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.begin(); i != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end(); ++i)
00099         {
00100             <font class="keyword">delete</font> i-&gt;second;
00101         }
00102         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.clear();
00103 
00104         <font class="comment">// Destroy animations</font>
00105         AnimationList::iterator ai;
00106         <font class="keywordflow">for</font> (ai = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.begin(); ai != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.end(); ++i)
00107         {
00108             <font class="keyword">delete</font> ai-&gt;second;
00109         }
00110         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.clear();
00111 
00112     }
00113     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00114"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona4">00114</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::createBone(<font class="keywordtype">void</font>)
00115     {
00116         <font class="comment">// use autohandle</font>
00117         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona4">createBone</a>(<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn3">mNextAutoHandle</a>++);
00118     }
00119     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00120"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona6">00120</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::createBone(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; name)
00121     {
00122         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.size() == <a class="code" href="OgreSkeleton_8h.html#a0">OGRE_MAX_NUM_BONES</a>)
00123         {
00124             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_INVALIDPARAMS, <font class="stringliteral">"Exceeded the maximum number of bones per skeleton."</font>,
00125                 <font class="stringliteral">"Skeleton::createBone"</font>);
00126         }
00127         <a class="code" href="classOgre_1_1Bone.html">Bone</a>* ret = <font class="keyword">new</font> <a class="code" href="classOgre_1_1Bone.html">Bone</a>(name, <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn3">mNextAutoHandle</a>++, <font class="keyword">this</font>);
00128         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>[ret-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea8">getHandle</a>()] = ret;
00129         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn1">mBoneListByName</a>[name] = ret;
00130         <font class="keywordflow">return</font> ret;
00131     }
00132     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00133"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona5">00133</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::createBone(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> handle)
00134     {
00135         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.size() == <a class="code" href="OgreSkeleton_8h.html#a0">OGRE_MAX_NUM_BONES</a>)
00136         {
00137             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_INVALIDPARAMS, <font class="stringliteral">"Exceeded the maximum number of bones per skeleton."</font>,
00138                 <font class="stringliteral">"Skeleton::createBone"</font>);
00139         }
00140         <a class="code" href="classOgre_1_1Bone.html">Bone</a>* ret = <font class="keyword">new</font> <a class="code" href="classOgre_1_1Bone.html">Bone</a>(handle, <font class="keyword">this</font>);
00141         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>[handle] = ret;
00142         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn1">mBoneListByName</a>[ret-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea18">getName</a>()] = ret;
00143         <font class="keywordflow">return</font> ret;
00144 
00145     }
00146     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00147"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona8">00147</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::getRootBone(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00148 <font class="keyword">    </font>{
00149         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a> == 0)
00150         {
00151             <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonb0">deriveRootBone</a>();
00152         }
00153 
00154         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a>;
00155     }
00156     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00157"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona16">00157</a>     <font class="keywordtype">void</font> Skeleton::setAnimationState(<font class="keyword">const</font> <a class="code" href="namespaceOgre.html#a0">AnimationStateSet</a>&amp; animSet)
00158     {
00159         <font class="comment">/* </font>
00160 <font class="comment">        Algorithm:</font>
00161 <font class="comment">          1. Check if animation state is any different from last, if not do nothing</font>
00162 <font class="comment">          2. Reset all bone positions</font>
00163 <font class="comment">          3. Iterate per AnimationState, if enabled get Animation and call Animation::apply</font>
00164 <font class="comment">        */</font>
00165 
00166         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn5">mLastAnimationState</a>.size() == animSet.size())
00167         {
00168             <font class="comment">// Same size, may be able to skip update</font>
00169             <font class="keywordtype">bool</font> different = <font class="keyword">false</font>;
00170             AnimationStateSet::iterator i;
00171             AnimationStateSet::const_iterator j;
00172             i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn5">mLastAnimationState</a>.begin();
00173             j = animSet.begin();
00174             <font class="keywordflow">for</font> (; i != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn5">mLastAnimationState</a>.end(); ++i, ++j)
00175             {
00176                 <font class="keywordflow">if</font> (i-&gt;second != j-&gt;second)
00177                 {
00178                     different = <font class="keyword">true</font>;
00179                     <font class="keywordflow">break</font>;
00180                 }
00181             }
00182             <font class="comment">// Check any differences?</font>
00183             <font class="keywordflow">if</font> (!different)
00184             {
00185                 <font class="comment">// No, no need to update</font>
00186                 <font class="keywordflow">return</font>;
00187             }
00188         }
00189 
00190         <font class="comment">// Ok, we've established the animation state is different</font>
00191 
00192         <font class="comment">// Reset bones</font>
00193         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona12">reset</a>();
00194 
00195         <font class="comment">// Per animation state</font>
00196         AnimationStateSet::const_iterator istate;
00197         <font class="keywordflow">for</font> (istate = animSet.begin(); istate != animSet.end(); ++istate)
00198         {
00199             <font class="comment">// Apply if enabled</font>
00200             <font class="keyword">const</font> <a class="code" href="classOgre_1_1AnimationState.html">AnimationState</a>&amp; animState = istate-&gt;second;
00201             <font class="keywordflow">if</font> (animState.<a class="code" href="classOgre_1_1AnimationState.html#Ogre_1_1AnimationStatea11">getEnabled</a>())
00202             {
00203                 <a class="code" href="classOgre_1_1Animation.html">Animation</a>* anim = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona14">getAnimation</a>(animState.<a class="code" href="classOgre_1_1AnimationState.html#Ogre_1_1AnimationStatea2">getAnimationName</a>());
00204                 anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa10">apply</a>(animState.<a class="code" href="classOgre_1_1AnimationState.html#Ogre_1_1AnimationStatea4">getTimePosition</a>(), animState.<a class="code" href="classOgre_1_1AnimationState.html#Ogre_1_1AnimationStatea8">getWeight</a>());
00205             }
00206         }
00207 
00208 
00209     }
00210     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00211"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona11">00211</a>     <font class="keywordtype">void</font> Skeleton::setBindingPose(<font class="keywordtype">void</font>)
00212     {
00213         <font class="comment">// Update the derived transforms</font>
00214         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a>-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea51">_update</a>();
00215 
00216 
00217         BoneList::iterator i;
00218         <font class="keywordflow">for</font> (i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.begin(); i != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end(); ++i)
00219         {
00220             i-&gt;second-&gt;setBindingPose();
00221         }
00222     }
00223     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00224"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona12">00224</a>     <font class="keywordtype">void</font> Skeleton::reset(<font class="keywordtype">void</font>)
00225     {
00226         BoneList::iterator i;
00227         <font class="keywordflow">for</font> (i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.begin(); i != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end(); ++i)
00228         {
00229             i-&gt;second-&gt;reset();
00230         }
00231     }
00232     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00233"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona13">00233</a>     <a class="code" href="classOgre_1_1Animation.html">Animation</a>* Skeleton::createAnimation(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; name, <a class="code" href="namespaceOgre.html#a281">Real</a> length)
00234     {
00235         <a class="code" href="classOgre_1_1Animation.html">Animation</a>* ret = <font class="keyword">new</font> <a class="code" href="classOgre_1_1Animation.html">Animation</a>(name, length);
00236 
00237         <font class="comment">// Add to list</font>
00238         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>[name] = ret;
00239 
00240         <font class="comment">// Also add to state</font>
00241         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn5">mLastAnimationState</a>[name] = <a class="code" href="classOgre_1_1AnimationState.html">AnimationState</a>(name, 0, length);
00242 
00243         <font class="keywordflow">return</font> ret;
00244 
00245     }
00246     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00247"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona14">00247</a>     <a class="code" href="classOgre_1_1Animation.html">Animation</a>* Skeleton::getAnimation(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; name)<font class="keyword"> const</font>
00248 <font class="keyword">    </font>{
00249         AnimationList::const_iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.find(name);
00250 
00251         <font class="keywordflow">if</font> (i == <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.end())
00252         {
00253             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_ITEM_NOT_FOUND, <font class="stringliteral">"No animation entry found named "</font> + name, 
00254             <font class="stringliteral">"Skeleton::getAnimation"</font>);
00255         }
00256 
00257         <font class="keywordflow">return</font> i-&gt;second;
00258     }
00259     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00260"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona15">00260</a>     <font class="keywordtype">void</font> Skeleton::removeAnimation(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; name)
00261     {
00262         AnimationList::iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.find(name);
00263 
00264         <font class="keywordflow">if</font> (i == <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.end())
00265         {
00266             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_ITEM_NOT_FOUND, <font class="stringliteral">"No animation entry found named "</font> + name, 
00267             <font class="stringliteral">"Skeleton::getAnimation"</font>);
00268         }
00269 
00270         <font class="keyword">delete</font> i-&gt;second;
00271 
00272         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.erase(i);
00273 
00274     }
00275     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00276"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona17">00276</a>     <font class="keyword">const</font> <a class="code" href="namespaceOgre.html#a0">AnimationStateSet</a>&amp; Skeleton::getAnimationState(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00277 <font class="keyword">    </font>{
00278         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn5">mLastAnimationState</a>;
00279     }
00280     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00281"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona18">00281</a>     <font class="keywordtype">void</font> Skeleton::_initAnimationState(<a class="code" href="namespaceOgre.html#a0">AnimationStateSet</a>* animSet)
00282     {
00283         animSet-&gt;clear();
00284            
00285         AnimationList::iterator i;
00286         <font class="keywordflow">for</font> (i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.begin(); i != <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.end(); ++i)
00287         {
00288             <a class="code" href="classOgre_1_1Animation.html">Animation</a>* anim = i-&gt;second;
00289             <font class="comment">// Create animation at time index 0, default params mean this has weight 1 and is disabled</font>
00290             <a class="code" href="classOgre_1_1String.html">String</a> animName = anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa2">getName</a>();
00291             (*animSet)[animName] = <a class="code" href="classOgre_1_1AnimationState.html">AnimationState</a>(animName, 0.0, anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa3">getLength</a>());
00292         }
00293     }
00294     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00295"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona7">00295</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> Skeleton::getNumBones(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00296 <font class="keyword">    </font>{
00297         <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>)<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.size();
00298     }
00299     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00300"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona19">00300</a>     <font class="keywordtype">void</font> Skeleton::_getBoneMatrices(<a class="code" href="classOgre_1_1Matrix4.html">Matrix4</a>* pMatrices)
00301     {
00302         <font class="comment">// Update derived transforms</font>
00303         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a>-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea51">_update</a>();
00304 
00305         <font class="comment">/* </font>
00306 <font class="comment">            Calculating the bone matrices</font>
00307 <font class="comment">            -----------------------------</font>
00308 <font class="comment">            Now that we have the derived orientations &amp; positions in the Bone nodes, we have</font>
00309 <font class="comment">            to compute the Matrix4 to apply to the vertices of a mesh.</font>
00310 <font class="comment">            Because any modification of a vertex has to be relative to the bone, we must first</font>
00311 <font class="comment">            reverse transform by the Bone's original derived position/orientation, then transform</font>
00312 <font class="comment">            by the new derived position / orientation.</font>
00313 <font class="comment">        */</font>
00314 
00315         BoneList::iterator i, boneend;
00316         boneend = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end();
00317         
00318         
00319         <font class="keywordflow">for</font>(i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.begin();i != boneend; ++i)
00320         {
00321             <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone = i-&gt;second;
00322             *pMatrices = pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea50">_getFullTransform</a>() *  pBone-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea11">_getBindingPoseInverseTransform</a>();
00323             pMatrices++;
00324         }
00325 
00326     }
00327     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00328"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona20">00328</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> Skeleton::getNumAnimations(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00329 <font class="keyword">    </font>{
00330         <font class="keywordflow">return</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>)<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.size();
00331     }
00332     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00333"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona21">00333</a>     <a class="code" href="classOgre_1_1Animation.html">Animation</a>* Skeleton::getAnimation(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> index)<font class="keyword"> const</font>
00334 <font class="keyword">    </font>{
00335         assert(index &lt; mAnimationsList.size() &amp;&amp; index &gt;= 0 &amp;&amp; <font class="stringliteral">"Index out of bounds"</font>);
00336 
00337         AnimationList::const_iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn4">mAnimationsList</a>.begin();
00338 
00339         <font class="keywordflow">while</font> (index)
00340             ++i;
00341 
00342         <font class="keywordflow">return</font> i-&gt;second;
00343     }
00344     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00345"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">00345</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::getBone(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> handle)<font class="keyword"> const</font>
00346 <font class="keyword">    </font>{
00347         BoneList::const_iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.find(handle);
00348 
00349         <font class="keywordflow">if</font> (i == <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end())
00350         {
00351             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_ITEM_NOT_FOUND, <font class="stringliteral">"Bone with specified handle not found."</font>, 
00352                 <font class="stringliteral">"Skeleton::getBone"</font>);
00353         }
00354 
00355         <font class="keywordflow">return</font> i-&gt;second;
00356 
00357     }
00358     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00359"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona10">00359</a>     <a class="code" href="classOgre_1_1Bone.html">Bone</a>* Skeleton::getBone(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; name)<font class="keyword"> const</font>
00360 <font class="keyword">    </font>{
00361         BoneListByName::const_iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn1">mBoneListByName</a>.find(name);
00362 
00363         <font class="keywordflow">if</font> (i == <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.end())
00364         {
00365             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_ITEM_NOT_FOUND, <font class="stringliteral">"Bone named '"</font> + name + <font class="stringliteral">"' not found."</font>, 
00366                 <font class="stringliteral">"Skeleton::getBone"</font>);
00367         }
00368 
00369         <font class="keywordflow">return</font> i-&gt;second;
00370 
00371     }
00372     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00373"></a><a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonb0">00373</a>     <font class="keywordtype">void</font> Skeleton::deriveRootBone(<font class="keywordtype">void</font>)<font class="keyword"> const</font>
00374 <font class="keyword">    </font>{
00375         <font class="comment">// Start at the first bone and work up</font>
00376         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.empty())
00377         {
00378             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_INVALIDPARAMS, <font class="stringliteral">"Cannot derive root bone as this "</font>
00379                 <font class="stringliteral">"skeleton has no bones!"</font>, <font class="stringliteral">"Skeleton::deriveRootBone"</font>);
00380         }
00381 
00382         <a class="code" href="classOgre_1_1Bone.html">Bone</a>* currentBone;
00383         BoneList::const_iterator i = <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn0">mBoneList</a>.begin();
00384 
00385         currentBone = i-&gt;second;
00386         <font class="keywordflow">while</font> (currentBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea19">getParent</a>() != 0)
00387         {
00388             <font class="comment">// Keep going up the tree</font>
00389             currentBone = (<a class="code" href="classOgre_1_1Bone.html">Bone</a>*)currentBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea19">getParent</a>();
00390         }
00391 
00392         <font class="comment">// No more parents, this must be the root</font>
00393         <a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletonn2">mRootBone</a> = currentBone;
00394     }
00395 
00396 
00397 
00398 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
