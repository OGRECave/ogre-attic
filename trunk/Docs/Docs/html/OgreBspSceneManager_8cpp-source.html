<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreBspSceneManager.cpp</h1><a href="OgreBspSceneManager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreBspSceneManager_8h.html">OgreBspSceneManager.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreBspResourceManager_8h.html">OgreBspResourceManager.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreBspLevel_8h.html">OgreBspLevel.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreBspNode_8h.html">OgreBspNode.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreRenderSystem_8h.html">OgreRenderSystem.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreCamera_8h.html">OgreCamera.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreMaterial_8h.html">OgreMaterial.h</a>"</font>
00033 <font class="preprocessor">#include "<a class="code" href="OgrePatchSurface_8h.html">OgrePatchSurface.h</a>"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreMesh_8h.html">OgreMesh.h</a>"</font>
00035 <font class="preprocessor">#include "<a class="code" href="OgreSubMesh_8h.html">OgreSubMesh.h</a>"</font>
00036 <font class="preprocessor">#include "<a class="code" href="OgreMath_8h.html">OgreMath.h</a>"</font>
00037 <font class="preprocessor">#include "<a class="code" href="OgreControllerManager_8h.html">OgreControllerManager.h</a>"</font>
00038 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00039 
00040 <font class="preprocessor">#include &lt;fstream&gt;</font>
00041 
00042 <font class="keyword">namespace </font>Ogre {
00043 
00044     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00045"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera0">00045</a>     BspSceneManager::BspSceneManager()
00046     {
00047         <font class="comment">// Set features for debugging render</font>
00048         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern4">mShowNodeAABs</a> = <font class="keyword">false</font>;
00049         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm0">useIndexes</a> = <font class="keyword">true</font>;
00050         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm9">numTextureCoordSets</a> = 0; <font class="comment">// no textures</font>
00051         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm18">vertexOptions</a> = RenderOperation::VO_DIFFUSE_COLOURS;
00052         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm19">operationType</a> = RenderOperation::OT_LINE_LIST;
00053         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> = 0;
00054         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> = 0;
00055 
00056 
00057         <font class="comment">// Set up some basics on cached geometry format</font>
00058         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm0">useIndexes</a> = <font class="keyword">true</font>;
00059         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm9">numTextureCoordSets</a> = 2; <font class="comment">// texture + lightmap</font>
00060         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm10">numTextureDimensions</a>[0] = 2; <font class="comment">// 2D coords</font>
00061         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm10">numTextureDimensions</a>[1] = 2; <font class="comment">// 2D coords</font>
00062         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm18">vertexOptions</a> = RenderOperation::VO_NORMALS | RenderOperation::VO_TEXTURE_COORDS;
00063         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm19">operationType</a> = RenderOperation::OT_TRIANGLE_LIST;
00064         <font class="comment">// Strides</font>
00065         <font class="comment">// Format is:</font>
00066         <font class="comment">//   vertex       3 x float</font>
00067         <font class="comment">//   texCoord1    2 x float</font>
00068         <font class="comment">//   texCoord2    2 x float</font>
00069         <font class="comment">//   normal       3 x float</font>
00070         <font class="comment">//   colour       1 x  int (not used except in models)</font>
00071         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm4">vertexStride</a> = <font class="keyword">sizeof</font>(float) * 7 + <font class="keyword">sizeof</font>(int);
00072         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm8">texCoordStride</a>[0] = <font class="keyword">sizeof</font>(float) * 8 + <font class="keyword">sizeof</font>(int);
00073         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm8">texCoordStride</a>[1] = <font class="keyword">sizeof</font>(float) * 8 + <font class="keyword">sizeof</font>(int);
00074         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm6">normalStride</a> = <font class="keyword">sizeof</font>(float) * 7 + <font class="keyword">sizeof</font>(int);
00075 
00076         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> = 0;
00077         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> = 0;
00078         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = 0;
00079         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm7">pTexCoords</a>[0] = 0;
00080         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm7">pTexCoords</a>[1] = 0;
00081         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm5">pNormals</a> = 0;
00082         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> = 0;
00083 
00084         <font class="comment">// Instantiate BspResourceManager</font>
00085         <font class="comment">// Will be managed by singleton</font>
00086         <a class="code" href="classOgre_1_1BspResourceManager.html">BspResourceManager</a>* r = <font class="keyword">new</font> <a class="code" href="classOgre_1_1BspResourceManager.html">BspResourceManager</a>();
00087 
00088         <font class="comment">// No sky by default</font>
00089         <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern10">mSkyPlaneEnabled</a> = <font class="keyword">false</font>;
00090         <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern14">mSkyBoxEnabled</a> = <font class="keyword">false</font>;
00091         <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern19">mSkyDomeEnabled</a> = <font class="keyword">false</font>;
00092 
00093         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a> = 0;
00094 
00095     }
00096 
00097     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00098"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera1">00098</a>     BspSceneManager::~BspSceneManager()
00099     {
00100         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb4">freeMemory</a>();
00101     }
00102 
00103     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00104"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera2">00104</a>     <font class="keywordtype">void</font> BspSceneManager::setWorldGeometry(<font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; filename)
00105     {
00106         <font class="comment">// Check extension is .bsp</font>
00107         <font class="keywordtype">char</font> extension[6];
00108         size_t pos = filename.find_last_of(<font class="stringliteral">"."</font>);
00109         <font class="keywordflow">if</font>( pos == String::npos )
00110             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00111                 Exception::ERR_INVALIDPARAMS,
00112                 <font class="stringliteral">"Unable to load world geometry. Invalid extension (must be .bsp)."</font>,
00113                 <font class="stringliteral">"BspSceneManager::setWorldGeometry"</font>);
00114 
00115         strcpy(extension, filename.substr(pos + 1, filename.length() - pos).c_str());
00116 
00117         <font class="keywordflow">if</font> (<a class="code" href="OgrePlatform_8h.html#a12">stricmp</a>(extension, <font class="stringliteral">"bsp"</font>))
00118             <a class="code" href="OgreException_8h.html#a0">Except</a>(Exception::ERR_INVALIDPARAMS,
00119             <font class="stringliteral">"Unable to load world geometry. Invalid extension (must be .bsp)."</font>,
00120             <font class="stringliteral">"BspSceneManager::setWorldGeometry"</font>);
00121 
00122         <font class="comment">// Load using resource manager</font>
00123         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a> = BspResourceManager::getSingleton().<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela2">load</a>(filename);
00124 
00125         <font class="comment">// Deallocate any previous pending geometry</font>
00126         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb4">freeMemory</a>();
00127         <font class="comment">// Pre-allocate buffers for pending geometry</font>
00128         <font class="comment">// Make them as big as they could ever need to be</font>
00129         <font class="comment">// Vertex, texture coords and normals use same buffer</font>
00130         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = (<a class="code" href="namespaceOgre.html#a281">Real</a> *)( <font class="keyword">new</font> <a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspLevel::BspVertex</a>[<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln5">mNumVertices</a>] );
00131         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm7">pTexCoords</a>[0] = ((<font class="keywordtype">float</font>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + 3);
00132         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm7">pTexCoords</a>[1] = ((<font class="keywordtype">float</font>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + 5);
00133         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm5">pNormals</a> = ((<font class="keywordtype">float</font>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + 7);
00134         <font class="comment">// Indexes use separate buffer</font>
00135         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> = <font class="keyword">new</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>[<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln11">mNumElements</a>];
00136 
00137         <font class="comment">// Also allocate memory for drawing bounding boxes</font>
00138         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a281">Real</a>[8*3*<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln2">mNumLeaves</a>];
00139         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> = <font class="keyword">new</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>[24*<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln2">mNumLeaves</a>];
00140         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm11">pDiffuseColour</a> = <font class="keyword">new</font> <a class="code" href="namespaceOgre.html#a63">RGBA</a>[8*<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln2">mNumLeaves</a>];
00141     }
00142     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00143"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera5">00143</a>     <font class="keywordtype">void</font> BspSceneManager::_findVisibleObjects(<a class="code" href="classOgre_1_1Camera.html">Camera</a>* cam)
00144     {
00145         <font class="comment">// Call superclass to find movables</font>
00146         <font class="comment">// NB we could make this a bit smarter using bsp/pvs if we wanted, not done for now</font>
00147         SceneManager::_findVisibleObjects(cam);
00148 
00149         <font class="comment">// Now deal with static level geometry</font>
00150         <font class="comment">// Walk the tree, tag any geometry, return camera's node (for info only)</font>
00151         <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* cameraNode = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb0">walkTree</a>(cam);
00152 
00153     }
00154     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00155"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb6">00155</a>     <font class="keywordtype">void</font> BspSceneManager::renderStaticGeometry(<font class="keywordtype">void</font>)
00156     {
00157         <font class="comment">// no world transform required</font>
00158         <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern2">mDestRenderSystem</a>-&gt;<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema29">_setWorldMatrix</a>(Matrix4::IDENTITY);
00159         <font class="comment">// For each material in turn, cache rendering data &amp; render</font>
00160         MaterialFaceGroupMap::const_iterator mati;
00161         <font class="keywordflow">for</font> (mati = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern2">mMatFaceGroupMap</a>.begin(); mati != <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern2">mMatFaceGroupMap</a>.end(); ++mati)
00162         {
00163             <font class="comment">// Get Material</font>
00164             <a class="code" href="classOgre_1_1Material.html">Material</a>* thisMaterial = mati-&gt;first;
00165 
00166 
00167             <font class="comment">// Cache vertex/face data first</font>
00168             std::vector&lt;StaticFaceGroup*&gt;::const_iterator faceGrpi;
00169 
00170             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb2">clearGeometryCaches</a>();
00171             <font class="keywordflow">for</font> (faceGrpi = mati-&gt;second.begin(); faceGrpi != mati-&gt;second.end(); ++faceGrpi)
00172             {
00173                 <font class="comment">// Cache each</font>
00174                 <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb3">cacheGeometry</a>(*faceGrpi);
00175             }
00176 
00177             <font class="comment">// Skip if no faces to process (we're not doing flare types yet)</font>
00178             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> == 0)
00179                 <font class="keywordflow">continue</font>;
00180             <font class="keywordtype">int</font> matLayersLeft = thisMaterial-&gt;<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala23">getNumTextureLayers</a>();
00181 
00182             <font class="keywordflow">do</font>
00183             {
00184                 <font class="comment">// Set material - will return non-zero if multipass required so loop will continue, 0 otherwise</font>
00185                 matLayersLeft = <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagerb0">setMaterial</a>(thisMaterial, matLayersLeft);
00186 
00187                 <font class="comment">// Send rendering operation</font>
00188                 <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern2">mDestRenderSystem</a>-&gt;<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema46">_render</a>(<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>);
00189 
00190 
00191             } <font class="keywordflow">while</font> (matLayersLeft &gt; 0);
00192 
00193 
00194         } <font class="comment">// for each material</font>
00195 
00196         <font class="keywordflow">if</font> (mShowNodeAABs)
00197         {
00198             <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagern2">mDestRenderSystem</a>-&gt;<a class="code" href="classOgre_1_1RenderSystem.html#Ogre_1_1RenderSystema46">_render</a>(<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>);
00199         }
00200     }
00201     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00202"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera6">00202</a>     <font class="keywordtype">void</font> BspSceneManager::_renderVisibleObjects(<font class="keywordtype">void</font>)
00203     {
00204         <font class="comment">// Render static level geometry first</font>
00205         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb6">renderStaticGeometry</a>();
00206 
00207         <font class="comment">// Call superclass to render the rest</font>
00208         SceneManager::_renderVisibleObjects();
00209 
00210     }
00211 
00212     <font class="comment">//-----------------------------------------------------------------------</font>
00213     <font class="comment">// REMOVE THIS CRAP</font>
00214     <font class="comment">//-----------------------------------------------------------------------</font>
00215     <font class="comment">// Temp debug lines</font>
<a name="l00216"></a><a class="code" href="namespaceOgre.html#a347">00216</a>     <font class="keywordtype">bool</font> <a class="code" href="namespaceOgre.html#a347">firstTime</a> = <font class="keyword">true</font>;
<a name="l00217"></a><a class="code" href="namespaceOgre.html#a348">00217</a>     std::ofstream <a class="code" href="namespaceOgre.html#a348">of</a>;
00218     <font class="comment">//-----------------------------------------------------------------------</font>
00219     <font class="comment">//-----------------------------------------------------------------------</font>
00220     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00221"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb0">00221</a>     <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* BspSceneManager::walkTree(<a class="code" href="classOgre_1_1Camera.html">Camera</a>* camera)
00222     {
00223         <font class="comment">// Locate the leaf node where the camera is located</font>
00224         <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* cameraNode = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela6">findLeaf</a>(camera-&gt;<a class="code" href="classOgre_1_1Camera.html#Ogre_1_1Cameraa10">getPosition</a>());
00225 
00226         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern2">mMatFaceGroupMap</a>.clear();
00227         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern1">mFaceGroupSet</a>.clear();
00228         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> = 0;
00229         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> = 0;
00230 
00231         <font class="comment">// Scan through all the other leaf nodes looking for visibles</font>
00232         <font class="keywordtype">int</font> i = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln1">mNumNodes</a> - <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a>;
00233         <a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* nd = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln0">mRootNode</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln3">mLeafStart</a>;
00234 
00235         <font class="comment">/*</font>
00236 <font class="comment">        if (firstTime)</font>
00237 <font class="comment">        {</font>
00238 <font class="comment">            camera-&gt;getViewMatrix(); // Force update view before report</font>
00239 <font class="comment">            of.open("BspSceneManager.log");</font>
00240 <font class="comment">            of &lt;&lt; *camera &lt;&lt; std::endl;</font>
00241 <font class="comment">            of &lt;&lt; "Camera Node: " &lt;&lt; *cameraNode &lt;&lt; std::endl;</font>
00242 <font class="comment">            of &lt;&lt; "Vertex Data: " &lt;&lt; std::endl;</font>
00243 <font class="comment">            for (int testi = 0; testi &lt; mLevel-&gt;mNumVertices; ++testi)</font>
00244 <font class="comment">            {</font>
00245 <font class="comment">                of &lt;&lt; " " &lt;&lt; testi &lt;&lt; ": pos(" &lt;&lt;</font>
00246 <font class="comment">                  mLevel-&gt;mVertices[testi].position[0] &lt;&lt; ", " &lt;&lt;</font>
00247 <font class="comment">                    mLevel-&gt;mVertices[testi].position[1] &lt;&lt; ", " &lt;&lt; mLevel-&gt;mVertices[testi].position[2] &lt;&lt; ")" &lt;&lt;</font>
00248 <font class="comment">                    " uv(" &lt;&lt; mLevel-&gt;mVertices[testi].texcoords[0] &lt;&lt; ", " &lt;&lt; mLevel-&gt;mVertices[testi].texcoords[1] &lt;&lt; ")" &lt;&lt;</font>
00249 <font class="comment">                    " lm(" &lt;&lt; mLevel-&gt;mVertices[testi].lightmap[0] &lt;&lt; ", " &lt;&lt; mLevel-&gt;mVertices[testi].lightmap[1] &lt;&lt; ")" &lt;&lt; std::endl;</font>
00250 <font class="comment">            }</font>
00251 <font class="comment">            of &lt;&lt; "Element data:" &lt;&lt; std::endl;</font>
00252 <font class="comment">            for (testi = 0; testi &lt; mLevel-&gt;mNumElements; ++testi)</font>
00253 <font class="comment">            {</font>
00254 <font class="comment">                of &lt;&lt; " " &lt;&lt; testi &lt;&lt; ": " &lt;&lt; mLevel-&gt;mElements[testi] &lt;&lt; std::endl;</font>
00255 <font class="comment"></font>
00256 <font class="comment">            }</font>
00257 <font class="comment">        }</font>
00258 <font class="comment">        */</font>
00259 
00260         <font class="keywordflow">while</font> (i--)
00261         {
00262             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLevela4">isLeafVisible</a>(cameraNode, nd))
00263             {
00264 
00265                 <font class="comment">// Visible according to PVS, check bounding box against frustum</font>
00266                 <a class="code" href="namespaceOgre.html#a425">FrustumPlane</a> plane;
00267                 <font class="keywordflow">if</font> (camera-&gt;<a class="code" href="classOgre_1_1Camera.html#Ogre_1_1Cameraa35">isVisible</a>(nd-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea9">getBoundingBox</a>(), &amp;plane))
00268                 {
00269                     <font class="comment">//if (firstTime)</font>
00270                     <font class="comment">//{</font>
00271                     <font class="comment">//    of &lt;&lt; "Visible Node: " &lt;&lt; *nd &lt;&lt; std::endl;</font>
00272                     <font class="comment">//}</font>
00273                     <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb1">processVisibleLeaf</a>(nd, camera);
00274                     <font class="keywordflow">if</font> (mShowNodeAABs)
00275                         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb5">addBoundingBox</a>(nd-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea9">getBoundingBox</a>(), <font class="keyword">true</font>);
00276                 }
00277             }
00278             nd++;
00279         }
00280 
00281 
00282         <font class="comment">// TEST</font>
00283         <font class="comment">//if (firstTime)</font>
00284         <font class="comment">//{</font>
00285         <font class="comment">//    of.close();</font>
00286         <font class="comment">//    firstTime = false;</font>
00287         <font class="comment">//}</font>
00288         <font class="keywordflow">return</font> cameraNode;
00289 
00290     }
00291     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00292"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb1">00292</a>     <font class="keywordtype">void</font> BspSceneManager::processVisibleLeaf(<a class="code" href="classOgre_1_1BspNode.html">BspNode</a>* leaf, <a class="code" href="classOgre_1_1Camera.html">Camera</a>* cam)
00293     {
00294         <a class="code" href="classOgre_1_1Material.html">Material</a>* pMat;
00295         <font class="comment">// Parse the leaf node's faces, add face groups to material map</font>
00296         <font class="keywordtype">int</font> numGroups = leaf-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea10">getNumFaceGroups</a>();
00297         <font class="keywordtype">int</font> idx = leaf-&gt;<a class="code" href="classOgre_1_1BspNode.html#Ogre_1_1BspNodea11">getFaceGroupStart</a>();
00298 
00299         <font class="keywordflow">while</font> (numGroups--)
00300         {
00301             <font class="keywordtype">int</font> realIndex = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln6">mLeafFaceGroups</a>[idx++];
00302             <font class="comment">// Check not already included</font>
00303             <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern1">mFaceGroupSet</a>.find(realIndex) != <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern1">mFaceGroupSet</a>.end())
00304                 <font class="keywordflow">continue</font>;
00305             <a class="code" href="structOgre_1_1StaticFaceGroup.html">StaticFaceGroup</a>* faceGroup = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln8">mFaceGroups</a> + realIndex;
00306             <font class="comment">// Get Material pointer by handle</font>
00307             pMat = <a class="code" href="classOgre_1_1SceneManager.html#Ogre_1_1SceneManagera15">getMaterial</a>(faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm6">materialHandle</a>);
00308             <font class="comment">// Check normal (manual culling)</font>
00309             <a class="code" href="namespaceOgre.html#a431">ManualCullingMode</a> cullMode = pMat-&gt;<a class="code" href="classOgre_1_1Material.html#Ogre_1_1Materiala38">getManualCullingMode</a>();
00310             <font class="keywordflow">if</font> (cullMode != <a class="code" href="namespaceOgre.html#a431a87">MANUAL_CULL_NONE</a>)
00311             {
00312                 <a class="code" href="namespaceOgre.html#a281">Real</a> dist = faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm7">plane</a>.<a class="code" href="classOgre_1_1Plane.html#Ogre_1_1Planea6">getDistance</a>(cam-&gt;<a class="code" href="classOgre_1_1Camera.html#Ogre_1_1Cameraa10">getPosition</a>());
00313                 <font class="keywordflow">if</font> ( (dist &lt; 0 &amp;&amp; cullMode == <a class="code" href="namespaceOgre.html#a431a88">MANUAL_CULL_BACK</a>) ||
00314                      (dist &gt; 0 &amp;&amp; cullMode == <a class="code" href="namespaceOgre.html#a431a89">MANUAL_CULL_FRONT</a>) )
00315                     <font class="keywordflow">continue</font>; <font class="comment">// skip</font>
00316             }
00317             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern1">mFaceGroupSet</a>.insert(realIndex);
00318             <font class="comment">// Try to insert, will find existing if already there</font>
00319             std::pair&lt;MaterialFaceGroupMap::iterator, bool&gt; matgrpi;
00320             matgrpi = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern2">mMatFaceGroupMap</a>.insert(
00321                 MaterialFaceGroupMap::value_type(pMat, std::vector&lt;StaticFaceGroup*&gt;())
00322                 );
00323             <font class="comment">// Whatever happened, matgrpi.first is map iterator</font>
00324             <font class="comment">// Need to get second part of that to get vector</font>
00325             matgrpi.first-&gt;second.push_back(faceGroup);
00326 
00327             <font class="comment">//if (firstTime)</font>
00328             <font class="comment">//{</font>
00329             <font class="comment">//    of &lt;&lt; "  Emitting faceGroup: index=" &lt;&lt; realIndex &lt;&lt; ", " &lt;&lt; *faceGroup &lt;&lt; std::endl;</font>
00330             <font class="comment">//}</font>
00331         }
00332 
00333 
00334     }
00335     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00336"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb2">00336</a>     <font class="keywordtype">void</font> BspSceneManager::clearGeometryCaches(<font class="keywordtype">void</font>)
00337     {
00338         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> = 0;
00339         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> = 0;
00340 
00341 
00342     }
00343     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00344"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb3">00344</a>     <font class="keywordtype">void</font> BspSceneManager::cacheGeometry(<font class="keyword">const</font> <a class="code" href="structOgre_1_1StaticFaceGroup.html">StaticFaceGroup</a>* faceGroup)
00345     {
00346         <font class="comment">// Skip sky always</font>
00347         <font class="keywordflow">if</font> (faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm1">isSky</a>)
00348             <font class="keywordflow">return</font>;
00349 
00350         <font class="keywordflow">if</font> (faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm0">fType</a> == <a class="code" href="namespaceOgre.html#a442a316">FGT_FACE_LIST</a>)
00351         {
00352 
00353             <font class="comment">// Copy vertex data</font>
00354             memcpy((<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspLevel::BspVertex</a>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>,
00355                 <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln4">mVertices</a> + faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm2">vertexStart</a>,
00356                 <font class="keyword">sizeof</font>(<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspLevel::BspVertex</a>) * faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm3">numVertices</a>);
00357 
00358             <font class="comment">// Copy indexes</font>
00359             <font class="comment">// NB indexes are 4-byte integers in source, must be 2-byte shorts in rendering op</font>
00360             <font class="comment">// Also indexes have to be made relative to start of cache buffer</font>
00361             <font class="comment">// So have to loop rather than memcpy</font>
00362             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>* dest = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a>;
00363             <font class="keywordtype">int</font>* src = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln10">mElements</a> + faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm4">elementStart</a>;
00364             <font class="keywordtype">int</font> numElems = faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm5">numElements</a>;
00365             <font class="keywordflow">while</font> (numElems--)
00366             {
00367                 <font class="comment">// Is relative to elementStart in faceGroup</font>
00368                 <font class="comment">// Make relative to cache start, i.e. offset by vertices done already</font>
00369                 *dest++ = (*src++) + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00370             }
00371 
00372             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> += faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm3">numVertices</a>;
00373             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> += faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm5">numElements</a>;
00374         }
00375         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm0">fType</a> == <a class="code" href="namespaceOgre.html#a442a317">FGT_PATCH</a>)
00376         {
00377             <font class="comment">// Get mesh data</font>
00378             <font class="comment">// NB for now, subdivision level is preset</font>
00379             <font class="comment">// TODO: maybe dynamic based on frame rate?</font>
00380             <a class="code" href="classOgre_1_1Mesh.html">Mesh</a>* msh;
00381             <a class="code" href="classOgre_1_1SubMesh.html">SubMesh</a>* smsh;
00382             msh = faceGroup-&gt;<a class="code" href="structOgre_1_1StaticFaceGroup.html#Ogre_1_1StaticFaceGroupm8">patchSurf</a>-&gt;<a class="code" href="classOgre_1_1PatchSurface.html#Ogre_1_1PatchSurfacea5">getMesh</a>();
00383             smsh = msh-&gt;<a class="code" href="classOgre_1_1Mesh.html#Ogre_1_1Mesha6">getSubMesh</a>(0);
00384 
00385             <font class="comment">// Copy vertex data from mesh in patch</font>
00386             memcpy((<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspLevel::BspVertex</a>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>,
00387                 msh-&gt;<a class="code" href="classOgre_1_1Mesh.html#Ogre_1_1Meshm0">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam5">pVertices</a>,
00388                 <font class="keyword">sizeof</font>(<a class="code" href="structOgre_1_1BspLevel_1_1BspVertex.html">BspLevel::BspVertex</a>) * msh-&gt;<a class="code" href="classOgre_1_1Mesh.html#Ogre_1_1Meshm0">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a>);
00389 
00390             <font class="comment">// Copy indexes</font>
00391             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>* dest = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a>;
00392             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>* src = smsh-&gt;<a class="code" href="classOgre_1_1SubMesh.html#Ogre_1_1SubMeshm4">faceVertexIndices</a>;
00393             <font class="keywordtype">int</font> numElems = smsh-&gt;<a class="code" href="classOgre_1_1SubMesh.html#Ogre_1_1SubMeshm3">numFaces</a> * 3;
00394             <font class="keywordflow">while</font> (numElems--)
00395             {
00396                 <font class="comment">// Is relative to start of mesh vertices</font>
00397                 <font class="comment">// Make relative to cache start, i.e. offset by vertices done already</font>
00398                 *dest++ = (*src++) + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00399             }
00400 
00401             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> += msh-&gt;<a class="code" href="classOgre_1_1Mesh.html#Ogre_1_1Meshm0">sharedGeometry</a>.<a class="code" href="structOgre_1_1GeometryData.html#Ogre_1_1GeometryDatam0">numVertices</a>;
00402             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> += smsh-&gt;<a class="code" href="classOgre_1_1SubMesh.html#Ogre_1_1SubMeshm3">numFaces</a> * 3;
00403 
00404 
00405         }
00406 
00407 
00408     }
00409 
00410     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00411"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb4">00411</a>     <font class="keywordtype">void</font> BspSceneManager::freeMemory(<font class="keywordtype">void</font>)
00412     {
00413         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a>)
00414         {
00415             <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a>;
00416             <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a>;
00417             <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a>;
00418             <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a>;
00419             <font class="keyword">delete</font> [] <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm11">pDiffuseColour</a>;
00420 
00421             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = 0;
00422             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern3">mPendingGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> = 0;
00423             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> = 0;
00424             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> = 0;
00425             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm11">pDiffuseColour</a>;
00426 
00427         }
00428     }
00429     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00430"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera3">00430</a>     <font class="keywordtype">void</font> BspSceneManager::showNodeBoxes(<font class="keywordtype">bool</font> show)
00431     {
00432         <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern4">mShowNodeAABs</a> = show;
00433     }
00434     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00435"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagerb5">00435</a>     <font class="keywordtype">void</font> BspSceneManager::addBoundingBox(<a class="code" href="classOgre_1_1AxisAlignedBox.html">AxisAlignedBox</a>&amp; aab, <font class="keywordtype">bool</font> visible)
00436     {
00437         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> visibleColour;
00438         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nonVisibleColour;
00439         <a class="code" href="classOgre_1_1Root.html">Root</a>&amp; r = Root::getSingleton();
00440 
00441         r.<a class="code" href="classOgre_1_1Root.html#Ogre_1_1Roota20">convertColourValue</a>(ColourValue::White, &amp;visibleColour);
00442         r.<a class="code" href="classOgre_1_1Root.html#Ogre_1_1Roota20">convertColourValue</a>(ColourValue::Blue, &amp;nonVisibleColour);
00443         <font class="keywordflow">if</font> (mShowNodeAABs)
00444         {
00445             <font class="comment">// Add set of lines</font>
00446             <a class="code" href="namespaceOgre.html#a281">Real</a>* pVertices = (<a class="code" href="namespaceOgre.html#a281">Real</a>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm3">pVertices</a> + (<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>*3);
00447             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>* pIndexes = <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm16">pIndexes</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a>;
00448             <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>* pColours = (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>*)<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm11">pDiffuseColour</a> + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00449 
00450             <font class="keyword">const</font> <a class="code" href="classOgre_1_1Vector3.html">Vector3</a>* pCorner = aab.<a class="code" href="classOgre_1_1AxisAlignedBox.html#Ogre_1_1AxisAlignedBoxa11">getAllCorners</a>();
00451 
00452             <font class="keywordtype">int</font> i;
00453             <font class="keywordflow">for</font> (i = 0; i &lt; 8; ++i)
00454             {
00455                 *pVertices++ = pCorner-&gt;<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m0">x</a>;
00456                 *pVertices++ = pCorner-&gt;<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m1">y</a>;
00457                 *pVertices++ = pCorner-&gt;<a class="code" href="classOgre_1_1Vector3.html#Ogre_1_1Vector3m2">z</a>;
00458                 pCorner++;
00459 
00460                 <font class="keywordflow">if</font> (visible)
00461                 {
00462                     *pColours++ = visibleColour;
00463                 }
00464                 <font class="keywordflow">else</font>
00465                 {
00466                     *pColours++ = nonVisibleColour;
00467                 }
00468 
00469             }
00470 
00471             *pIndexes++ = 0 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00472             *pIndexes++ = 1 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00473             *pIndexes++ = 1 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00474             *pIndexes++ = 2 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00475             *pIndexes++ = 2 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00476             *pIndexes++ = 3 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00477             *pIndexes++ = 3 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00478             *pIndexes++ = 1 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00479             *pIndexes++ = 4 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00480             *pIndexes++ = 5 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00481             *pIndexes++ = 5 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00482             *pIndexes++ = 6 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00483             *pIndexes++ = 6 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00484             *pIndexes++ = 7 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00485             *pIndexes++ = 7 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00486             *pIndexes++ = 4 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00487             *pIndexes++ = 1 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00488             *pIndexes++ = 5 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00489             *pIndexes++ = 2 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00490             *pIndexes++ = 4 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00491             *pIndexes++ = 0 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00492             *pIndexes++ = 6 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00493             *pIndexes++ = 3 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00494             *pIndexes++ = 7 + <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a>;
00495 
00496 
00497             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm1">numVertices</a> += 8;
00498             <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern5">mAABGeometry</a>.<a class="code" href="classOgre_1_1RenderOperation.html#Ogre_1_1RenderOperationm17">numIndexes</a> += 24;
00499 
00500 
00501         }
00502 
00503 
00504     }
00505     <font class="comment">//-----------------------------------------------------------------------</font>
<a name="l00506"></a><a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagera4">00506</a>     <a class="code" href="structOgre_1_1ViewPoint.html">ViewPoint</a> BspSceneManager::getSuggestedViewpoint(<font class="keywordtype">bool</font> random)
00507     {
00508         <font class="keywordflow">if</font> (!<a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a> || <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln12">mPlayerStarts</a>.size() == 0)
00509         {
00510             <font class="comment">// No level, use default</font>
00511             <font class="keywordflow">return</font> SceneManager::getSuggestedViewpoint(random);
00512         }
00513         <font class="keywordflow">else</font>
00514         {
00515             <font class="keywordflow">if</font> (random)
00516             {
00517                 <font class="keywordtype">int</font> idx = Math::getSingleton().UnitRandom() * <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln12">mPlayerStarts</a>.size();
00518                 <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln12">mPlayerStarts</a>[idx];
00519             }
00520             <font class="keywordflow">else</font>
00521             {
00522                 <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1BspSceneManager.html#Ogre_1_1BspSceneManagern0">mLevel</a>-&gt;<a class="code" href="classOgre_1_1BspLevel.html#Ogre_1_1BspLeveln12">mPlayerStarts</a>[0];
00523             }
00524 
00525 
00526         }
00527 
00528     }
00529 
00530 
00531 
00532 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
