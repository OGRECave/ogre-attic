<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreDDDriver.cpp</h1><a href="OgreDDDriver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "<a class="code" href="OgreD3D7RenderSystem_8h.html">OgreD3D7RenderSystem.h</a>"</font>
00026 <font class="preprocessor">#include "<a class="code" href="OgreDDDriver_8h.html">OgreDDDriver.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreDDVideoModeList_8h.html">OgreDDVideoModeList.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreDDVideoMode_8h.html">OgreDDVideoMode.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreD3D7DeviceList_8h.html">OgreD3D7DeviceList.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreD3D7Device_8h.html">OgreD3D7Device.h</a>"</font>
00031 <font class="preprocessor">#include "png.h"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreLogManager_8h.html">OgreLogManager.h</a>"</font>
00033 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreBitwise_8h.html">OgreBitwise.h</a>"</font>
00035 
00036 <font class="keyword">namespace </font>Ogre {
<a name="l00037"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera7">00037</a>     <a class="code" href="classOgre_1_1DDDriver.html">DDDriver</a> DDDriver::operator=(<font class="keyword">const</font> <a class="code" href="classOgre_1_1DDDriver.html">DDDriver</a> &amp;orig)
00038     {
00039 
00040 
00041         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a>;
00042         <font class="comment">//mDriverDesc = new char(strlen(orig.mDriverDesc) + 1);</font>
00043         <font class="comment">//strcpy(mDriverDesc, orig.mDriverDesc);</font>
00044         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a>;
00045         <font class="comment">//mDriverName = new char(strlen(orig.mDriverName)+1);</font>
00046         <font class="comment">//strcpy(mDriverName, orig.mDriverName);</font>
00047         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a>;
00048         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a>;
00049         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a>;
00050         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a>;
00051         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a>;
00052         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>;
00053         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a>;
00054         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>;
00055         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>;
00056         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a>;
00057         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>;
00058         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a>;
00059         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a> = orig.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a>;
00060 
00061 
00062         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00063 
00064     }
00065 
00066     <font class="comment">// Default constructor</font>
<a name="l00067"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera0">00067</a>     DDDriver::DDDriver()
00068     {
00069         <font class="comment">// Init pointers</font>
00070         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a> = NULL;
00071         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a> = 0;
00072         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a> = NULL;
00073         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a> = NULL;
00074         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a> = NULL;
00075         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a> = NULL;
00076         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a> = NULL;
00077         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a> = NULL;
00078         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a> = NULL;
00079         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a> = NULL;
00080 
00081 
00082     }
00083 
<a name="l00084"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera3">00084</a>     DDDriver::~DDDriver()
00085     {
00086         <font class="comment">// Delete related system objects</font>
00087         <font class="comment">//if (mDeviceList)</font>
00088             <font class="comment">//delete mDeviceList;</font>
00089         <font class="comment">//if (mVideoModeList)</font>
00090             <font class="comment">//delete mVideoModeList;</font>
00091 
00092     }
00093 
00094 
00095     <font class="comment">// Copy Constructor</font>
<a name="l00096"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera1">00096</a>     DDDriver::DDDriver(<font class="keyword">const</font> <a class="code" href="classOgre_1_1DDDriver.html">DDDriver</a> &amp;ob)
00097     {
00098 
00099 
00100         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a>;
00101         <font class="comment">//mDriverDesc = new char(strlen(ob.mDriverDesc) + 1);</font>
00102         <font class="comment">//strcpy(mDriverDesc, ob.mDriverDesc);</font>
00103         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a>;
00104         <font class="comment">//mDriverName = new char(strlen(ob.mDriverName)+1);</font>
00105         <font class="comment">//strcpy(mDriverName, ob.mDriverName);</font>
00106         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a>;
00107         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a>;
00108         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a>;
00109         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a>;
00110         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a>;
00111         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>;
00112         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a>;
00113         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>;
00114         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>;
00115         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a>;
00116         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>;
00117         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a>;
00118         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a> = ob.<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a>;
00119 
00120     }
00121 
00122     <font class="comment">// Constructor with enumeration details</font>
<a name="l00123"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera2">00123</a>     DDDriver::DDDriver(GUID FAR *lpGuid,
00124                                 LPSTR lpDriverDescription,
00125                                 LPSTR lpDriverName)
00126     {
00127         HRESULT hr;
00128 
00129         <font class="comment">// Init pointers</font>
00130         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a> = NULL;
00131         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a> = 0;
00132         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a> = NULL;
00133         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a> = NULL;
00134         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a> = NULL;
00135         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero18">lpDDClipper</a> = NULL;
00136         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a> = NULL;
00137         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a> = NULL;
00138         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a> = NULL;
00139         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a> = NULL;
00140 
00141         <font class="comment">// Copy GUID, Description and Name</font>
00142         <font class="comment">// Deal with NULL (default display driver)</font>
00143         <font class="keywordflow">if</font> (lpGuid)
00144         {
00145             memcpy(&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a>, lpGuid, <font class="keyword">sizeof</font>(GUID));
00146             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a> = <font class="keyword">false</font>;
00147         }
00148         <font class="keywordflow">else</font>
00149             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero3">mPrimaryDisplay</a> = <font class="keyword">true</font>;
00150 
00151 
00152         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a> = <a class="code" href="classOgre_1_1String.html">String</a>(lpDriverDescription);
00153         <font class="comment">//mDriverDesc = new char(strlen(lpDriverDescription)+1);</font>
00154         <font class="comment">//strcpy(mDriverDesc, lpDriverDescription);</font>
00155 
00156         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a> = <a class="code" href="classOgre_1_1String.html">String</a>(lpDriverName);
00157         <font class="comment">//mDriverName = new char(strlen(lpDriverName)+1);</font>
00158         <font class="comment">//strcpy(mDriverName, lpDriverName);</font>
00159 
00160 
00161         <font class="comment">// Get capabilities</font>
00162         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>.dwSize = <font class="keyword">sizeof</font>(DDCAPS);
00163         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a>.dwSize = <font class="keyword">sizeof</font>(DDCAPS);
00164 
00165         hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;GetCaps(&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>, &amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero11">mSWCaps</a>);
00166         <font class="keywordflow">if</font> (FAILED(hr))
00167             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot get direct draw driver capabilities."</font>,
00168                 <font class="stringliteral">"DIM_DDDriver - directDraw()"</font>);
00169 
00170 
00171     }
00172 
<a name="l00173"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera4">00173</a>     <font class="keywordtype">void</font> DDDriver::createWindowSurfaces(HWND hWnd, <font class="keywordtype">int</font> width, <font class="keywordtype">int</font> height, <font class="keywordtype">int</font> colourDepth, <font class="keywordtype">bool</font> fullScreen,
00174             LPDIRECTDRAWSURFACE7 *front, LPDIRECTDRAWSURFACE7 *back)
00175     {
00176 
00177         <font class="keywordtype">char</font> msg[150];
00178         DWORD dwFlags;
00179         DDSURFACEDESC2 ddsd;
00180         HRESULT hr;
00181         DDSCAPS2 ddscaps;
00182         LPDIRECTDRAWCLIPPER clip;
00183 
00184         LogManager::getSingleton().logMessage(<font class="stringliteral">"Creating DirectDraw surfaces for window with dimensions:"</font>);
00185 
00186         <font class="keywordflow">if</font> (fullScreen)
00187             sprintf(msg, <font class="stringliteral">"  FULLSCREEN w:%i h:%i bpp:%i"</font>, width, height, colourDepth);
00188         <font class="keywordflow">else</font>
00189             sprintf(msg, <font class="stringliteral">"  WINDOWED w:%i h:%i"</font>, width, height);
00190 
00191         LogManager::getSingleton().logMessage(msg);
00192 
00193         <font class="comment">// Set co-op level</font>
00194         <font class="keywordflow">if</font> (fullScreen)
00195         {
00196             dwFlags = DDSCL_FULLSCREEN | DDSCL_EXCLUSIVE;
00197         }
00198         <font class="keywordflow">else</font>
00199         {
00200             dwFlags = DDSCL_NORMAL;
00201         }
00202 
00203         <font class="comment">// Also set FPU cooperative mode (optimisation)</font>
00204         dwFlags = dwFlags | DDSCL_FPUSETUP;
00205 
00206         hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;SetCooperativeLevel(hWnd, dwFlags);
00207         <font class="keywordflow">if</font> (FAILED(hr))
00208             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error setting cooperative mode"</font>,
00209                 <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00210 
00211 
00212         <font class="comment">// Create surfaces</font>
00213         <font class="comment">// If we're running fullscreen, create a complex flipping</font>
00214         <font class="comment">// chain surface (implicit back buffer)</font>
00215         <font class="comment">// Otherwise we need separate back buffers</font>
00216 
00217         <font class="keywordflow">if</font> (fullScreen)
00218         {
00219             <font class="comment">// Set Video Mode</font>
00220             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>-&gt;SetDisplayMode(width, height, colourDepth, 0, 0);
00221             <font class="keywordflow">if</font> (FAILED(hr))
00222                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Unable to set fullScreen display mode."</font>, <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00223 
00224             <font class="comment">// Set up surfaces</font>
00225             ZeroMemory( &amp;ddsd, <font class="keyword">sizeof</font>(DDSURFACEDESC2) );
00226             ddsd.dwSize = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00227             ddsd.dwFlags = DDSD_CAPS | DDSD_BACKBUFFERCOUNT;
00228             ddsd.ddsCaps.dwCaps = DDSCAPS_COMPLEX |
00229                 DDSCAPS_FLIP | DDSCAPS_PRIMARYSURFACE | DDSCAPS_3DDEVICE;
00230 
00231             <font class="comment">// Create a single back buffer</font>
00232             ddsd.dwBackBufferCount = 1;
00233             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;CreateSurface(&amp;ddsd,front,NULL);
00234             <font class="keywordflow">if</font> (FAILED(hr))
00235                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating linked surface buffers"</font>,
00236                     <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00237 
00238             <font class="comment">// Get back buffer</font>
00239             ZeroMemory(&amp;ddscaps, <font class="keyword">sizeof</font>(DDSCAPS2));
00240             ddscaps.dwCaps = DDSCAPS_BACKBUFFER;
00241             hr = (*front)-&gt;GetAttachedSurface(&amp;ddscaps, back);
00242 
00243             <font class="keywordflow">if</font> (FAILED(hr))
00244                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error retrieving linked back buffer"</font>,
00245                     <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00246 
00247             LogManager::getSingleton().logMessage(<font class="stringliteral">"Successfully created full screen rendering surface / flipping chain."</font>);
00248         }
00249         <font class="keywordflow">else</font>
00250         {
00251             <font class="comment">// Explicitly create front and back buffers, and create</font>
00252             <font class="comment">// a clipper object</font>
00253 
00254             <font class="comment">// Standard non-auto-flip primary</font>
00255             ZeroMemory( &amp;ddsd, <font class="keyword">sizeof</font>(DDSURFACEDESC2) );
00256             ddsd.dwSize  = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00257             ddsd.dwFlags = DDSD_CAPS;
00258             ddsd.ddsCaps.dwCaps = DDSCAPS_PRIMARYSURFACE;
00259             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;CreateSurface(&amp;ddsd,front,NULL);
00260             <font class="keywordflow">if</font> (FAILED(hr))
00261                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating primary surface buffer"</font>,
00262                     <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00263 
00264 
00265             <font class="comment">// Create offscreen buffer</font>
00266             ddsd.dwFlags = DDSD_WIDTH | DDSD_HEIGHT | DDSD_CAPS;
00267             ddsd.ddsCaps.dwCaps = DDSCAPS_OFFSCREENPLAIN |
00268                 DDSCAPS_3DDEVICE;
00269             <font class="comment">// Set the dimensions of the back buffer. Note that if our window changes</font>
00270             <font class="comment">// size, we need to destroy this surface and create a new one.</font>
00271             ddsd.dwWidth  = width;
00272             ddsd.dwHeight = height;
00273             <font class="comment">// Create the back buffer. The most likely reason for failure is running</font>
00274             <font class="comment">// out of video memory. (A more sophisticated app should handle this.)</font>
00275             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;CreateSurface( &amp;ddsd, back, NULL );
00276             <font class="keywordflow">if</font>( FAILED( hr ) )
00277                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating back surface buffer"</font>,
00278                     <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00279 
00280             LogManager::getSingleton().logMessage(<font class="stringliteral">"Windowed mode rendering &amp; display surfaces created."</font>);
00281 
00282             <font class="comment">// Create clipper</font>
00283             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">directDraw</a>()-&gt;CreateClipper(0, &amp;clip, NULL);
00284             <font class="keywordflow">if</font> (FAILED(hr))
00285                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error creating clipper"</font>,
00286                     <font class="stringliteral">"DDDriver - createWindowSurfaces"</font>);
00287 
00288             <font class="comment">// Assign it to the window</font>
00289             clip-&gt;SetHWnd(0,hWnd);
00290             <font class="comment">// Assign it to primary surface</font>
00291             (*front)-&gt;SetClipper(clip);
00292             clip-&gt;Release();
00293 
00294             LogManager::getSingleton().logMessage(<font class="stringliteral">"Window clipper created."</font>);
00295 
00296         }
00297 
00298 
00299 
00300     }
00301 
00302 
<a name="l00303"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera8">00303</a>     <a class="code" href="classOgre_1_1String.html">String</a> DDDriver::DriverName(<font class="keywordtype">void</font>)
00304     {
00305         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero0">mDriverName</a>;
00306     }
00307 
<a name="l00308"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera9">00308</a>     <a class="code" href="classOgre_1_1String.html">String</a> DDDriver::DriverDescription(<font class="keywordtype">void</font>)
00309     {
00310         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero1">mDriverDesc</a>;
00311     }
00312 
<a name="l00313"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera11">00313</a>     <a class="code" href="classOgre_1_1D3DDeviceList.html">D3DDeviceList</a>* DDDriver::get3DDeviceList(<font class="keywordtype">void</font>)
00314     {
00315         <font class="keywordflow">if</font> (!<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a>)
00316             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a> = <font class="keyword">new</font> <a class="code" href="classOgre_1_1D3DDeviceList.html">D3DDeviceList</a>(<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a>);
00317 
00318         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero6">mDeviceList</a>;
00319     }
00320 
<a name="l00321"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera12">00321</a>     <a class="code" href="classOgre_1_1DDVideoModeList.html">DDVideoModeList</a>* DDDriver::getVideoModeList(<font class="keywordtype">void</font>)
00322     {
00323         <font class="keywordflow">if</font> (!<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a>)
00324             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a> = <font class="keyword">new</font> <a class="code" href="classOgre_1_1DDVideoModeList.html">DDVideoModeList</a>(<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>);
00325 
00326         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero7">mVideoModeList</a>;
00327     }
00328 
<a name="l00329"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera13">00329</a>     <a class="code" href="classOgre_1_1DDVideoMode.html">DDVideoMode</a>* DDDriver::getActiveVideoMode(<font class="keywordtype">void</font>)
00330     {
00331         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero9">activeVideoMode</a>;
00332     }
00333 
00334 
<a name="l00335"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera14">00335</a>     <a class="code" href="classOgre_1_1D3DDevice.html">D3DDevice</a>* DDDriver::get3DDevice(<font class="keywordtype">void</font>)
00336     {
00337         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a>;
00338     }
00339 
00340 
<a name="l00341"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera10">00341</a>     LPDIRECTDRAW7 DDDriver::directDraw()
00342     {
00343         HRESULT rVal;
00344 
00345         <font class="keywordflow">if</font> (!<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>)
00346         {
00347             <font class="comment">// We need to create a direct draw object</font>
00348             <font class="comment">// Create with GUID for this driver</font>
00349             <font class="keywordflow">if</font> (mPrimaryDisplay)
00350                 rVal = DirectDrawCreateEx( NULL, (VOID**)&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>, IID_IDirectDraw7, NULL );
00351             <font class="keywordflow">else</font>
00352                 rVal = DirectDrawCreateEx( &amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero2">mGuid</a>, (VOID**)&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>, IID_IDirectDraw7, NULL );
00353             <font class="keywordflow">if</font> (rVal != DD_OK)
00354                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(rVal, <font class="stringliteral">"Cannot create direct draw interface."</font>,
00355                     <font class="stringliteral">"DIM_DDDriver - directDraw()"</font>);
00356 
00357             <font class="comment">// Get Direct3D interface too</font>
00358             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>-&gt;QueryInterface(IID_IDirect3D7, (VOID**)&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a>);
00359 
00360 
00361         }
00362 
00363         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>;
00364     }
00365 
<a name="l00366"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera5">00366</a>     <font class="keywordtype">void</font> DDDriver::Cleanup(<font class="keywordtype">void</font>)
00367     {
00368         <font class="comment">// Tell 3D Device to clean itself up</font>
00369         <font class="keywordflow">if</font> (active3DDevice)
00370         {
00371             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero8">active3DDevice</a>-&gt;<a class="code" href="classOgre_1_1D3DDevice.html#Ogre_1_1D3DDevicea4">Cleanup</a>();
00372         }
00373 
00374         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a> &amp;&amp; <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>)
00375             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>-&gt;SetCooperativeLevel(<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a>, DDSCL_NORMAL);
00376 
00377         <font class="comment">// Release DirectX system objects</font>
00378 
00379         <font class="keywordflow">if</font> (lpDDSBack)
00380         {
00381             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>-&gt;Release();
00382             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a> = NULL;
00383         }
00384 
00385         <font class="keywordflow">if</font> (lpDDSPrimary)
00386         {
00387             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Release();
00388             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a> = NULL;
00389         }
00390 
00391         <font class="keywordflow">if</font> (lpD3D)
00392         {
00393             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a>-&gt;Release();
00394             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero5">lpD3D</a> = NULL;
00395         }
00396 
00397         <font class="keywordflow">if</font> (lpDD7)
00398         {
00399             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a>-&gt;Release();
00400             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero4">lpDD7</a> = NULL;
00401         }
00402 
00403 
00404 
00405 
00406     }
00407 
00408 
<a name="l00409"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera6">00409</a>     <font class="keywordtype">void</font> DDDriver::CheckWindow(<font class="keywordtype">void</font>)
00410     {
00411         <font class="comment">// If windowed mode, check window size &amp; position</font>
00412         RECT rcCheck;
00413 
00414         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera17">RunningFullScreen</a>())
00415             <font class="keywordflow">return</font>;
00416 
00417         GetClientRect( <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a>, &amp;rcCheck );
00418         ClientToScreen( <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a>, (POINT*)&amp;rcCheck.left );
00419         ClientToScreen( <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero10">activeHWnd</a>, (POINT*)&amp;rcCheck.right );
00420 
00421         <font class="comment">// Has the window resized? If so, we need to recreate surfaces</font>
00422         <font class="keywordflow">if</font> ((rcCheck.right - rcCheck.left !=
00423                 <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.right - <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.left) ||
00424             (rcCheck.bottom - rcCheck.top !=
00425                 <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.bottom - <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.top))
00426         {
00427             <font class="comment">// The window has changed size</font>
00428             <font class="comment">//g_DIMSystem-&gt;CleanupRenderer();</font>
00429             <font class="comment">//g_DIMSystem-&gt;Reinitialise();</font>
00430         }
00431         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (rcCheck.left != <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.left ||
00432             rcCheck.top != <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.top)
00433         {
00434             <font class="comment">// Window has only moved</font>
00435             <font class="comment">// Just alter the blit location</font>
00436             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a> = rcCheck;
00437         }
00438 
00439 
00440     }
00441 
00442 
<a name="l00443"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera16">00443</a>     <font class="keywordtype">void</font> DDDriver::FlipBuffers(<font class="keywordtype">void</font>)
00444     {
00445         HRESULT hr;
00446         <font class="keywordflow">if</font> (runningFullScreen)
00447         {
00448             <font class="comment">// Use flipping chain</font>
00449             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Flip(NULL,DDFLIP_WAIT);
00450 
00451 
00452         }
00453         <font class="keywordflow">else</font>
00454         {
00455             <font class="comment">// Ordinary Blit</font>
00456             RECT srcRect;
00457             srcRect.left = 0;
00458             srcRect.top = 0;
00459             srcRect.right = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.right - <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.left;
00460             srcRect.bottom = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.bottom - <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>.top;
00461             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Blt(&amp;<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>,<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>,&amp;srcRect,DDBLT_WAIT,NULL);
00462         }
00463 
00464         <font class="keywordflow">if</font> (hr == DDERR_SURFACELOST)
00465         {
00466             <font class="comment">// Restore surfaces</font>
00467             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDriverc1">RestoreSurfaces</a>();
00468         }
00469         <font class="keywordflow">else</font>
00470         {
00471             <font class="keywordflow">if</font> (FAILED(hr))
00472              <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr,<font class="stringliteral">"Error flipping surfaces"</font>, <font class="stringliteral">"DDDriver::FlipBuffers"</font>);
00473         }
00474 
00475     }
00476 
<a name="l00477"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDriverc1">00477</a>     <font class="keywordtype">void</font> DDDriver::RestoreSurfaces(<font class="keywordtype">void</font>)
00478     {
00479         HRESULT hr;
00480 
00481         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;IsLost())
00482         {
00483             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Restore();
00484             <font class="keywordflow">if</font> (FAILED(hr))
00485                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error restoring lost primary surface."</font>, <font class="stringliteral">"DDDriver - RestoreSurfaces"</font>);
00486         }
00487 
00488         <font class="keywordflow">if</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>-&gt;IsLost())
00489         {
00490             hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>-&gt;Restore();
00491             <font class="keywordflow">if</font> (FAILED(hr))
00492                 <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Error restoring lost back buffer surface."</font>, <font class="stringliteral">"DDDriver - RestoreSurfaces"</font>);
00493         }
00494 
00495     }
00496 
<a name="l00497"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera15">00497</a>     <font class="keywordtype">void</font> DDDriver::OutputText(<font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, <font class="keywordtype">char</font>* text)
00498     {
00499         HDC hDC;
00500 
00501         <font class="comment">// Get a DC for the surface. Then, write out the buffer</font>
00502         <font class="keywordflow">if</font>( lpDDSBack )
00503         {
00504             <font class="keywordflow">if</font>( SUCCEEDED( <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>-&gt;GetDC(&amp;hDC) ) )
00505             {
00506                 SetTextColor( hDC, RGB(255,255,0) );
00507                 SetBkMode( hDC, TRANSPARENT );
00508                 ExtTextOut( hDC, x, y, 0, NULL, text, lstrlen(text), NULL );
00509                 <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero14">lpDDSBack</a>-&gt;ReleaseDC(hDC);
00510             }
00511         }
00512     }
00513 
<a name="l00514"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera17">00514</a>     <font class="keywordtype">bool</font> DDDriver::RunningFullScreen(<font class="keywordtype">void</font>)
00515     {
00516         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero15">runningFullScreen</a>;
00517     }
00518 
<a name="l00519"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera18">00519</a>     RECT DDDriver::ViewportRect(<font class="keywordtype">void</font>)
00520     {
00521         <font class="keywordflow">return</font> <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero17">rcViewport</a>;
00522     }
00523 
<a name="l00524"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera20">00524</a>     <font class="keywordtype">bool</font> DDDriver::CanRenderWindowed(<font class="keywordtype">void</font>)
00525     {
00526         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>.dwCaps2 &amp; DDCAPS2_CANRENDERWINDOWED) &gt; 0;
00527     }
00528 
00529 
<a name="l00530"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera19">00530</a>     <font class="keywordtype">bool</font> DDDriver::Has3DAcceleration(<font class="keywordtype">void</font>)
00531     {
00532         <font class="keywordflow">return</font> (<a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero12">mHWCaps</a>.dwCaps &amp; DDCAPS_3D);
00533     }
00534 
00535 
00536 
<a name="l00537"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera21">00537</a>     <font class="keywordtype">void</font> DDDriver::GetDisplayDetails(<font class="keywordtype">int</font>&amp; width, <font class="keywordtype">int</font>&amp; height, <font class="keywordtype">int</font>&amp; colourDepth)
00538     {
00539         <font class="comment">// Get details from primary surface</font>
00540         <font class="comment">// This works for both windowed and fullscreen modes</font>
00541 
00542         DDSURFACEDESC2 ddsd;
00543 
00544 
00545         <font class="keywordflow">if</font> (lpDDSPrimary)
00546         {
00547             ZeroMemory(&amp;ddsd, <font class="keyword">sizeof</font>(DDSURFACEDESC2));
00548             ddsd.dwSize = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00549             <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;GetSurfaceDesc(&amp;ddsd);
00550 
00551             width = ddsd.dwWidth;
00552             height = ddsd.dwHeight;
00553             colourDepth = ddsd.ddpfPixelFormat.dwRGBBitCount;
00554         }
00555     }
00556 
<a name="l00557"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDriverc0">00557</a>     <font class="keywordtype">void</font> DDDriver::logCaps(<font class="keywordtype">void</font>)
00558     {
00559         <font class="comment">// Sends capabilities of this driver to the log</font>
00560         <font class="keywordtype">char</font> msg[255];
00561 
00562         LogManager::getSingleton().logMessage(<font class="stringliteral">"DirectDraw Driver Capabilities:"</font>);
00563 
00564         sprintf(msg, <font class="stringliteral">"  3D Acceleration: %i"</font>, <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera19">Has3DAcceleration</a>());
00565         LogManager::getSingleton().logMessage(msg);
00566 
00567         sprintf(msg, <font class="stringliteral">"  Render in a window: %i"</font>, <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera20">CanRenderWindowed</a>());
00568         LogManager::getSingleton().logMessage(msg);
00569 
00570 
00571 
00572     }
00573 
<a name="l00574"></a><a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivera22">00574</a>     <font class="keywordtype">void</font> DDDriver::takeScreenShot(<font class="keywordtype">void</font>)
00575     {
00576         HRESULT hr;
00577         DDSURFACEDESC2 ddsd;
00578         <font class="keyword">static</font> <font class="keywordtype">int</font> numPics = 0;
00579         <font class="keywordtype">char</font> filename[30];
00580         BYTE *pBuffer;
00581         BYTE **rowPointers;
00582         WORD *in16;
00583         DWORD *in32;
00584         BYTE *out8;
00585         FILE *fp;
00586         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> lRow, lCol;
00587 
00588 
00589         <font class="comment">// Lock front buffer</font>
00590         ddsd.dwSize = <font class="keyword">sizeof</font>(DDSURFACEDESC2);
00591         hr = <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Lock(NULL, &amp;ddsd, NULL, NULL);
00592 
00593         <font class="keywordflow">if</font> (FAILED(hr))
00594             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(hr, <font class="stringliteral">"Cannot lock surface."</font>,
00595                 <font class="stringliteral">"DDDriver::takeScreenShot"</font>);
00596 
00597         <font class="comment">// Copy screen contents into a buffer, doing translation</font>
00598         <font class="comment">// to PNG-compatible bit depth (8-bits per channel)</font>
00599         <font class="comment">// Also create row pointers that PNG encoding requires</font>
00600         pBuffer = (BYTE*)<a class="code" href="OgreMemoryMacros_8h.html#a2">malloc</a>(ddsd.ddpfPixelFormat.dwRGBBitCount *
00601                             ddsd.dwHeight * ddsd.dwWidth);
00602         rowPointers = (BYTE**)<a class="code" href="OgreMemoryMacros_8h.html#a2">malloc</a>(<font class="keyword">sizeof</font>(BYTE*) * ddsd.dwHeight);
00603         out8 = pBuffer;
00604         <font class="keywordflow">for</font> (lRow = 0; lRow &lt; ddsd.dwHeight; lRow++)
00605         {
00606             rowPointers[lRow] = pBuffer + (3 * ddsd.dwWidth * lRow);
00607             <font class="keywordflow">if</font>(ddsd.ddpfPixelFormat.dwRGBBitCount == 16)
00608                 in16 = (WORD*)ddsd.lpSurface + (ddsd.lPitch/2 * lRow);
00609             <font class="keywordflow">else</font>
00610                 in32 = (DWORD*)ddsd.lpSurface + (ddsd.lPitch/4 * lRow);
00611 
00612             <font class="keywordflow">for</font> (lCol = 0; lCol &lt; ddsd.dwWidth; lCol++)
00613             {
00614                 <font class="comment">// Convert each colour component to it's 8-bit</font>
00615                 <font class="comment">//   counterpart</font>
00616                 BYTE mask8 = 0xFF;
00617                 <font class="keywordflow">if</font>(ddsd.ddpfPixelFormat.dwRGBBitCount == 16)
00618                 {
00619                     Bitwise::convertBitPattern(in16, &amp;ddsd.ddpfPixelFormat.dwRBitMask, 16,
00620                                     out8++, &amp;mask8, 8);
00621                     Bitwise::convertBitPattern(in16, &amp;ddsd.ddpfPixelFormat.dwGBitMask, 16,
00622                                     out8++, &amp;mask8, 8);
00623                     Bitwise::convertBitPattern(in16, &amp;ddsd.ddpfPixelFormat.dwBBitMask, 16,
00624                                     out8++, &amp;mask8, 8);
00625                     in16++;
00626                 }
00627                 <font class="keywordflow">else</font>
00628                 {
00629                     Bitwise::convertBitPattern(in32, &amp;ddsd.ddpfPixelFormat.dwRBitMask, 32,
00630                                     out8++, &amp;mask8, 8);
00631                     Bitwise::convertBitPattern(in32, &amp;ddsd.ddpfPixelFormat.dwGBitMask, 32,
00632                                     out8++, &amp;mask8, 8);
00633                     Bitwise::convertBitPattern(in32, &amp;ddsd.ddpfPixelFormat.dwBBitMask, 32,
00634                                     out8++, &amp;mask8, 8);
00635                     in32++;
00636                 }
00637             }
00638         }
00639 
00640         <font class="comment">// Unlock surface</font>
00641         <a class="code" href="classOgre_1_1DDDriver.html#Ogre_1_1DDDrivero13">lpDDSPrimary</a>-&gt;Unlock(NULL);
00642 
00643         numPics++;
00644         sprintf(filename, <font class="stringliteral">"screenshot%3.3d.png"</font>, numPics);
00645 
00646         fp = fopen(filename,<font class="stringliteral">"wb"</font>);
00647 
00648         <font class="keywordflow">if</font> (!fp)
00649             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999,<font class="stringliteral">"Cannot open file for writing."</font>,
00650                 <font class="stringliteral">"DDDriver::takeScreenShot"</font>);
00651 
00652         png_structp png_ptr = png_create_write_struct
00653            (PNG_LIBPNG_VER_STRING, NULL,
00654             NULL, NULL);
00655         <font class="keywordflow">if</font> (!png_ptr)
00656             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999,<font class="stringliteral">"Error initialising PNG library."</font>,
00657                 <font class="stringliteral">"DDDriver::takeScreenShot"</font>);
00658 
00659         png_infop info_ptr = png_create_info_struct(png_ptr);
00660         <font class="keywordflow">if</font> (!info_ptr)
00661         {
00662            png_destroy_write_struct(&amp;png_ptr,
00663              (png_infopp)NULL);
00664             <font class="keywordflow">throw</font> <a class="code" href="classOgre_1_1Exception.html">Exception</a>(999,<font class="stringliteral">"Error initialising PNG library."</font>,
00665                 <font class="stringliteral">"DDDriver::takeScreenShot"</font>);
00666         }
00667 
00668         png_init_io(png_ptr, fp);
00669 
00670         <font class="comment">// Set image size, and channel bit depth (8),</font>
00671         <font class="comment">//  colour type (RGB), interlace type (NONE),</font>
00672         <font class="comment">//  compression &amp; filter types (DEFAULT),</font>
00673         png_set_IHDR(png_ptr, info_ptr, ddsd.dwWidth, ddsd.dwHeight,
00674            8, PNG_COLOR_TYPE_RGB, PNG_INTERLACE_NONE,
00675            PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT);
00676 
00677         <font class="comment">// Omit all other info like gamma, description etc</font>
00678 
00679         <font class="comment">// Write info</font>
00680         png_write_info(png_ptr, info_ptr);
00681 
00682         <font class="comment">// Write data</font>
00683         png_write_image(png_ptr, rowPointers);
00684 
00685         png_write_end(png_ptr, info_ptr);
00686         png_destroy_write_struct(&amp;png_ptr, &amp;info_ptr);
00687 
00688 
00689         <a class="code" href="OgreMemoryMacros_8h.html#a3">free</a>(pBuffer);
00690 
00691     }
00692 
00693 }
00694 
00695 
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
