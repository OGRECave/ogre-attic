<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreJPEGCodec.cpp</h1><a href="OgreJPEGCodec_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">(Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 
00026 <font class="preprocessor">#include "<a class="code" href="OgrePlatform_8h.html">OgrePlatform.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreStdHeaders_8h.html">OgreStdHeaders.h</a>"</font>
00028 
00029 <font class="preprocessor">#ifndef XMD_H</font>
00030 <font class="preprocessor"></font><font class="preprocessor">#   define XMD_H</font>
00031 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00032 <font class="preprocessor"></font><font class="preprocessor">#ifdef FAR</font>
00033 <font class="preprocessor"></font><font class="preprocessor">#   undef FAR</font>
00034 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00035 <font class="preprocessor"></font><font class="keyword">extern</font> <font class="stringliteral">"C"</font> {
00036 <font class="preprocessor">#include "jpeglib.h"</font>
00037 }
00038 
00039 <font class="preprocessor">#include "<a class="code" href="OgreJPEGCodec_8h.html">OgreJPEGCodec.h</a>"</font>
00040 <font class="preprocessor">#include "<a class="code" href="OgreImage_8h.html">OgreImage.h</a>"</font>
00041 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00042 
00043 <font class="keyword">namespace </font>Ogre {
00044 
<a name="l00045"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece0">00045</a>     <font class="keywordtype">void</font> JPEGCodec::init_source( <a class="code" href="OgreJPEGCodec_8h.html#a0">j_decompress_ptr</a> cinfo )
00046     {
00047     }
00048 
<a name="l00049"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece1">00049</a>     <font class="keywordtype">boolean</font> JPEGCodec::fill_input_buffer( <a class="code" href="OgreJPEGCodec_8h.html#a0">j_decompress_ptr</a> cinfo )
00050     {
00051         <font class="keywordflow">return</font> TRUE;
00052     }
00053 
<a name="l00054"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece2">00054</a>     <font class="keywordtype">void</font> JPEGCodec::skip_input_data( <a class="code" href="OgreJPEGCodec_8h.html#a0">j_decompress_ptr</a> cinfo, <font class="keywordtype">long</font> count )
00055     {
00056         jpeg_source_mgr * src = cinfo-&gt;src;
00057         <font class="keywordflow">if</font>(count &gt; 0) {
00058             src-&gt;bytes_in_buffer -= count;
00059             src-&gt;next_input_byte += count;
00060         }
00061     }
00062 
<a name="l00063"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece3">00063</a>     <font class="keywordtype">void</font> JPEGCodec::term_source( <a class="code" href="OgreJPEGCodec_8h.html#a0">j_decompress_ptr</a> cinfo )
00064     {
00065     }
00066 
<a name="l00067"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodeca1">00067</a>     <font class="keywordtype">void</font> JPEGCodec::code( <font class="keyword">const</font> <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; input, <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>* output, ... )<font class="keyword"> const</font>
00068 <font class="keyword">    </font>{
00069         <a class="code" href="OgreException_8h.html#a1">OgreGuard</a>( <font class="stringliteral">"JPEGCodec::code"</font> );
00070         <a class="code" href="OgreException_8h.html#a2">OgreUnguard</a>();
00071     }
00072 
<a name="l00073"></a><a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodeca2">00073</a>     <a class="code" href="classOgre_1_1Codec_1_1CodecData.html">Codec::CodecData</a> * JPEGCodec::decode( <font class="keyword">const</font> <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; input, <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>* output, ... )<font class="keyword"> const</font>
00074 <font class="keyword">    </font>{
00075         <a class="code" href="OgreException_8h.html#a1">OgreGuard</a>( <font class="stringliteral">"JPEGCodec::decode"</font> );
00076 
00077         <font class="keyword">struct </font>jpeg_decompress_struct cinfo;
00078 
00079         <font class="comment">// allocate and initialize JPEG decompression object</font>
00080         <font class="keyword">struct </font>jpeg_error_mgr jerr;
00081 
00082         <font class="comment">/* We have to set up the error handler first, in case the initialization</font>
00083 <font class="comment">        step fails.  (Unlikely, but it could happen if you are out of memory.)</font>
00084 <font class="comment">        This routine fills in the contents of struct jerr, and returns jerr's</font>
00085 <font class="comment">        address which we place into the link field in cinfo.</font>
00086 <font class="comment">        */</font>
00087         cinfo.err = jpeg_std_error(&amp;jerr);
00088         <font class="comment">/* Now we can initialize the JPEG decompression object. */</font>
00089         jpeg_create_decompress(&amp;cinfo);
00090 
00091         <font class="comment">// specify data source</font>
00092         jpeg_source_mgr jsrc;
00093 
00094         <font class="comment">// Set up data pointer</font>
00095         jsrc.bytes_in_buffer = input.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka5">getSize</a>();
00096         jsrc.next_input_byte = (JOCTET*) input.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka6">getPtr</a>();
00097         cinfo.src = &amp;jsrc;
00098 
00099         jsrc.init_source = <a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece0">init_source</a>;
00100         jsrc.fill_input_buffer = <a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece1">fill_input_buffer</a>;
00101         jsrc.skip_input_data = <a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece2">skip_input_data</a>;
00102         jsrc.resync_to_restart = jpeg_resync_to_restart;    <font class="comment">// use default method</font>
00103         jsrc.term_source = <a class="code" href="classOgre_1_1JPEGCodec.html#Ogre_1_1JPGCodece3">term_source</a>;
00104 
00105         <font class="comment">// Decodes JPG input from whatever source</font>
00106         <font class="comment">// Does everything AFTER jpeg_create_decompress</font>
00107         <font class="comment">//   and BEFORE jpeg_destroy_decompress</font>
00108         <font class="comment">// Caller is responsible for arranging these + setting up cinfo</font>
00109 
00110         <font class="comment">/* read file parameters with jpeg_read_header() */</font>
00111         (void) jpeg_read_header(&amp;cinfo, TRUE);
00112 
00113         <font class="comment">/* Start decompressor */</font>
00114         (void) jpeg_start_decompress(&amp;cinfo);
00115 
00116         <font class="comment">// Get image data</font>
00117         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> rowspan = cinfo.image_width * cinfo.num_components;
00118         <font class="keywordtype">unsigned</font> width = cinfo.image_width;
00119         <font class="keywordtype">unsigned</font> height = cinfo.image_height;
00120 
00121         <font class="keywordtype">bool</font> has_alpha= <font class="keyword">false</font>;  <font class="comment">//(JPEG never has alpha)</font>
00122         <font class="keywordtype">bool</font> greyscale;
00123 
00124         <font class="keywordflow">if</font> (cinfo.jpeg_color_space == JCS_GRAYSCALE)
00125         {
00126             greyscale = <font class="keyword">true</font>;
00127         }
00128         <font class="keywordflow">else</font>
00129         {
00130             greyscale = <font class="keyword">false</font>;
00131         }
00132 
00133         <font class="comment">// Allocate memory for buffer</font>
00134         output-&gt;<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka3">allocate</a>( rowspan * height );
00135         byte *buffer = const_cast&lt; byte * &gt;( output-&gt;<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka6">getPtr</a>() );
00136 
00137         <font class="comment">/* Here we use the library's state variable cinfo.output_scanline as the</font>
00138 <font class="comment">        * loop counter, so that we don't have to keep track ourselves.</font>
00139 <font class="comment">        */</font>
00140         <font class="comment">// Create array of row pointers for lib</font>
00141         byte **rowPtr = <font class="keyword">new</font> byte * [height];
00142         <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> i = 0; i &lt; height; i++ )
00143             rowPtr[i] = &amp;buffer[ i * rowspan ];
00144         <font class="keywordtype">unsigned</font> rowsRead = 0;
00145         <font class="keywordflow">while</font>( cinfo.output_scanline &lt; cinfo.output_height )
00146         {
00147             rowsRead += jpeg_read_scanlines( &amp;cinfo, &amp;rowPtr[rowsRead], cinfo.output_height - rowsRead );
00148         }
00149 
00150         <font class="keyword">delete</font> [] rowPtr;
00151         <font class="comment">/* Finish decompression */</font>
00152 
00153         (void) jpeg_finish_decompress(&amp;cinfo);
00154 
00155         <font class="comment">// Release JPEG decompression object</font>
00156 
00157         <font class="comment">// This is an important step since it will release a good deal of memory.</font>
00158         jpeg_destroy_decompress(&amp;cinfo);
00159 
00160         ImageData * ret_data = <font class="keyword">new</font> ImageData;
00161 
00162         ret_data-&gt;ulHeight = height;
00163         ret_data-&gt;ulWidth = width;
00164 
00165         <a class="code" href="namespaceOgre.html#a292">uchar</a> ucBpp = 0;
00166         <font class="keywordflow">if</font>( has_alpha )
00167             ucBpp += 8;
00168         <font class="keywordflow">if</font>( greyscale )
00169             ucBpp += 8;
00170         <font class="keywordflow">else</font>
00171             ucBpp += 24;
00172 
00173         ret_data-&gt;eFormat = Image::BPP2PF( ucBpp );
00174 
00175         <a class="code" href="OgreException_8h.html#a3">OgreUnguardRet</a>( ret_data );
00176     }
00177 
00178 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
