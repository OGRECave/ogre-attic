<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgreSkeletonSerializer.cpp</h1><a href="OgreSkeletonSerializer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">    (Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2002 The OGRE Team</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 
00026 <font class="preprocessor">#include "<a class="code" href="OgreSkeletonFileFormat_8h.html">OgreSkeletonFileFormat.h</a>"</font>
00027 <font class="preprocessor">#include "<a class="code" href="OgreSkeletonSerializer_8h.html">OgreSkeletonSerializer.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreSkeleton_8h.html">OgreSkeleton.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreAnimation_8h.html">OgreAnimation.h</a>"</font>
00030 <font class="preprocessor">#include "<a class="code" href="OgreAnimationTrack_8h.html">OgreAnimationTrack.h</a>"</font>
00031 <font class="preprocessor">#include "<a class="code" href="OgreKeyFrame_8h.html">OgreKeyFrame.h</a>"</font>
00032 <font class="preprocessor">#include "<a class="code" href="OgreBone_8h.html">OgreBone.h</a>"</font>
00033 <font class="preprocessor">#include "<a class="code" href="OgreString_8h.html">OgreString.h</a>"</font>
00034 <font class="preprocessor">#include "<a class="code" href="OgreDataChunk_8h.html">OgreDataChunk.h</a>"</font>
00035 
00036 
00037 
00038 
00039 <font class="keyword">namespace </font>Ogre {
<a name="l00041"></a><a class="code" href="namespaceOgre.html#a341">00041</a>     <font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a> = <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>) + <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>);
00042     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00043"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializera0">00043</a>     SkeletonSerializer::SkeletonSerializer()
00044     {
00045     }
00046     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00047"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializera1">00047</a>     SkeletonSerializer::~SkeletonSerializer()
00048     {
00049     }
00050     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00051"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializera2">00051</a>     <font class="keywordtype">void</font> SkeletonSerializer::exportSkeleton(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Skeleton.html">Skeleton</a>* pSkeleton, <font class="keyword">const</font> <a class="code" href="classOgre_1_1String.html">String</a>&amp; filename)
00052     {
00053         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializern1">mpfFile</a> = fopen(filename, <font class="stringliteral">"wb"</font>);
00054 
00055         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb0">writeFileHeader</a>();
00056 
00057         <font class="comment">// Write main skeleton data</font>
00058         <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc0">writeSkeleton</a>(pSkeleton);
00059 
00060         <font class="comment">// Write all animations</font>
00061         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> numAnims = pSkeleton-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona20">getNumAnimations</a>();
00062         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i = 0; i &lt; numAnims; ++i)
00063         {
00064             <a class="code" href="classOgre_1_1Animation.html">Animation</a>* pAnim = pSkeleton-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona14">getAnimation</a>(i);
00065             <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc3">writeAnimation</a>(pAnim);
00066         }
00067         fclose(<a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializern1">mpfFile</a>);
00068 
00069     }
00070     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00071"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializera3">00071</a>     <font class="keywordtype">void</font> SkeletonSerializer::importSkeleton(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; chunk, <a class="code" href="classOgre_1_1Skeleton.html">Skeleton</a>* pDest)
00072     {
00073         <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a> = pDest;
00074 
00075         <font class="comment">// Check header</font>
00076         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb9">readFileHeader</a>(chunk);
00077 
00078         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> chunkID;
00079         <font class="keywordflow">while</font>(!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00080         {
00081             chunkID = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb10">readChunk</a>(chunk);
00082             <font class="keywordflow">switch</font> (chunkID)
00083             {
00084             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a441a311">SKELETON_BONE</a>:
00085                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc6">readBone</a>(chunk);
00086                 <font class="keywordflow">break</font>;
00087             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a441a312">SKELETON_BONE_PARENT</a>:
00088                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc7">readBoneParent</a>(chunk);
00089                 <font class="keywordflow">break</font>;
00090             <font class="keywordflow">case</font> <a class="code" href="namespaceOgre.html#a441a313">SKELETON_ANIMATION</a>:
00091                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc8">readAnimation</a>(chunk);
00092             }
00093         }
00094 
00095         <font class="comment">// Assume bones are stored in the binding pose</font>
00096         <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona11">setBindingPose</a>();
00097 
00098 
00099     }
00100     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00101"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc0">00101</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeSkeleton(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Skeleton.html">Skeleton</a>* pSkel)
00102     {
00103         <font class="comment">// Write each bone</font>
00104         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> numBones = pSkel-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona7">getNumBones</a>();
00105         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i;
00106         <font class="keywordflow">for</font> (i = 0; i &lt; numBones; ++i)
00107         {
00108             <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone = pSkel-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">getBone</a>(i);
00109             <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc1">writeBone</a>(pBone);
00110         }
00111         <font class="comment">// Write parents</font>
00112         <font class="keywordflow">for</font> (i = 0; i &lt; numBones; ++i)
00113         {
00114             <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone = pSkel-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">getBone</a>(i);
00115             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> handle = pBone-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea8">getHandle</a>();
00116             <font class="keywordflow">if</font> (handle != 0) <font class="comment">// root bone</font>
00117             {
00118                 <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pParent = (<a class="code" href="classOgre_1_1Bone.html">Bone</a>*)pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea19">getParent</a>();
00119                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc2">writeBoneParent</a>(handle, pParent-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea8">getHandle</a>());
00120             }
00121         }
00122     }
00123     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00124"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc1">00124</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeBone(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone)
00125     {
00126         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb1">writeChunkHeader</a>(<a class="code" href="namespaceOgre.html#a441a311">SKELETON_BONE</a>, <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc11">calcBoneSize</a>(pBone));
00127 
00128         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> handle = pBone-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea8">getHandle</a>();
00129         <font class="comment">// unsigned short handle            : handle of the bone, should be contiguous &amp; start at 0</font>
00130         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb3">writeShorts</a>(&amp;handle, 1);
00131         <font class="comment">// Vector3 position                 : position of this bone relative to parent </font>
00132         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb5">writeObject</a>(pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea25">getPosition</a>());
00133         <font class="comment">// Quaternion orientation           : orientation of this bone relative to parent </font>
00134         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb5">writeObject</a>(pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea20">getOrientation</a>());
00135     }
00136     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00137"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc2">00137</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeBoneParent(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> boneId, <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> parentId)
00138     {
00139         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb1">writeChunkHeader</a>(<a class="code" href="namespaceOgre.html#a441a312">SKELETON_BONE_PARENT</a>, <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc12">calcBoneParentSize</a>());
00140 
00141         <font class="comment">// unsigned short handle             : child bone</font>
00142         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb3">writeShorts</a>(&amp;boneId, 1);
00143         <font class="comment">// unsigned short parentHandle   : parent bone</font>
00144         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb3">writeShorts</a>(&amp;parentId, 1);
00145 
00146     }
00147     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00148"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc3">00148</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeAnimation(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Animation.html">Animation</a>* anim)
00149     {
00150         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb1">writeChunkHeader</a>(<a class="code" href="namespaceOgre.html#a441a313">SKELETON_ANIMATION</a>, <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc13">calcAnimationSize</a>(anim));
00151 
00152         <font class="comment">// char* name                       : Name of the animation</font>
00153         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb8">writeString</a>(anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa2">getName</a>());
00154         <font class="comment">// Real length                      : Length of the animation in seconds</font>
00155         <a class="code" href="namespaceOgre.html#a281">Real</a> len = anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa3">getLength</a>();
00156         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb2">writeReals</a>(&amp;len, 1);
00157 
00158         <font class="comment">// Write all tracks</font>
00159         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i = 0; i &lt; anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa6">getNumTracks</a>(); ++i)
00160         {
00161             <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc4">writeAnimationTrack</a>(anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa7">getTrack</a>(i));
00162         }
00163 
00164     }
00165     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00166"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc4">00166</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeAnimationTrack(<font class="keyword">const</font> <a class="code" href="classOgre_1_1AnimationTrack.html">AnimationTrack</a>* track)
00167     {
00168         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb1">writeChunkHeader</a>(<a class="code" href="namespaceOgre.html#a441a314">SKELETON_ANIMATION_TRACK</a>, <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc14">calcAnimationTrackSize</a>(track));
00169 
00170         <font class="comment">// unsigned short boneIndex     : Index of bone to apply to</font>
00171         <a class="code" href="classOgre_1_1Bone.html">Bone</a>* bone = (<a class="code" href="classOgre_1_1Bone.html">Bone</a>*)track-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka11">getAssociatedNode</a>();
00172         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> boneid = bone-&gt;<a class="code" href="classOgre_1_1Bone.html#Ogre_1_1Bonea8">getHandle</a>();
00173         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb3">writeShorts</a>(&amp;boneid, 1);
00174 
00175         <font class="comment">// Write all keyframes</font>
00176         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i = 0; i &lt; track-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka3">getNumKeyFrames</a>(); ++i)
00177         {
00178             <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc5">writeKeyFrame</a>(track-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka4">getKeyFrame</a>(i));
00179         }
00180 
00181     }
00182     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00183"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc5">00183</a>     <font class="keywordtype">void</font> SkeletonSerializer::writeKeyFrame(<font class="keyword">const</font> <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>* key)
00184     {
00185 
00186         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb1">writeChunkHeader</a>(<a class="code" href="namespaceOgre.html#a441a315">SKELETON_ANIMATION_TRACK_KEYFRAME</a>, <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc15">calcKeyFrameSize</a>(key));
00187 
00188         <font class="comment">// Real time                    : The time position (seconds)</font>
00189         <a class="code" href="namespaceOgre.html#a281">Real</a> time = key-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea2">getTime</a>();
00190         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb2">writeReals</a>(&amp;time, 1);
00191         <font class="comment">// Quaternion rotate            : Rotation to apply at this keyframe</font>
00192         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb5">writeObject</a>(key-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea8">getRotation</a>());
00193         <font class="comment">// Vector3 translate            : Translation to apply at this keyframe</font>
00194         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb5">writeObject</a>(key-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea4">getTranslate</a>());
00195     }
00196     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00197"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc11">00197</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SkeletonSerializer::calcBoneSize(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone)
00198     {
00199         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> size = <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>;
00200 
00201         <font class="comment">// handle</font>
00202         size += <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>);
00203 
00204         <font class="comment">// position</font>
00205         size += <font class="keyword">sizeof</font>(Real) * 3;
00206 
00207         <font class="comment">// orientation</font>
00208         size += <font class="keyword">sizeof</font>(Real) * 4;
00209 
00210         <font class="keywordflow">return</font> size;
00211 
00212     }
00213     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00214"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc12">00214</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SkeletonSerializer::calcBoneParentSize(<font class="keywordtype">void</font>)
00215     {
00216         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> size = <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>;
00217 
00218         <font class="comment">// handle</font>
00219         size += <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>);
00220 
00221         <font class="comment">// parent handle</font>
00222         size += <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>);
00223 
00224         <font class="keywordflow">return</font> size;
00225 
00226     }
00227     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00228"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc13">00228</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SkeletonSerializer::calcAnimationSize(<font class="keyword">const</font> <a class="code" href="classOgre_1_1Animation.html">Animation</a>* pAnim)
00229     {
00230         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> size = <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>;
00231 
00232         <font class="comment">// Name, including terminator</font>
00233         size += (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font>)pAnim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa2">getName</a>().length() + 1;
00234         <font class="comment">// length</font>
00235         size += <font class="keyword">sizeof</font>(Real);
00236 
00237         <font class="comment">// Nested animation tracks</font>
00238         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i = 0; i &lt; pAnim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa6">getNumTracks</a>(); ++i)
00239         {
00240             size += <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc14">calcAnimationTrackSize</a>(pAnim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa7">getTrack</a>(i));
00241         }
00242 
00243 
00244         <font class="keywordflow">return</font> size;
00245 
00246     }
00247     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00248"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc14">00248</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SkeletonSerializer::calcAnimationTrackSize(<font class="keyword">const</font> <a class="code" href="classOgre_1_1AnimationTrack.html">AnimationTrack</a>* pTrack)
00249     {
00250         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> size = <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>;
00251 
00252         <font class="comment">// unsigned short boneIndex     : Index of bone to apply to</font>
00253         size += <font class="keyword">sizeof</font>(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>);
00254 
00255         <font class="comment">// Nested keyframes</font>
00256         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> i = 0; i &lt; pTrack-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka3">getNumKeyFrames</a>(); ++i)
00257         {
00258             size += <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc15">calcKeyFrameSize</a>(pTrack-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka4">getKeyFrame</a>(i));
00259         }
00260 
00261 
00262         <font class="keywordflow">return</font> size;
00263     }
00264     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00265"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc15">00265</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> SkeletonSerializer::calcKeyFrameSize(<font class="keyword">const</font> <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a>* pKey)
00266     {
00267         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> size = <a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>;
00268 
00269         <font class="comment">// Real time                    : The time position (seconds)</font>
00270         size += <font class="keyword">sizeof</font>(Real);
00271         <font class="comment">// Quaternion rotate            : Rotation to apply at this keyframe</font>
00272         size += <font class="keyword">sizeof</font>(Real) * 4;
00273         <font class="comment">// Vector3 translate            : Translation to apply at this keyframe</font>
00274         size += <font class="keyword">sizeof</font>(Real) * 3;
00275 
00276         <font class="keywordflow">return</font> size;
00277     }
00278     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00279"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc6">00279</a>     <font class="keywordtype">void</font> SkeletonSerializer::readBone(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> &amp;chunk)
00280     {
00281         <font class="comment">// unsigned short handle            : handle of the bone, should be contiguous &amp; start at 0</font>
00282         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> handle;
00283         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb12">readShorts</a>(chunk, &amp;handle, 1);
00284 
00285         <font class="comment">// Create new bone</font>
00286         <a class="code" href="classOgre_1_1Bone.html">Bone</a>* pBone = <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona4">createBone</a>(handle);
00287 
00288         <font class="comment">// Vector3 position                 : position of this bone relative to parent </font>
00289         <a class="code" href="classOgre_1_1Vector3.html">Vector3</a> pos;
00290         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb14">readObject</a>(chunk, &amp;pos);
00291         pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea23">setPosition</a>(pos);
00292         <font class="comment">// Quaternion orientation           : orientation of this bone relative to parent </font>
00293         <a class="code" href="classOgre_1_1Quaternion.html">Quaternion</a> q;
00294         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb14">readObject</a>(chunk, &amp;q);
00295         pBone-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea21">setOrientation</a>(q);
00296     }
00297     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00298"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc7">00298</a>     <font class="keywordtype">void</font> SkeletonSerializer::readBoneParent(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> &amp;chunk)
00299     {
00300         <font class="comment">// All bones have been created by this point</font>
00301         <a class="code" href="classOgre_1_1Bone.html">Bone</a> *child, *parent;
00302         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> childHandle, parentHandle;
00303 
00304         <font class="comment">// unsigned short handle             : child bone</font>
00305         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb12">readShorts</a>(chunk, &amp;childHandle, 1);
00306         <font class="comment">// unsigned short parentHandle   : parent bone</font>
00307         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb12">readShorts</a>(chunk, &amp;parentHandle, 1);
00308 
00309         <font class="comment">// Find bones</font>
00310         parent = <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">getBone</a>(parentHandle);
00311         child = <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">getBone</a>(childHandle);
00312 
00313         <font class="comment">// attach</font>
00314         parent-&gt;<a class="code" href="classOgre_1_1Node.html#Ogre_1_1SceneNodea43">addChild</a>(child);
00315 
00316     }
00317     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00318"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc8">00318</a>     <font class="keywordtype">void</font> SkeletonSerializer::readAnimation(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> &amp;chunk)
00319     {
00320         <font class="comment">// char* name                       : Name of the animation</font>
00321         <a class="code" href="classOgre_1_1String.html">String</a> name;
00322         name = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb16">readString</a>(chunk);
00323         <font class="comment">// Real length                      : Length of the animation in seconds</font>
00324         <a class="code" href="namespaceOgre.html#a281">Real</a> len;
00325         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb11">readReals</a>(chunk, &amp;len, 1);
00326 
00327         <a class="code" href="classOgre_1_1Animation.html">Animation</a> *pAnim = <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona13">createAnimation</a>(name, len);
00328 
00329         <font class="comment">// Read all tracks</font>
00330         <font class="keywordflow">while</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00331         {
00332             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> chunkID = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb10">readChunk</a>(chunk);
00333             <font class="keywordflow">while</font>(chunkID == <a class="code" href="namespaceOgre.html#a441a314">SKELETON_ANIMATION_TRACK</a> &amp;&amp; !chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00334             {
00335                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc9">readAnimationTrack</a>(chunk, pAnim);
00336 
00337                 <font class="keywordflow">if</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00338                 {
00339                     <font class="comment">// Get next chunk</font>
00340                     chunkID = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb10">readChunk</a>(chunk);
00341                 }
00342             }
00343             <font class="keywordflow">if</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00344             {
00345                 <font class="comment">// Backpedal back to start of this chunk if we've found a non-track</font>
00346                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka10">skip</a>(-(<font class="keywordtype">long</font>)<a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>);
00347             }
00348 
00349         }
00350 
00351 
00352 
00353     }
00354     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00355"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc9">00355</a>     <font class="keywordtype">void</font> SkeletonSerializer::readAnimationTrack(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> &amp;chunk, <a class="code" href="classOgre_1_1Animation.html">Animation</a>* anim)
00356     {
00357         <font class="comment">// unsigned short boneIndex     : Index of bone to apply to</font>
00358         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> boneHandle;
00359         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb12">readShorts</a>(chunk, &amp;boneHandle, 1);
00360 
00361         <font class="comment">// Find bone</font>
00362         <a class="code" href="classOgre_1_1Bone.html">Bone</a> *targetBone = <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializero0">mpSkeleton</a>-&gt;<a class="code" href="classOgre_1_1Skeleton.html#Ogre_1_1Skeletona9">getBone</a>(boneHandle);
00363 
00364         <font class="comment">// Create track</font>
00365         <a class="code" href="classOgre_1_1AnimationTrack.html">AnimationTrack</a>* pTrack = anim-&gt;<a class="code" href="classOgre_1_1Animation.html#Ogre_1_1Animationa4">createTrack</a>(boneHandle, targetBone);
00366 
00367         <font class="comment">// Keep looking for nested keyframes</font>
00368         <font class="keywordflow">while</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00369         {
00370             <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> chunkID = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb10">readChunk</a>(chunk);
00371             <font class="keywordflow">while</font>(chunkID == <a class="code" href="namespaceOgre.html#a441a315">SKELETON_ANIMATION_TRACK_KEYFRAME</a> &amp;&amp; !chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00372             {
00373                 <a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc10">readKeyFrame</a>(chunk, pTrack);
00374 
00375                 <font class="keywordflow">if</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00376                 {
00377                     <font class="comment">// Get next chunk</font>
00378                     chunkID = <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb10">readChunk</a>(chunk);
00379                 }
00380             }
00381             <font class="keywordflow">if</font> (!chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka12">isEOF</a>())
00382             {
00383                 <font class="comment">// Backpedal back to start of this chunk if we've found a non-keyframe</font>
00384                 chunk.<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka10">skip</a>(-(<font class="keywordtype">long</font>)<a class="code" href="namespaceOgre.html#a341">CHUNK_OVERHEAD_SIZE</a>);
00385             }
00386 
00387         }
00388 
00389 
00390     }
00391     <font class="comment">//---------------------------------------------------------------------</font>
<a name="l00392"></a><a class="code" href="classOgre_1_1SkeletonSerializer.html#Ogre_1_1SkeletonSerializerc10">00392</a>     <font class="keywordtype">void</font> SkeletonSerializer::readKeyFrame(<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a> &amp;chunk, <a class="code" href="classOgre_1_1AnimationTrack.html">AnimationTrack</a>* track)
00393     {
00394         <font class="comment">// Real time                    : The time position (seconds)</font>
00395         <a class="code" href="namespaceOgre.html#a281">Real</a> time;
00396         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb11">readReals</a>(chunk, &amp;time, 1);
00397 
00398         <a class="code" href="classOgre_1_1KeyFrame.html">KeyFrame</a> *kf = track-&gt;<a class="code" href="classOgre_1_1AnimationTrack.html#Ogre_1_1AnimationTracka6">createKeyFrame</a>(time);
00399 
00400         <font class="comment">// Quaternion rotate            : Rotation to apply at this keyframe</font>
00401         <a class="code" href="classOgre_1_1Quaternion.html">Quaternion</a> rot;
00402         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb14">readObject</a>(chunk, &amp;rot);
00403         kf-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea7">setRotation</a>(rot);
00404         <font class="comment">// Vector3 translate            : Translation to apply at this keyframe</font>
00405         <a class="code" href="classOgre_1_1Vector3.html">Vector3</a> trans;
00406         <a class="code" href="classOgre_1_1Serializer.html#Ogre_1_1SkeletonSerializerb14">readObject</a>(chunk, &amp;trans);
00407         kf-&gt;<a class="code" href="classOgre_1_1KeyFrame.html#Ogre_1_1KeyFramea3">setTranslate</a>(trans);
00408     }
00409     <font class="comment">//---------------------------------------------------------------------</font>
00410 
00411 
00412 
00413 }
00414 
00415 
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
