<html>
<head>
<title>OGRE Documentation</title> <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>
<!-- Generated by Doxygen 1.2.16 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>OgrePNGCodec.cpp</h1><a href="OgrePNGCodec_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">-----------------------------------------------------------------------------</font>
00003 <font class="comment">This source file is part of OGRE</font>
00004 <font class="comment">(Object-oriented Graphics Rendering Engine)</font>
00005 <font class="comment">For the latest info, see http://www.stevestreeting.com/ogre/</font>
00006 <font class="comment"></font>
00007 <font class="comment">Copyright © 2000-2001 Steven J. Streeting</font>
00008 <font class="comment">Also see acknowledgements in Readme.html</font>
00009 <font class="comment"></font>
00010 <font class="comment">This program is free software; you can redistribute it and/or modify it under</font>
00011 <font class="comment">the terms of the GNU General Public License as published by the Free Software</font>
00012 <font class="comment">Foundation; either version 2 of the License, or (at your option) any later</font>
00013 <font class="comment">version.</font>
00014 <font class="comment"></font>
00015 <font class="comment">This program is distributed in the hope that it will be useful, but WITHOUT</font>
00016 <font class="comment">ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</font>
00017 <font class="comment">FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</font>
00018 <font class="comment"></font>
00019 <font class="comment">You should have received a copy of the GNU General Public License along with</font>
00020 <font class="comment">this program; if not, write to the Free Software Foundation, Inc., 59 Temple</font>
00021 <font class="comment">Place - Suite 330, Boston, MA 02111-1307, USA, or go to</font>
00022 <font class="comment">http://www.gnu.org/copyleft/gpl.html.</font>
00023 <font class="comment">-----------------------------------------------------------------------------</font>
00024 <font class="comment">*/</font>
00025 <font class="preprocessor">#include "png.h"</font>
00026 
00027 <font class="preprocessor">#include "<a class="code" href="OgrePNGCodec_8h.html">OgrePNGCodec.h</a>"</font>
00028 <font class="preprocessor">#include "<a class="code" href="OgreImage_8h.html">OgreImage.h</a>"</font>
00029 <font class="preprocessor">#include "<a class="code" href="OgreException_8h.html">OgreException.h</a>"</font>
00030 
00031 <font class="keyword">namespace </font>Ogre {
00032 
<a name="l00033"></a><a class="code" href="classOgre_1_1PNGCodec.html#Ogre_1_1PNGCodece0">00033</a>     <font class="keywordtype">void</font> PNGCodec::pngChunkRead(png_structp png_ptr, png_bytep data, png_size_t length)
00034     {
00035         <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>* pChunk = (<a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>*)png_ptr-&gt;io_ptr;
00036 
00037         <font class="keywordflow">if</font>( pChunk-&gt;<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka8">read</a>((<font class="keywordtype">void</font>*)data, static_cast&lt; unsigned long &gt;( length ) ) != length )
00038             png_error(png_ptr, <font class="stringliteral">"Read Error."</font>);
00039     }
00040 
<a name="l00041"></a><a class="code" href="classOgre_1_1PNGCodec.html#Ogre_1_1PNGCodeca0">00041</a>     <font class="keywordtype">void</font> PNGCodec::code( <font class="keyword">const</font> <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; input, <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>* output, ... )<font class="keyword"> const</font>
00042 <font class="keyword">    </font>{        
00043     }
<a name="l00044"></a><a class="code" href="classOgre_1_1PNGCodec.html#Ogre_1_1PNGCodeca1">00044</a>     <a class="code" href="classOgre_1_1Codec_1_1CodecData.html">Codec::CodecData</a> * PNGCodec::decode( <font class="keyword">const</font> <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>&amp; input, <a class="code" href="classOgre_1_1DataChunk.html">DataChunk</a>* output, ... )<font class="keyword"> const</font>
00045 <font class="keyword">    </font>{
00046         <a class="code" href="OgreException_8h.html#a1">OgreGuard</a>( <font class="stringliteral">"PNGCodec::decode"</font> );
00047 
00048         png_structp png_ptr = png_create_read_struct(
00049             PNG_LIBPNG_VER_STRING, 
00050             (png_voidp)NULL, NULL, NULL );
00051         <font class="keywordflow">if</font>( !png_ptr )
00052             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00053             Exception::ERR_INTERNAL_ERROR,
00054             <font class="stringliteral">"Unable to load image from PNG."</font>,
00055             <font class="stringliteral">"PNGCodec::decode"</font>);
00056 
00057         png_infop info_ptr = png_create_info_struct( png_ptr );
00058         <font class="keywordflow">if</font>( !info_ptr )
00059         {
00060             png_destroy_read_struct(
00061                 &amp;png_ptr,
00062                 (png_infopp)NULL, 
00063                 (png_infopp)NULL );
00064             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00065                 Exception::ERR_INTERNAL_ERROR,
00066                 <font class="stringliteral">"Unable to load image from PNG."</font>,
00067                 <font class="stringliteral">"PNGCodec::decode"</font> );
00068         }
00069 
00070         png_infop end_info = png_create_info_struct( png_ptr );
00071         <font class="keywordflow">if</font>( !end_info )
00072         {
00073             png_destroy_read_struct(
00074                 &amp;png_ptr,
00075                 &amp;info_ptr, 
00076                 (png_infopp)NULL );
00077             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00078                 Exception::ERR_INTERNAL_ERROR,
00079                 <font class="stringliteral">"Unable to load image from PNG."</font>,
00080                 <font class="stringliteral">"PNGCodec::decode"</font> );
00081         }
00082 
00083         <font class="comment">// Set new read function (memory access)</font>
00084         png_set_read_fn(
00085             png_ptr, 
00086             (png_voidp)&amp;input, 
00087             <a class="code" href="classOgre_1_1PNGCodec.html#Ogre_1_1PNGCodece0">pngChunkRead</a> );
00088 
00089         <font class="comment">// No need to reverse alpha channel (1.0 is opaque in</font>
00090         <font class="comment">//  PNG, D3D and OpenGL)</font>
00091 
00092         <font class="comment">// Read PNG info</font>
00093         png_read_info( png_ptr, info_ptr );
00094 
00095         <font class="comment">// Retrieve dimensions etc</font>
00096         <font class="keywordtype">unsigned</font> width  = png_get_image_width( png_ptr, info_ptr );
00097         <font class="keywordtype">unsigned</font> height = png_get_image_height( png_ptr, info_ptr );
00098 
00099         <font class="comment">// Get colour info</font>
00100         <font class="keywordtype">int</font> iBitDepth, iColourType;
00101         iBitDepth = png_get_bit_depth( png_ptr, info_ptr );
00102         iColourType = png_get_color_type( png_ptr, info_ptr );
00103 
00104         <font class="keywordtype">bool</font> greyscale, has_alpha;
00105 
00106         <font class="keywordflow">switch</font>( iColourType )
00107         {
00108         <font class="keywordflow">case</font> PNG_COLOR_TYPE_PALETTE:
00109             <a class="code" href="OgreException_8h.html#a0">Except</a>(
00110                 999, 
00111                 <font class="stringliteral">"Palettised images not supported."</font>,
00112                 <font class="stringliteral">"Image::loadFromPNG"</font>);
00113             <font class="keywordflow">break</font>;
00114         <font class="keywordflow">case</font> PNG_COLOR_TYPE_RGB:
00115             greyscale = <font class="keyword">false</font>;
00116             has_alpha = <font class="keyword">false</font>;
00117             <font class="keywordflow">break</font>;
00118         <font class="keywordflow">case</font> PNG_COLOR_TYPE_RGB_ALPHA:
00119             greyscale = <font class="keyword">false</font>;
00120             has_alpha = <font class="keyword">true</font>;
00121             <font class="keywordflow">break</font>;
00122         <font class="keywordflow">case</font> PNG_COLOR_TYPE_GRAY:
00123             greyscale = <font class="keyword">true</font>;
00124             has_alpha = <font class="keyword">false</font>;
00125             <font class="keywordflow">break</font>;
00126         <font class="keywordflow">case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
00127             greyscale = <font class="keyword">true</font>;
00128             has_alpha = <font class="keyword">true</font>;
00129             <font class="keywordflow">break</font>;
00130         }
00131 
00132         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> rowspan = png_get_rowbytes( png_ptr, info_ptr );
00133 
00134         <font class="comment">// Allocate the right amount of memory for image</font>
00135         output-&gt;<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka3">allocate</a>( height * rowspan );
00136         <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> *buffer = const_cast&lt; unsigned char * &gt;( output-&gt;<a class="code" href="classOgre_1_1DataChunk.html#Ogre_1_1SDDataChunka6">getPtr</a>() );
00137 
00138         <font class="comment">// Create array of row pointers for PNG lib</font>
00139         <font class="comment">// (This allows it to deal with interlaced images)</font>
00140         png_bytep* rowPtr = <font class="keyword">new</font> png_bytep[height];
00141         <font class="keywordflow">for</font>( <font class="keywordtype">unsigned</font> i = 0; i &lt; height; i++ )
00142             rowPtr[i] = (png_bytep)&amp;( buffer[i*rowspan] );
00143 
00144         <font class="comment">// Read the whole image</font>
00145         png_read_image( png_ptr, rowPtr );
00146 
00147         <font class="keyword">delete</font>[] rowPtr;
00148 
00149         <font class="comment">// Clean up</font>
00150         png_read_end( png_ptr, end_info );
00151         png_destroy_read_struct(
00152             &amp;png_ptr, 
00153             &amp;info_ptr,
00154             &amp;end_info);
00155 
00156         ImageData * ret_data = <font class="keyword">new</font> ImageData;
00157 
00158         ret_data-&gt;ulHeight = height;
00159         ret_data-&gt;ulWidth = width;
00160 
00161         <a class="code" href="namespaceOgre.html#a292">uchar</a> ucBpp = 0;
00162         <font class="keywordflow">if</font>( has_alpha )
00163             ucBpp += 8;
00164         <font class="keywordflow">if</font>( greyscale )
00165             ucBpp += 8;
00166         <font class="keywordflow">else</font>
00167             ucBpp += 24;
00168 
00169         ret_data-&gt;eFormat = Image::BPP2PF( ucBpp );
00170 
00171         <a class="code" href="OgreException_8h.html#a3">OgreUnguardRet</a>( ret_data );
00172     }
00173 
00174 }
</pre></div><p>
Copyright &copy; 2002 by The OGRE Team<br />
<script type="text/javascript">
<!--//hide script from old browsers
document.write( "Last modified "+ document.lastModified );
//end hiding contents -->
</script>
</p>
</body>
</html>
